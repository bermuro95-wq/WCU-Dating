<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WCU Dating - Connect with Fellow Students</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    
    
    
    
    
   
    
    
    
<style>
        
        
        
:root {
  --primary-color: #2563EB;       /* Professional Royal Blue */
  --primary-light: #60A5FA;      /* Soft Sky Blue */
  --primary-dark: #1E40AF;       /* Deep Blue */

  --accent-color: pink;       /* Modern Coral Pink (romance hint) */
  --secondary-color: #10B981;    /* Emerald Green for freshness */

  --background-color: #F9FAFB;   /* Clean Light Gray background */
  --card-color: #FFFFFF;         /* White cards/sections */
  --text-color: #111827;         /* Professional Dark Gray text */
  --muted-text: #6B7280;         /* Muted gray for less important text */

  --success-color: #22C55E;      /* Success Green */
  --warning-color: #FACC15;      /* Gold/Amber */
  --error-color: #EF4444;        /* Alert Red */
}

       


         
        

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* Header Styles */
        header {
            background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
            color: var(--text-light);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: #ff4081;
            font-size: 1.8rem;
        }

        .logo h1 {
            font-size: 1.5rem;
        }

        /* Navigation */
        nav ul {
            display: flex;
            list-style: none;
            gap: 1.5rem;
        }

        nav a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        nav a:hover, nav a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Main Content */
        main {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            min-height: calc(100vh - 200px);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Section */
        .hero {
            text-align: center;
            padding: 3rem 1rem;
            background: linear-gradient(rgba(106, 27, 154, 0.9), rgba(106, 27, 154, 0.8)), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%236a1b9a"/><text x="50%" y="50%" font-size="20" text-anchor="middle" fill="%23ffffff" font-family="Arial">WCU</text></svg>');
            background-size: cover;
            border-radius: var(--border-radius);
            color: var(--text-light);
            margin-bottom: 2rem;
        }

        .hero h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            color: white;
        }

        .cta-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

    
/* Form Styles */
.form-container {
  max-width: 600px;
  margin: 0 auto;
  background: white;
  padding: 2rem;
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
}

.form-title {
  text-align: center;
  color: var(--primary-color);
  margin-bottom: 1.5rem;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #ddd;
  border-radius: var(--border-radius);
  font-size: 1rem;
  transition: var(--transition);
}

.form-control:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(106, 27, 154, 0.2);
}

textarea.form-control {
  min-height: 100px;
  resize: vertical;
}

/* Button Styles */
.btn {
  display: inline-block;
  padding: 0.75rem 1.5rem;
  background-color: var(--primary-color);
  color: white;
  border: none;
  border-radius: var(--border-radius);
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  text-align: center;
  text-decoration: none;
}

.btn:hover {
  background-color: var(--primary-dark);
  transform: translateY(-2px);
}

.btn-outline {
  background-color: transparent;
  border: 2px solid var(--primary-color);
  color: var(--primary-color);
}

.btn-outline:hover {
  background-color: var(--primary-color);
  color: white;
}

.btn-sm {
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
}

/* Dashboard */
.dashboard-header {
  display: flex;
  align-items: center;
  gap: 1.5rem;
  margin-bottom: 2rem;
  padding: 1.5rem;
  background: white;
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
}

.profile-img {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid var(--primary-color);
}

.dashboard-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1.5rem;
}

.card {
  background: white;
  border-radius: var(--border-radius);
  overflow: hidden;
  box-shadow: var(--shadow);
  transition: var(--transition);
  cursor: pointer;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

.card-img {
  height: 160px;
  background-color: var(--primary-light);
  display: flex;
  align-items: center;
  justify-content: center;
}

.card-img i {
  font-size: 4rem;
  color: white;
}

.card-content {
  padding: 1.5rem;
}

.card-title {
  color: var(--primary-color);
  margin-bottom: 0.5rem;
}

/* Browse Students */
.filters {
  background: white;
  padding: 1.5rem;
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  margin-bottom: 2rem;
  position: relative;
}
    
.filter-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.filter-toggle {
  display: none;
  background: var(--primary-light);
  color: white;
  border: none;
  border-radius: var(--border-radius);
  padding: 0.5rem 1rem;
  cursor: pointer;
}

.filter-content {
  display: block;
}

.filter-row {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}

.filter-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 1rem;
}

.filter-tag {
  background-color: var(--primary-light);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.filter-tag button {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  font-size: 1rem;
}

.student-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1.5rem;
}

.student-card {
  background: white;
  border-radius: var(--border-radius);
  overflow: hidden;
  box-shadow: var(--shadow);
  transition: var(--transition);
  position: relative;
}

.student-card:hover {
  transform: translateY(-5px);
}

.student-img {
  height: 200px;
  background-color: var(--accent-color);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.student-img i {
  font-size: 5rem;
  color: var(--primary-color);
}

.student-online {
  position: absolute;
  bottom: 10px;
  right: 10px;
  width: 12px;
  height: 12px;
  background-color: var(--success-color);
  border-radius: 50%;
  border: 2px solid white;
}

.student-info {
  padding: 1.5rem;
}

.student-name {
  color: var(--primary-color);
  margin-bottom: 0.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.student-details {
  color: #666;
  margin-bottom: 1rem;
  font-size: 0.9rem;
}

.student-interests {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.interest-tag {
  background-color: var(--accent-color);
  color: var(--primary-dark);
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.75rem;
}




/* ===== FACEBOOK-STYLE MESSAGES LAYOUT ===== */
.messages-container {
  display: flex;
  height: 70vh;
  min-height: 500px;
  max-height: 700px;
  background: #f0f2f5;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.conversations-list {
  width: 350px;
  background: white;
  border-right: 1px solid #e4e6eb;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.conversations-header {
  padding: 16px;
  border-bottom: 1px solid #e4e6eb;
  background: white;
}

.conversations-header h3 {
  margin: 0;
  color: #1c1e21;
  font-size: 1.5rem;
}

.conversations-scroll {
  flex: 1;
  overflow-y: auto;
}

.conversation {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  transition: background-color 0.2s;
}
    
    
    
.conversation:hover {
  background-color: #f5f5f5;
}

.conversation.active {
  background-color: #e6f2ff;
}

.conversation-img {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background-color: #e4e6eb;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 12px;
  position: relative;
}

.conversation-img i {
  font-size: 1.5rem;
  color: #65676b;
}

.conversation-info {
  flex: 1;
  min-width: 0;
}

.conversation-name {
  font-weight: 600;
  font-size: 15px;
  color: #1c1e21;
  margin-bottom: 4px;
}

.conversation-preview {
  font-size: 13px;
  color: #65676b;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
}

.conversation-time {
  font-size: 12px;
  color: #65676b;
}

.chat-window {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: white;
}

.chat-header {
  padding: 16px;
  border-bottom: 1px solid #e4e6eb;
  background: white;
  display: flex;
  align-items: center;
  gap: 12px;
}

.chat-user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: #e4e6eb;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-user-avatar i {
  color: #65676b;
}

.chat-user-info {
  flex: 1;
}

.chat-user-name {
  font-weight: 600;
  color: #1c1e21;
}

.chat-user-status {
  font-size: 13px;
  color: #65676b;
}

.chat-messages {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  background: #f0f2f5;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.message {
  max-width: 65%;
  padding: 8px 12px;
  border-radius: 18px;
  word-wrap: break-word;
  position: relative;
}

.message.received {
  background: white;
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}

.message.sent {
  background: #0084ff;
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.message-time {
  font-size: 11px;
  margin-top: 4px;
  opacity: 0.7;
  text-align: right;
}

.chat-input-container {
  padding: 16px;
  background: white;
  border-top: 1px solid #e4e6eb;
}

.chat-input {
  display: flex;
  gap: 8px;
  align-items: center;
}

.chat-input input {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid #e4e6eb;
  border-radius: 20px;
  font-size: 15px;
  background: #f0f2f5;
  outline: none;
}

.chat-input input:focus {
  border-color: #0084ff;
}

.chat-input button {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #0084ff;
  color: white;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.2s;
}

.chat-input button:hover {
  background: #0073e6;
}

.chat-input button i {
  font-size: 16px;
}

/* Empty States */
.empty-chat-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #65676b;
  text-align: center;
  padding: 2rem;
}

.empty-chat-state i {
  font-size: 4rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-conversations {
  text-align: center;
  padding: 2rem;
  color: #65676b;
}

.empty-conversations i {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .messages-container {
    flex-direction: column;
    height: 80vh;
  }
  
  .conversations-list {
    width: 100%;
    height: 40%;
    border-right: none;
    border-bottom: 1px solid #e4e6eb;
  }
  
  .chat-window {
    height: 100%;
  }
  
  .message {
    max-width: 80%;
  }
}





.message {
  max-width: 70%;
  padding: 0.75rem;
  border-radius: var(--border-radius);
  position: relative;
}

.message.received {
  background-color: #f0f0f0;
  align-self: flex-start;
}

.message.sent {
  background-color: var(--primary-light);
  color: white;
  align-self: flex-end;
}

.message-time {
  font-size: 0.75rem;
  margin-top: 0.5rem;
  opacity: 0.7;
  text-align: right;
}
    
    
.chat-input {
  display: flex;
  padding: 1rem;
  border-top: 1px solid #eee;
}

.chat-input input {
  flex: 1;
  padding: 0.75rem;
  border: 1px solid #ddd;
  border-radius: var(--border-radius) 0 0 var(--border-radius);
  border-right: none;
}

.chat-input button {
  border-radius: 0 var(--border-radius) var(--border-radius) 0;
}

/* Profile Section */
.profile-view {
  background: white;
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  overflow: hidden;
  margin-bottom: 2rem;
}

.profile-header {
  position: relative;
  height: 200px;
  background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding-bottom: 2rem;
}

.profile-avatar {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  border: 4px solid white;
  background-color: var(--accent-color);
  display: flex;
  align-items: center;
  justify-content: center;
  position: absolute;
  bottom: -75px;
}

.profile-avatar i {
  font-size: 4rem;
  color: var(--primary-color);
}

.profile-body {
  margin-top: 80px;
  padding: 2rem;
}

.profile-name {
  text-align: center;
  color: var(--primary-color);
  margin-bottom: 0.5rem;
}

.profile-details {
  text-align: center;
  color: #666;
  margin-bottom: 2rem;
}

.profile-section {
  margin-bottom: 2rem;
}

.profile-section-title {
  color: var(--primary-color);
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #eee;
}

.profile-info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1rem;
}

.profile-info-item {
  margin-bottom: 1rem;
}

.profile-info-label {
  font-weight: 500;
  color: #666;
  margin-bottom: 0.25rem;
}

/* Footer */
footer {
  background: var(--primary-dark);
  color: var(--text-light);
  padding: 2rem 1rem;
  text-align: center;
}

.footer-content {
  max-width: 1200px;
  margin: 0 auto;
}

/* Notification */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: var(--border-radius);
  color: white;
  z-index: 1000;
  opacity: 0;
  transform: translateY(-20px);
  transition: opacity 0.3s, transform 0.3s;
  max-width: 350px;
  box-shadow: var(--shadow);
}

.notification.show {
  opacity: 1;
  transform: translateY(0);
}

.notification.success {
  background-color: var(--success-color);
}

.notification.error {
  background-color: var(--error-color);
}

.notification.warning {
  background-color: var(--warning-color);
}

/* Loading Spinner */
.spinner {
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-left: 4px solid var(--primary-color);
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}
    
    
    
@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #666;
        }

        .empty-state i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            nav ul {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background-color: var(--primary-color);
                padding: 1rem;
                box-shadow: var(--shadow);
            }

            nav ul.show {
                display: flex;
            }

            .menu-toggle {
                display: block;
            }

            .dashboard-header {
                flex-direction: column;
                text-align: center;
            }

            .messages-container {
                grid-template-columns: 1fr;
                grid-template-rows: 200px 1fr;
            }

            .cta-buttons {
                flex-direction: column;
            }

            .filter-toggle {
                display: block;
            }

            .filter-content {
                display: none;
                margin-top: 1rem;
            }

            .filter-content.show {
                display: block;
            }

            .filter-row {
                grid-template-columns: 1fr;
            }

            .profile-header {
                height: 150px;
            }

            .profile-avatar {
                width: 120px;
                height: 120px;
                bottom: -60px;
            }

            .profile-avatar i {
                font-size: 3rem;
            }

            .profile-body {
                margin-top: 70px;
                padding: 1.5rem;
            }
        }

        /* Animation for new messages */
        @keyframes highlight {
            0% { background-color: rgba(106, 27, 154, 0.1); }
            100% { background-color: transparent; }
        }

        .highlight {
            animation: highlight 2s ease;
        }
        
        
/* Enhanced notification styles */
.notification {
    max-width: 400px;
    padding: 15px;
    margin-bottom: 10px;
}

.notification i {
    font-size: 1.5rem;
}

.notification p {
    margin: 5px 0 0 0;
    font-size: 0.9rem;
    opacity: 0.9;
}
        
        
        
        
        
        
        
    </style>
    
    
    
    
    
    
    
    
    
    
    
    
</head>
<body>
    <!-- Header with Navigation -->
    <header>
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-heart"></i>
                <h1>WCU Dating</h1>
            </div>
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <nav>
                <ul id="navMenu">
                    <li><a href="#home" class="nav-link active" data-section="home">Home</a></li>
                    <li><a href="#login" class="nav-link" data-section="login" id="loginNav">Login</a></li>
                    <li><a href="#signup" class="nav-link" data-section="signup" id="signupNav">Sign Up</a></li>
                    <li><a href="#dashboard" class="nav-link" data-section="dashboard" id="dashboardNav" style="display:none;">Dashboard</a></li>
                    <li><a href="#browse" class="nav-link" data-section="browse" id="browseNav" style="display:none;">Browse</a></li>
                    <li><a href="#messages" class="nav-link" data-section="messages" id="messagesNav" style="display:none;">Messages</a></li>
                    <li><a href="#profile" class="nav-link" data-section="profile" id="profileNav" style="display:none;">Profile</a></li>
                    <li><a href="#about" class="nav-link" data-section="about">About Us</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <!-- Main Content -->
    <main>
        <!-- Home Section -->
        <section id="home" class="section active">
            <div class="hero">
                <h2>Only for WCU Students <i class="fas fa-heart"></i></h2>
                <p>Connect with fellow Wachemo University students, make friends, and build meaningful relationships in a safe and secure environment.</p>
                <div class="cta-buttons">
                    <a href="#login" class="btn" data-section="login">Login</a>
                    <a href="#signup" class="btn btn-outline" data-section="signup">Sign Up</a>
                </div>
            </div>
            
            <div class="features">
                <h2 style="text-align: center; margin-bottom: 2rem; color: var(--primary-color);">How It Works</h2>
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-img">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Create Profile</h3>
                            <p>Sign up with your WCU student details and create your dating profile.</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-img">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Browse Students</h3>
                            <p>Find other WCU students based on department, interests, and more.</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-img">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Connect & Chat</h3>
                            <p>Start conversations and build meaningful connections.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Login Section -->
        <section id="login" class="section">
            <div class="form-container">
                <h2 class="form-title">Login to Your Account</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">
                        <span id="loginBtnText">Login</span>
                        <div id="loginSpinner" class="spinner" style="display: none;"></div>
                    </button>
                </form>
                <p style="text-align: center; margin-top: 1.5rem;">
                    Don't have an account? <a href="#signup" class="nav-link" data-section="signup" style="color: var(--primary-color);">Sign Up now</a>
                </p>
            </div>
        </section>

        <!-- Sign Up Section -->
        <section id="signup" class="section">
            <div class="form-container">
                <h2 class="form-title">Create Your WCU Dating Profile</h2>
                <form id="signupForm">
                    <div class="form-group">
                        <label for="fullName">Full Name</label>
                        <input type="text" id="fullName" class="form-control" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="studentId">Student ID</label>
                        <input type="text" id="studentId" class="form-control" placeholder="Enter your WCU student ID" required>
                    </div>
                    <div class="form-group">
                        <label for="department">Department / Faculty</label>
                        <select id="department" class="form-control" required>
                            <option value="">Select Department</option>
                            <option value="Civil Engineering">Civil Engineering</option>
                            <option value="Hydraulic and Water Resource Engineering">Hydraulic and Water Resource Engineering</option>
                            <option value="Architecture">Architecture</option>
                            <option value="Chemical Engineering">Chemical Engineering</option>
                            <option value="Construction Technology and Management">Construction Technology and Management</option>
                            <option value="Electrical and Computer Engineering">Electrical and Computer Engineering</option>
                            <option value="Electro-Mechanical Engineering">Electro-Mechanical Engineering</option>
                            <option value="Surveying Engineering">Surveying Engineering</option>
                            <option value="Information Systems">Information Systems</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Mechanical Engineering">Mechanical Engineering</option>
                            <option value="Software Engineering">Software Engineering</option>
                            <option value="Biomedical Engineering">Biomedical Engineering</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Statistics">Statistics</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                            <option value="Biotechnology">Biotechnology</option>
                            <option value="Geology">Geology</option>
                            <option value="Sport Science">Sport Science</option>
                            <option value="Industrial Chemistry">Industrial Chemistry</option>
                            <option value="Medicine">Medicine</option>
                            <option value="Anesthesia">Anesthesia</option>
                            <option value="Midwifery">Midwifery</option>
                            <option value="Comprehensive Nursing">Comprehensive Nursing</option>
                            <option value="Public Health">Public Health</option>
                            <option value="Health Informatics">Health Informatics</option>
                            <option value="Medical Laboratory Technology">Medical Laboratory Technology</option>
                            <option value="Pharmacy">Pharmacy</option>
                            <option value="Surgical Nursing (Post Basic)">Surgical Nursing (Post Basic)</option>
                            <option value="Pediatrics & Child Health Nursing (Post Basic)">Pediatrics & Child Health Nursing (Post Basic)</option>
                            <option value="Dental Medicine">Dental Medicine</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="year">Year of Study</label>
                        <select id="year" class="form-control" required>
                            <option value="">Select Year</option>
                            <option value="Remedial">Remedial</option>
                            <option value="1st">1st Year</option>
                            <option value="2nd">2nd Year</option>
                            <option value="3rd">3rd Year</option>
                            <option value="4th">4th Year</option>
                            <option value="5th">5th Year</option>
                            <option value="6th">6th Year</option>
                            <option value="7th">7th Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <select id="gender" class="form-control" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lookingFor">Looking For</label>
                        <select id="lookingFor" class="form-control" required>
                            <option value="">Select What You're Looking For</option>
                            <option value="Friendship">Friendship</option>
                            <option value="Relationship">Relationship</option>
                            <option value="Study Partner">Study Partner</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="maritalStatus">Marital Status</label>
                        <select id="maritalStatus" class="form-control" required>
                            <option value="">Select Marital Status</option>
                            <option value="Single">Single</option>
                            <option value="Married">Married</option>
                            <option value="Divorced">Divorced</option>
                            <option value="Widowed">Widowed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="relationshipExp">Past Relationship Experience</label>
                        <select id="relationshipExp" class="form-control" required>
                            <option value="">Select Experience</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="religion">Religion</label>
                        <select id="religion" class="form-control" required>
                            <option value="">Select Religion</option>
                            <option value="Ethiopian Orthodox">Ethiopian Orthodox</option>
                            <option value="Protestant">Protestant</option>
                            <option value="Catholic">Catholic</option>
                            <option value="Islam">Islam</option>
                            <option value="Judaism">Judaism</option>
                            <option value="Traditional/Indigenous">Traditional/Indigenous</option>
                            <option value="Other">Other</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="personality">Personality Type</label>
                        <select id="personality" class="form-control" required>
                            <option value="">Select Personality Type</option>
                            <option value="Introvert">Introvert</option>
                            <option value="Extrovert">Extrovert</option>
                            <option value="Ambivert">Ambivert</option>
                            <option value="Not sure">Not sure</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="interests">Interests (comma separated)</label>
                        <input type="text" id="interests" class="form-control" placeholder="e.g., Reading, Sports, Music">
                    </div>
                    <div class="form-group">
                        <label for="bio">About Me / Bio</label>
                        <textarea id="bio" class="form-control" placeholder="Tell others about yourself..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="profilePhoto">Profile Photo</label>
                        <input type="file" id="profilePhoto" class="form-control" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-control" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="tel" id="phone" class="form-control" placeholder="Enter your phone number">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" class="form-control" placeholder="Create a password" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm your password" required>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">
                        <span id="signupBtnText">Register</span>
                        <div id="signupSpinner" class="spinner" style="display: none;"></div>
                    </button>
                </form>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard" class="section">
            <div class="dashboard-header">
                <div class="profile-img-container">
                    <img id="dashboardProfileImg" class="profile-img" src="" alt="Profile Image" onerror="this.style.display='none';">
                    <div id="dashboardProfilePlaceholder" class="profile-img" style="background-color: #e1bee7; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user" style="font-size: 2.5rem; color: var(--primary-color);"></i>
                    </div>
                </div>
                <div>
                    <h2 id="dashboardWelcome">Welcome, Student!</h2>
                    <p id="dashboardDetails">Department, Year</p>
                    <p id="dashboardBio">"Bio will appear here."</p>
                </div>
            </div>

            <div class="dashboard-cards">
                <div class="card nav-link" data-section="browse">
                    <div class="card-img">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">Browse Students</h3>
                        <p>Find other WCU students to connect with</p>
                    </div>
                </div>
                <div class="card nav-link" data-section="messages">
                    <div class="card-img">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">Messages</h3>
                        <p>Check your conversations</p>
                    </div>
                </div>
                <div class="card nav-link" data-section="profile">
                    <div class="card-img">
                        <i class="fas fa-user-edit"></i>
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">My Profile</h3>
                        <p>View and edit your profile</p>
                    </div>
                </div>
                <div class="card nav-link" data-section="home" id="logoutBtn">
                    <div class="card-img">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">Logout</h3>
                        <p>Sign out of your account</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Browse Students Section -->
        <section id="browse" class="section">
            <h2 style="margin-bottom: 1.5rem; color: var(--primary-color);">Browse WCU Students</h2>
            
            <div class="filters">
                <div class="filter-header">
                    <h3>Filters</h3>
                    <button class="filter-toggle" id="filterToggle">
                        <i class="fas fa-filter"></i> Filters
                    </button>
                </div>
                
                
<div class="filter-content" id="filterContent">
    <div class="filter-row">
        <div class="form-group">
            <label for="filterDepartment">Department</label>
            <select id="filterDepartment" class="form-control">
                <option value="">All Departments</option>
                <option value="Civil Engineering">Civil Engineering</option>
                <option value="Hydraulic and Water Resource Engineering">Hydraulic and Water Resource Engineering</option>
                <option value="Architecture">Architecture</option>
                <option value="Chemical Engineering">Chemical Engineering</option>
                <option value="Construction Technology and Management">Construction Technology and Management</option>
                <option value="Electrical and Computer Engineering">Electrical and Computer Engineering</option>
                <option value="Electro-Mechanical Engineering">Electro-Mechanical Engineering</option>
                <option value="Surveying Engineering">Surveying Engineering</option>
                <option value="Information Systems">Information Systems</option>
                <option value="Information Technology">Information Technology</option>
                <option value="Mechanical Engineering">Mechanical Engineering</option>
                <option value="Software Engineering">Software Engineering</option>
                <option value="Biomedical Engineering">Biomedical Engineering</option>
                <option value="Mathematics">Mathematics</option>
                <option value="Statistics">Statistics</option>
                <option value="Physics">Physics</option>
                <option value="Chemistry">Chemistry</option>
                <option value="Biology">Biology</option>
                <option value="Biotechnology">Biotechnology</option>
                <option value="Geology">Geology</option>
                <option value="Sport Science">Sport Science</option>
                <option value="Industrial Chemistry">Industrial Chemistry</option>
                <option value="Medicine">Medicine</option>
                <option value="Anesthesia">Anesthesia</option>
                <option value="Midwifery">Midwifery</option>
                <option value="Comprehensive Nursing">Comprehensive Nursing</option>
                <option value="Public Health">Public Health</option>
                <option value="Health Informatics">Health Informatics</option>
                <option value="Medical Laboratory Technology">Medical Laboratory Technology</option>
                <option value="Pharmacy">Pharmacy</option>
                <option value="Surgical Nursing (Post Basic)">Surgical Nursing (Post Basic)</option>
                <option value="Pediatrics & Child Health Nursing (Post Basic)">Pediatrics & Child Health Nursing (Post Basic)</option>
                <option value="Dental Medicine">Dental Medicine</option>
            </select>
        </div>
        <div class="form-group">
            <label for="filterYear">Year</label>
            <select id="filterYear" class="form-control">
                <option value="">All Years</option>
                <option value="Remedial">Remedial</option>
                <option value="1st">1st Year</option>
                <option value="2nd">2nd Year</option>
                <option value="3rd">3rd Year</option>
                <option value="4th">4th Year</option>
                <option value="5th">5th Year</option>
                <option value="6th">6th Year</option>
                <option value="7th">7th Year</option>
            </select>
        </div>
    </div>
    <button type="button" class="btn" id="applyFilters">Apply Filters</button>
    <button type="button" class="btn btn-outline" id="clearFilters" style="margin-left: 10px;">Clear Filters</button>
</div>
                
                

                <div class="filter-tags" id="filterTags" style="display: none;">
                    <!-- Active filters will appear here -->
                </div>
            </div>

            <div id="studentsContainer" class="student-cards">
                <div class="spinner" id="browseSpinner"></div>
            </div>
        </section>

        <!-- Messages Section -->
        <section id="messages" class="section">
            <h2 style="margin-bottom: 1.5rem; color: var(--primary-color);">Messages</h2>
            
            
            
            
            
<div class="messages-container">
  <div class="conversations-list" id="conversationsList">
    <div class="spinner"></div>
  </div>
  
  <div class="chat-window">
    <div class="chat-header" id="chatHeader">
      <div class="chat-user-info">
        <span>Select a conversation</span>
        <span class="chat-user-status"></span>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="empty-chat-state">
        <i class="fas fa-comments"></i>
        <p>Select a conversation to start messaging</p>
      </div>
    </div>
    <div class="chat-input" style="display: none;" id="chatInput">
      <input type="text" id="messageInput" placeholder="Type your message here...">
      <button class="btn" id="sendMessageBtn">Send</button>
    </div>
  </div>
</div>
            
            
            
            
            
            
            
            
        </section>

        <!-- Profile Section -->
        <section id="profile" class="section">
            <h2 style="margin-bottom: 1.5rem; color: var(--primary-color);">My Profile</h2>
            
            <div class="form-container">
                <form id="profileForm">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <img id="profilePhotoPreview" class="profile-img" src="" alt="Profile Photo" onerror="this.style.display='none';" style="width: 150px; height: 150px; margin: 0 auto;">
                        <div id="profilePhotoPlaceholder" class="profile-img" style="width: 150px; height: 150px; margin: 0 auto; background-color: #e1bee7; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user" style="font-size: 4rem; color: var(--primary-color);"></i>
                        </div>
                        <input type="file" id="profilePhotoUpload" accept="image/*" style="display: none;">
                        <button type="button" class="btn" style="margin-top: 1rem;" id="changePhotoBtn">Change Photo</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="profileName">Full Name</label>
                        <input type="text" id="profileName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="profileStudentId">Student ID</label>
                        <input type="text" id="profileStudentId" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="profileDepartment">Department / Faculty</label>
                        <select id="profileDepartment" class="form-control">
                            <option value="">Select Department</option>
                            <option value="Civil Engineering">Civil Engineering</option>
                            <option value="Hydraulic and Water Resource Engineering">Hydraulic and Water Resource Engineering</option>
                            <option value="Architecture">Architecture</option>
                            <option value="Chemical Engineering">Chemical Engineering</option>
                            <option value="Construction Technology and Management">Construction Technology and Management</option>
                            <option value="Electrical and Computer Engineering">Electrical and Computer Engineering</option>
                            <option value="Electro-Mechanical Engineering">Electro-Mechanical Engineering</option>
                            <option value="Surveying Engineering">Surveying Engineering</option>
                            <option value="Information Systems">Information Systems</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Mechanical Engineering">Mechanical Engineering</option>
                            <option value="Software Engineering">Software Engineering</option>
                            <option value="Biomedical Engineering">Biomedical Engineering</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Statistics">Statistics</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                            <option value="Biotechnology">Biotechnology</option>
                            <option value="Geology">Geology</option>
                            <option value="Sport Science">Sport Science</option>
                            <option value="Industrial Chemistry">Industrial Chemistry</option>
                            <option value="Medicine">Medicine</option>
                            <option value="Anesthesia">Anesthesia</option>
                            <option value="Midwifery">Midwifery</option>
                            <option value="Comprehensive Nursing">Comprehensive Nursing</option>
                            <option value="Public Health">Public Health</option>
                            <option value="Health Informatics">Health Informatics</option>
                            <option value="Medical Laboratory Technology">Medical Laboratory Technology</option>
                            <option value="Pharmacy">Pharmacy</option>
                            <option value="Surgical Nursing (Post Basic)">Surgical Nursing (Post Basic)</option>
                            <option value="Pediatrics & Child Health Nursing (Post Basic)">Pediatrics & Child Health Nursing (Post Basic)</option>
                            <option value="Dental Medicine">Dental Medicine</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="profileYear">Year of Study</label>
                        <select id="profileYear" class="form-control">
                            <option value="">Select Year</option>
                            <option value="Remedial">Remedial</option>
                            <option value="1st">1st Year</option>
                            <option value="2nd">2nd Year</option>
                            <option value="3rd">3rd Year</option>
                            <option value="4th">4th Year</option>
                            <option value="5th">5th Year</option>
                            <option value="6th">6th Year</option>
                            <option value="7th">7th Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="profileInterests">Interests (comma separated)</label>
                        <input type="text" id="profileInterests" class="form-control" placeholder="e.g., Reading, Sports, Music">
                    </div>
                    <div class="form-group">
                        <label for="profileBio">About Me / Bio</label>
                        <textarea id="profileBio" class="form-control"></textarea>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">
                        <span id="updateProfileBtnText">Update Profile</span>
                        <div id="updateProfileSpinner" class="spinner" style="display: none;"></div>
                    </button>
                </form>
            </div>
        </section>







<!-- About Us Section -->
<section id="about" class="section">
    <div class="form-container">
        <h2 class="form-title">About WCU Dating</h2>
        <p style="text-align: center; margin-bottom: 2rem;">
            This site is specially built for WCU students to connect, make friends, and build meaningful relationships.
        </p>
        
        <div style="background-color: #f9f9f9; padding: 1.5rem; border-radius: var(--border-radius);">
            <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Developer Information</h3>
            <p><strong>Developed by:</strong> Yoseph Abebe Ersedo</p>
            <p><strong>University:</strong> Wachemo University</p>
            <p><strong>Department:</strong> Information Systems</p>
            <p><strong>Year:</strong> 2025</p>
            <p><strong>Email:</strong> jossyabebe92@gmail.com</p>
        </div>
        
        <div style="margin-top: 2rem;">
            <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Contact Us</h3>
            <p>Have questions or concerns? Feel free to reach out to us:</p>
            <p><strong>Phone:</strong> 09-17-33-21-99</p>
            <p><strong>Email:</strong> <a href="mailto:jossyabebe92@gmail.com" style="color: var(--primary-color);">jossyabebe92@gmail.com</a></p>
        </div>
        
        <div style="margin-top: 2rem;">
            <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Mission</h3>
            <p>Our mission is to provide a safe and secure platform for Wachemo University students to connect with each other, form study groups, make new friends, and build meaningful relationships within the university community.</p>
            
            <h3 style="color: var(--primary-color); margin-bottom: 1rem; margin-top: 1.5rem;">Privacy & Safety</h3>
            <p>We prioritize your privacy and safety. All profiles are verified through WCU student IDs, and we have strict guidelines against inappropriate behavior. Your personal information is never shared with third parties.</p>
        </div>
    </div>
</section>









        
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Wachemo University Dating Site. All rights reserved.</p>
            <p>For WCU students only. Verification required.</p>
        </div>
    </footer>

    <script>
        // Firebase configuration - Replace with your own config
        const firebaseConfig = {
            apiKey: "AIzaSyB59sLUXNafCd7AHhT1-t9ex7ow9fRr4rQ",
            authDomain: "wcu-dating-5decd.firebaseapp.com",
            projectId: "wcu-dating-5decd",
            storageBucket: "wcu-dating-5decd.firebasestorage.app",
            messagingSenderId: "240008579483",
            appId: "1:240008579483:web:ec969a34a8b41b22c3393e",
            measurementId: "G-T4EHB92656"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Current user data
        let currentUser = null;
        let userProfile = null;
        let unsubscribeChat = null;
        let activeFilters = {};

        // Navigation functionality
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');
        const menuToggle = document.getElementById('menuToggle');
        const navMenu = document.getElementById('navMenu');
        
        // Handle navigation clicks
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const sectionId = this.getAttribute('data-section');
                showSection(sectionId);
                updateActiveNav(this);
                
                // Close mobile menu after selection
                if (window.innerWidth <= 768) {
                    navMenu.classList.remove('show');
                }
            });
        });
        
        // Mobile menu toggle
        menuToggle.addEventListener('click', function() {
            navMenu.classList.toggle('show');
        });
        
        // Show the specified section and hide others
        function showSection(sectionId) {
            // Clean up any real-time listeners when leaving messages
            if (unsubscribeChat && !sectionId.includes('messages')) {
                unsubscribeChat();
                unsubscribeChat = null;
            }
            
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // Load section-specific data
            if (sectionId === 'dashboard' && currentUser) {
                loadDashboard();
            } else if (sectionId === 'browse' && currentUser) {
                loadStudents();
            } else if (sectionId === 'profile' && currentUser) {
                loadProfile();
            } else if (sectionId === 'messages' && currentUser) {
                loadConversations();
            }
        }
        
        // Update active navigation link
        
// Update active navigation link
function updateActiveNav(activeLink) {
    navLinks.forEach(link => {
        link.classList.remove('active');
    });
    activeLink.classList.add('active');
}

// Add this function to load user profile from Firestore
async function loadUserProfile(uid) {
    try {
        const userDoc = await db.collection('users').doc(uid).get();
        if (userDoc.exists) {
            userProfile = userDoc.data();
            return userProfile;
        }
        return null;
    } catch (error) {
        console.error('Error loading user profile:', error);
        return null;
    }
}

// Show notification
function showNotification(message, type) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type} show`;
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}
        
        
        
        // Toggle loading state for buttons
        function toggleButtonLoading(buttonId, isLoading) {
            const btnText = document.getElementById(`${buttonId}BtnText`);
            const spinner = document.getElementById(`${buttonId}Spinner`);
            
            if (isLoading) {
                btnText.style.display = 'none';
                spinner.style.display = 'block';
            } else {
                btnText.style.display = 'block';
                spinner.style.display = 'none';
            }
        }
        
        // Handle login functionality
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Simple validation
            if (!email || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            toggleButtonLoading('login', true);
            
            try {
                // Sign in with Firebase Authentication
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Get user profile from Firestore
                


           
// Get user profile using the new function
userProfile = await loadUserProfile(currentUser.uid);

if (userProfile) {
    showNotification('Login successful!', 'success');
    
    // Update user online status
    await db.collection('users').doc(currentUser.uid).update({
        isOnline: true,
        lastSeen: new Date()
    });
    
setupMessageListeners();
    
    // Update navigation
    updateNavigation(true);
    
    // Show dashboard
    showSection('dashboard');
    updateActiveNav(document.querySelector('[data-section="dashboard"]'));
} else {
    // If profile doesn't exist, create a basic one
    showNotification('Creating your profile...', 'warning');
    
    const userProfileData = {
        uid: currentUser.uid,
        email: currentUser.email,
        fullName: currentUser.displayName || "New User",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        isOnline: true,
        lastSeen: new Date()
    };
    
    await db.collection('users').doc(currentUser.uid).set(userProfileData);
    userProfile = userProfileData;
    
    showNotification('Profile created successfully!', 'success');
    
    // Update navigation
    updateNavigation(true);
    
    // Show dashboard
    showSection('dashboard');
    updateActiveNav(document.querySelector('[data-section="dashboard"]'));
}
           
                
                
                
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification(error.message, 'error');
            } finally {
                toggleButtonLoading('login', false);
            }
        });
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
// Handle signup functionality - FIXED VERSION
document.getElementById('signupForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  // Get form values
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const fullName = document.getElementById('fullName').value;
  const studentId = document.getElementById('studentId').value;
  const department = document.getElementById('department').value;
  const year = document.getElementById('year').value;
  const gender = document.getElementById('gender').value;
  const lookingFor = document.getElementById('lookingFor').value;
  const maritalStatus = document.getElementById('maritalStatus').value;
  const relationshipExp = document.getElementById('relationshipExp').value;
  const religion = document.getElementById('religion').value;
  const personality = document.getElementById('personality').value;
  const interests = document.getElementById('interests').value;
  const bio = document.getElementById('bio').value;
  const phone = document.getElementById('phone').value;
  const profilePhoto = document.getElementById('profilePhoto').files[0];
  
  // Validation
  if (password !== confirmPassword) {
    showNotification('Passwords do not match', 'error');
    return;
  }
  
  toggleButtonLoading('signup', true);
  
  try {
    // Create user with Firebase Authentication
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    currentUser = userCredential.user;
    
    let photoURL = null;
    // Upload profile photo if selected
    if (profilePhoto) {
      try {
        const storageRef = storage.ref();
        const photoRef = storageRef.child(`profile_photos/${currentUser.uid}`);
        await photoRef.put(profilePhoto);
        photoURL = await photoRef.getDownloadURL();
      } catch (photoError) {
        console.error('Profile photo upload failed:', photoError);
        // Continue without photo
      }
    }
    
    // Create user profile in Firestore
    const userProfileData = {
      uid: currentUser.uid,
      email: email,
      fullName: fullName,
      studentId: studentId,
      department: department,
      year: year,
      gender: gender,
      lookingFor: lookingFor,
      maritalStatus: maritalStatus,
      relationshipExp: relationshipExp,
      religion: religion,
      personality: personality,
      interests: interests.split(',').map(item => item.trim()).filter(item => item !== ''),
      bio: bio,
      phone: phone || '',
      photoURL: photoURL,
      isOnline: true,
      lastSeen: new Date(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    // CREATE PROFILE IN FIRESTORE
    await db.collection('users').doc(currentUser.uid).set(userProfileData);
    
    // CRITICAL FIX: Set userProfile immediately and ensure it's available
    userProfile = userProfileData;
    
    showNotification('Registration successful! Loading your profile...', 'success');
    
    // Update navigation
    updateNavigation(true);
    
    // CRITICAL FIX: Wait a bit for Firestore to process, then load and redirect
    setTimeout(async () => {
      // Reload profile data from Firestore to ensure consistency
      userProfile = await loadUserProfile(currentUser.uid);
      
      if (userProfile) {
        // Redirect to profile section
        showSection('profile');
        updateActiveNav(document.querySelector('[data-section="profile"]'));
        
        // CRITICAL FIX: Force reload profile data to display immediately
        loadProfile();
        
        showNotification('Welcome! Your profile is ready.', 'success');
      } else {
        showNotification('Profile created! Loading your data...', 'warning');
        // Fallback: Use the data we already have
        loadProfile();
      }
    }, 1000);
    
  } catch (error) {
    console.error('Signup error:', error);
    showNotification(error.message, 'error');
    
    // Delete user if profile creation failed
    if (currentUser) {
      try {
        await currentUser.delete();
      } catch (deleteError) {
        console.error('Error deleting user:', deleteError);
      }
      currentUser = null;
    }
  } finally {
    toggleButtonLoading('signup', false);
  }
});

// Load user profile - ENHANCED VERSION
async function loadProfile() {
  if (!currentUser) {
    console.log('No current user for profile loading');
    return;
  }
  
  console.log('Loading profile for user:', currentUser.uid);
  
  try {
    // Always try to load fresh data from Firestore first
    const freshProfile = await loadUserProfile(currentUser.uid);
    
    if (freshProfile) {
      userProfile = freshProfile;
      console.log('Profile loaded from Firestore:', userProfile);
    } else if (userProfile) {
      console.log('Using existing userProfile data');
    } else {
      console.log('No profile data available');
      showNotification('Profile data not available', 'error');
      return;
    }
    
    // Populate form fields - WITH NULL CHECKS
    document.getElementById('profileName').value = userProfile.fullName || '';
    document.getElementById('profileStudentId').value = userProfile.studentId || '';
    document.getElementById('profileDepartment').value = userProfile.department || '';
    document.getElementById('profileYear').value = userProfile.year || '';
    document.getElementById('profileInterests').value = userProfile.interests ? userProfile.interests.join(', ') : '';
    document.getElementById('profileBio').value = userProfile.bio || '';
    
    console.log('Form populated with:', {
      name: userProfile.fullName,
      department: userProfile.department,
      year: userProfile.year
    });
    
    // Load profile image if available
    if (userProfile.photoURL) {
      console.log('Setting profile photo:', userProfile.photoURL);
      document.getElementById('profilePhotoPreview').src = userProfile.photoURL;
      document.getElementById('profilePhotoPreview').style.display = 'block';
      document.getElementById('profilePhotoPlaceholder').style.display = 'none';
    } else {
      console.log('No profile photo, using placeholder');
      document.getElementById('profilePhotoPreview').style.display = 'none';
      document.getElementById('profilePhotoPlaceholder').style.display = 'flex';
    }
    
    // Also update dashboard if it's visible
    if (typeof loadDashboard === 'function') {
      loadDashboard();
    }
    
  } catch (error) {
    console.error('Error in loadProfile:', error);
    showNotification('Error loading profile data', 'error');
  }
}

// Add this improved function to load user profile from Firestore
async function loadUserProfile(uid) {
  try {
    console.log('Loading user profile from Firestore for:', uid);
    const userDoc = await db.collection('users').doc(uid).get();
    
    if (userDoc.exists) {
      const profileData = userDoc.data();
      console.log('Profile data retrieved:', profileData);
      return profileData;
    } else {
      console.log('No profile found in Firestore for user:', uid);
      return null;
    }
  } catch (error) {
    console.error('Error loading user profile:', error);
    return null;
  }
}















         



        
        
        
        
        
        

// Load dashboard data - MOVE THIS FUNCTION HERE
async function loadDashboard() {
if (!currentUser || !userProfile) return;

document.getElementById('dashboardWelcome').textContent = `Welcome, ${userProfile.fullName}!`;
document.getElementById('dashboardDetails').textContent = `${userProfile.department}, ${userProfile.year}`;
document.getElementById('dashboardBio').textContent = `"${userProfile.bio}"`;

// Load profile image if available
if (userProfile.photoURL) {
document.getElementById('dashboardProfileImg').src = userProfile.photoURL;
document.getElementById('dashboardProfileImg').style.display = 'block';
document.getElementById('dashboardProfilePlaceholder').style.display = 'none';
} else {
document.getElementById('dashboardProfileImg').style.display = 'none';
document.getElementById('dashboardProfilePlaceholder').style.display = 'flex';
}
}


// Load students for browsing with filters
async function loadStudents() {
const studentsContainer = document.getElementById('studentsContainer');
studentsContainer.innerHTML = '<div class="spinner" id="browseSpinner"></div>';

try {
let query = db.collection('users').where('uid', '!=', currentUser.uid);

// Apply filters if any - FIXED VERSION
if (activeFilters.department) {
query = query.where('department', '==', activeFilters.department);
}

if (activeFilters.year) {
query = query.where('year', '==', activeFilters.year);
}

const usersSnapshot = await query.get();



                studentsContainer.innerHTML = '';
                
                if (usersSnapshot.empty) {
                    studentsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No students found</h3>
                            <p>Try adjusting your filters to see more results</p>
                        </div>
                    `;
                    return;
                }
                
                usersSnapshot.forEach(doc => {
                    const student = doc.data();
                    const studentCard = document.createElement('div');
                    studentCard.className = 'student-card';
                    
                    // Create interest tags
                    let interestTags = '';
                    if (student.interests && student.interests.length > 0) {
                        student.interests.slice(0, 4).forEach(interest => {
                            interestTags += `<span class="interest-tag">${interest}</span>`;
                        });
                        if (student.interests.length > 4) {
                            interestTags += `<span class="interest-tag">+${student.interests.length - 4} more</span>`;
                        }
                    }
                    
                    studentCard.innerHTML = `
                        <div class="student-img">
                            ${student.photoURL ? 
                                `<img src="${student.photoURL}" alt="${student.fullName}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                `<i class="fas fa-user"></i>`
                            }
                            <div class="student-online" style="display: ${student.isOnline ? 'block' : 'none'}"></div>
                        </div>
                        <div class="student-info">
                            <div class="student-name">
                                <span>${student.fullName}</span>
                                <span>${student.year}</span>
                            </div>
                            <div class="student-details">
                                <p><strong>Department:</strong> ${student.department}</p>
                                <p><strong>Looking for:</strong> ${student.lookingFor}</p>
                            </div>
                            ${interestTags ? `<div class="student-interests">${interestTags}</div>` : ''}
                            <button class="btn" style="width: 100%;" onclick="startConversation('${student.uid}')">Send Message</button>
                          
                          
                          
<button class="btn btn-outline" style="width: 100%; margin-top: 10px;" onclick="viewUserProfile('${student.uid}')">View Profile</button>
                            
                            
                            
                        </div>
                    `;
                  
                  
            
                 
                    studentsContainer.appendChild(studentCard);
                });
            } catch (error) {
                console.error('Error loading students:', error);
                studentsContainer.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--error-color);">Error loading students.</p>';
            }
        }
        
        
        
        
        
        
        
// Load user profile - ENHANCED VERSION
async function loadProfile() {
  if (!currentUser) {
    console.log('No current user for profile loading');
    return;
  }
  
  console.log('Loading profile for user:', currentUser.uid);
  
  try {
    // Always try to load fresh data from Firestore first
    const freshProfile = await loadUserProfile(currentUser.uid);
    
    if (freshProfile) {
      userProfile = freshProfile;
      console.log('Profile loaded from Firestore:', userProfile);
    } else if (userProfile) {
      console.log('Using existing userProfile data');
    } else {
      console.log('No profile data available');
      showNotification('Profile data not available', 'error');
      return;
    }
    
    // Populate form fields - WITH NULL CHECKS
    document.getElementById('profileName').value = userProfile.fullName || '';
    document.getElementById('profileStudentId').value = userProfile.studentId || '';
    document.getElementById('profileDepartment').value = userProfile.department || '';
    document.getElementById('profileYear').value = userProfile.year || '';
    document.getElementById('profileInterests').value = userProfile.interests ? userProfile.interests.join(', ') : '';
    document.getElementById('profileBio').value = userProfile.bio || '';
    
    console.log('Form populated with:', {
      name: userProfile.fullName,
      department: userProfile.department,
      year: userProfile.year
    });
    
    // Load profile image if available
    if (userProfile.photoURL) {
      console.log('Setting profile photo:', userProfile.photoURL);
      document.getElementById('profilePhotoPreview').src = userProfile.photoURL;
      document.getElementById('profilePhotoPreview').style.display = 'block';
      document.getElementById('profilePhotoPlaceholder').style.display = 'none';
    } else {
      console.log('No profile photo, using placeholder');
      document.getElementById('profilePhotoPreview').style.display = 'none';
      document.getElementById('profilePhotoPlaceholder').style.display = 'flex';
    }
    
    // Also update dashboard if it's visible
    if (typeof loadDashboard === 'function') {
      loadDashboard();
    }
    
  } catch (error) {
    console.error('Error in loadProfile:', error);
    showNotification('Error loading profile data', 'error');
  }
}
        
        
        
 
        
        
        
        
        
// Update profile
document.getElementById('profileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!currentUser) return;
    
    const fullName = document.getElementById('profileName').value;
    const department = document.getElementById('profileDepartment').value;
    const year = document.getElementById('profileYear').value;
    const interests = document.getElementById('profileInterests').value;
    const bio = document.getElementById('profileBio').value;
    const profilePhoto = document.getElementById('profilePhotoUpload').files[0];
    
    toggleButtonLoading('updateProfile', true);
    
    try {
        let updates = {
            fullName: fullName,
            department: department,
            year: year,
            interests: interests.split(',').map(item => item.trim()).filter(item => item !== ''),
            bio: bio,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        
        
// Upload new profile photo if selected
if (profilePhoto) {
    // Check file size (max 2MB)
    if (profilePhoto.size > 2 * 1024 * 1024) {
        showNotification('Please select an image smaller than 2MB', 'error');
        toggleButtonLoading('updateProfile', false);
        return;
    }
    
    console.log('Uploading profile photo...', profilePhoto);
    
    try {
        const storageRef = storage.ref();
        const photoRef = storageRef.child(`profile_photos/${currentUser.uid}`);
        
        console.log('Storage reference created');
        
        // Simple upload with detailed error handling
        const snapshot = await photoRef.put(profilePhoto);
        console.log('Upload completed, snapshot:', snapshot);
        
        // Get download URL
        const downloadURL = await photoRef.getDownloadURL();
        console.log('Download URL obtained:', downloadURL);
        
        updates.photoURL = downloadURL;
        console.log('Photo uploaded successfully, URL:', updates.photoURL);
        
    } catch (uploadError) {
        console.error('Photo upload failed with details:', uploadError);
        console.error('Error code:', uploadError.code);
        console.error('Error message:', uploadError.message);
        
        // Check specific error types
        if (uploadError.code === 'storage/unauthorized') {
            showNotification('Photo upload failed: Storage permissions error', 'error');
        } else if (uploadError.code === 'storage/unknown') {
            showNotification('Photo upload failed: Network error', 'error');
        } else {
            showNotification('Photo upload failed: ' + uploadError.message, 'error');
        }
        
        // Continue with profile update without the photo
    }
}
        

        
        // Update user profile in Firestore
        
// Debug logging
console.log('Updating profile with data:', updates);
console.log('Current user UID:', currentUser.uid);

// Update user profile in Firestore
await db.collection('users').doc(currentUser.uid).update(updates);
        
        
        // Refresh the user profile from Firestore to get the latest data
        
        
// Refresh the user profile from Firestore to get the latest data
userProfile = await loadUserProfile(currentUser.uid);

if (userProfile) {
    showNotification('Profile updated successfully!', 'success');
    
    // Reload ALL sections that display profile data
    if (typeof loadDashboard === 'function') {
        loadDashboard();
    }
    if (typeof loadProfile === 'function') {
        loadProfile();
    }
} else {
    showNotification('Profile update failed', 'error');
}
        
        
        
        
    } catch (error) {
        console.error('Error updating profile:', error);
        showNotification(error.message, 'error');
    } finally {
        toggleButtonLoading('updateProfile', false);
    }
});
        
        
        
        
        // Change profile photo button
        document.getElementById('changePhotoBtn').addEventListener('click', function() {
            document.getElementById('profilePhotoUpload').click();
        });
        
        // Profile photo preview
        document.getElementById('profilePhotoUpload').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profilePhotoPreview').src = e.target.result;
                    document.getElementById('profilePhotoPreview').style.display = 'block';
                    document.getElementById('profilePhotoPlaceholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Load conversations
        async function loadConversations() {
            const conversationsList = document.getElementById('conversationsList');
            conversationsList.innerHTML = '<div class="spinner"></div>';
            
            try {
                // Get conversations where current user is a participant
                const conversationsSnapshot = await db.collection('conversations')
                    .where('participants', 'array-contains', currentUser.uid)
                    .orderBy('lastUpdated', 'desc')
                    .get();
                
                conversationsList.innerHTML = '';
                
                if (conversationsSnapshot.empty) {
                    conversationsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <h3>No conversations yet</h3>
                            <p>Start a conversation with someone from the Browse page</p>
                        </div>
                    `;
                    return;
                }
                
                // Get user data for each conversation
                const conversationPromises = conversationsSnapshot.docs.map(async doc => {
                    const conversation = doc.data();
                    const otherUserId = conversation.participants.find(uid => uid !== currentUser.uid);
                    
                    if (!otherUserId) return null;
                    
                    const userDoc = await db.collection('users').doc(otherUserId).get();
                    if (!userDoc.exists) return null;
                    
                    const user = userDoc.data();
                    
                    const conversationElement = document.createElement('div');
                    conversationElement.className = 'conversation';
                    conversationElement.dataset.conversationId = doc.id;
                    conversationElement.dataset.otherUserId = otherUserId;
                    
                    const lastUpdated = conversation.lastUpdated ? conversation.lastUpdated.toDate() : new Date();
                    const timeAgo = getTimeAgo(lastUpdated);
                    
                    conversationElement.innerHTML = `
                        <div class="conversation-img">
                            ${user.photoURL ? 
                                `<img src="${user.photoURL}" alt="${user.fullName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 
                                `<i class="fas fa-user"></i>`
                            }
                            <div class="conversation-online" style="display: ${user.isOnline ? 'block' : 'none'}"></div>
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-name">${user.fullName}</div>
                            <div class="conversation-preview">${conversation.lastMessage || 'No messages yet'}</div>
                        </div>
                        <div class="conversation-time">${timeAgo}</div>
                    `;
                    
                    conversationElement.addEventListener('click', function() {
                        loadConversation(doc.id, otherUserId);
                    });
                    
                    conversationsList.appendChild(conversationElement);
                    return conversationElement;
                });
                
                await Promise.all(conversationPromises);
            } catch (error) {
                console.error('Error loading conversations:', error);
                conversationsList.innerHTML = '<p style="text-align: center; padding: 1rem; color: var(--error-color);">Error loading conversations.</p>';
            }
        }
        
        // Load a specific conversation
        async function loadConversation(conversationId, otherUserId) {
            const chatHeader = document.getElementById('chatHeader');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            
            // Clean up previous listener if exists
            if (unsubscribeChat) {
                unsubscribeChat();
            }
            
            chatMessages.innerHTML = '<div class="spinner"></div>';
            chatInput.style.display = 'none';
            
            try {
                // Get other user's data
                const otherUserDoc = await db.collection('users').doc(otherUserId).get();
                if (!otherUserDoc.exists) {
                    chatMessages.innerHTML = '<p style="text-align: center; padding: 2rem;">User not found.</p>';
                    return;
                }
                
                const otherUser = otherUserDoc.data();
                chatHeader.innerHTML = `
                    <div class="chat-user-info">
                        <span>${otherUser.fullName}</span>
                        <span class="chat-user-status">${otherUser.isOnline ? 'Online' : 'Offline'}</span>
                    </div>
                `;
                
                // Set up real-time listener for messages
                unsubscribeChat = db.collection('conversations')
                    .doc(conversationId)
                    .collection('messages')
                    .orderBy('timestamp', 'asc')
                    .onSnapshot((snapshot) => {
                        chatMessages.innerHTML = '';
                        
                        if (snapshot.empty) {
                            chatMessages.innerHTML = '<p style="text-align: center; padding: 2rem;">No messages yet. Start a conversation!</p>';
                        } else {
                            snapshot.forEach(doc => {
                                const message = doc.data();
                                const messageElement = document.createElement('div');
                                messageElement.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
                                
                                const time = message.timestamp ? message.timestamp.toDate() : new Date();
                                const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                                
                                messageElement.innerHTML = `
                                    <p>${message.text}</p>
                                    <div class="message-time">${timeString}</div>
                                `;
                                
                                chatMessages.appendChild(messageElement);
                            });
                            
                            // Scroll to bottom
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                        
                        // Show chat input
                        chatInput.style.display = 'flex';
                    });
                
                // Show chat input and set up event listener
                chatInput.dataset.conversationId = conversationId;
                chatInput.dataset.otherUserId = otherUserId;
                
            } catch (error) {
                console.error('Error loading conversation:', error);
                chatMessages.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--error-color);">Error loading conversation.</p>';
            }
        }
        
        // Start a new conversation
        async function startConversation(otherUserId) {
            try {
                // Check if conversation already exists
                const existingConversation = await db.collection('conversations')
                    .where('participants', 'array-contains', currentUser.uid)
                    .get();
                
                let conversationId = null;
                
                existingConversation.forEach(doc => {
                    const conversation = doc.data();
                    if (conversation.participants.includes(otherUserId)) {
                        conversationId = doc.id;
                    }
                });
                
                // Create new conversation if it doesn't exist
                if (!conversationId) {
                    const newConversation = {
                        participants: [currentUser.uid, otherUserId],
                        lastMessage: '',
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const conversationRef = await db.collection('conversations').add(newConversation);
                    conversationId = conversationRef.id;
                }
                
                // Switch to messages section and load the conversation
                showSection('messages');
                updateActiveNav(document.querySelector('[data-section="messages"]'));
                loadConversation(conversationId, otherUserId);
                
            } catch (error) {
                console.error('Error starting conversation:', error);
                showNotification('Error starting conversation', 'error');
            }
        }
        
        // Send message
        document.getElementById('sendMessageBtn').addEventListener('click', async function() {
            const chatInput = document.getElementById('chatInput');
            const messageInput = document.getElementById('messageInput');
            const conversationId = chatInput.dataset.conversationId;
            const otherUserId = chatInput.dataset.otherUserId;
            const messageText = messageInput.value.trim();
            
            if (!messageText || !conversationId) return;
            
            try {
                // Add message to conversation
                const messageData = {
                    text: messageText,
                    senderId: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('conversations')
                    .doc(conversationId)
                    .collection('messages')
                    .add(messageData);
                
                // Update conversation last message and timestamp
                await db.collection('conversations')
                    .doc(conversationId)
                    .update({
                        lastMessage: messageText,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
// Update conversation last message and timestamp
await db.collection('conversations')
    .doc(conversationId)
    .update({
        lastMessage: messageText,
        lastMessageSender: currentUser.uid, //  ADD THIS LINE
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    });
                    
                
                // Clear input
                messageInput.value = '';
                
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Error sending message', 'error');
            }
        });
        
        // Allow sending message with Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('sendMessageBtn').click();
            }
        });
        
       // Filter functionality - ONLY department and year 
       
// Filter functionality - ONLY department and year

document.getElementById('applyFilters').addEventListener('click', function() {
       
       

    // Get only department and year filter values
    activeFilters = {
        department: document.getElementById('filterDepartment').value,
        year: document.getElementById('filterYear').value
        // Remove all other filters
    };
    
    // Update filter tags
    updateFilterTags();
    
    // Load students with filters
    loadStudents();
});
       
       
        
        // Clear filters
        document.getElementById('clearFilters').addEventListener('click', function() {
            // Reset filter inputs
            document.getElementById('filterDepartment').value = '';
            document.getElementById('filterYear').value = '';
            document.getElementById('filterGender').value = '';
            document.getElementById('filterReligion').value = '';
            document.getElementById('filterPersonality').value = '';
            document.getElementById('filterLookingFor').value = '';
            document.getElementById('filterInterests').value = '';
            document.getElementById('filterMaritalStatus').value = '';
            
            // Clear active filters
            activeFilters = {};
            
            // Update filter tags
            updateFilterTags();
            
            // Load all students
            loadStudents();
        });
        
        // Toggle filter visibility on mobile
        document.getElementById('filterToggle').addEventListener('click', function() {
            document.getElementById('filterContent').classList.toggle('show');
        });
        
        // Update filter tags display
        function updateFilterTags() {
            const filterTags = document.getElementById('filterTags');
            filterTags.innerHTML = '';
            
            let hasActiveFilters = false;
            
            for (const [key, value] of Object.entries(activeFilters)) {
                if (value) {
                    hasActiveFilters = true;
                    const tag = document.createElement('div');
                    tag.className = 'filter-tag';
                    tag.innerHTML = `
                        ${key}: ${value}
                        <button type="button" onclick="removeFilter('${key}')">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    filterTags.appendChild(tag);
                }
            }
            
            filterTags.style.display = hasActiveFilters ? 'flex' : 'none';
        }
        
        // Remove individual filter
        function removeFilter(key) {
            activeFilters[key] = '';
            document.getElementById(`filter${key.charAt(0).toUpperCase() + key.slice(1)}`).value = '';
            updateFilterTags();
            loadStudents();
        }
        
        // Get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return 'Just now';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes}m ago`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours}h ago`;
            } else {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days}d ago`;
            }
        }
        
        
        
        
// Get time ago string
function getTimeAgo(date) {
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) {
        return 'Just now';
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes}m ago`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours}h ago`;
    } else {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days}d ago`;
    }
}

// View other user's profile
async function viewUserProfile(userId) {
    try {
        // Get the user's profile data
        const userDoc = await db.collection('users').doc(userId).get();
        
        if (userDoc.exists) {
            const userProfile = userDoc.data();
            
            // Create a modal or section to display the profile
            const profileHTML = `
                <div class="profile-view">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            ${userProfile.photoURL ? 
                                `<img src="${userProfile.photoURL}" alt="${userProfile.fullName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 
                                `<i class="fas fa-user"></i>`
                            }
                        </div>
                    </div>
                    <div class="profile-body">
                        <h2 class="profile-name">${userProfile.fullName}</h2>
                        <div class="profile-details">
                            <p>${userProfile.department}  ${userProfile.year}</p>
                            <p>Looking for: ${userProfile.lookingFor}</p>
                        </div>
                        
                        <div class="profile-section">
                            <h3 class="profile-section-title">About Me</h3>
                            <p>${userProfile.bio || 'No bio available.'}</p>
                        </div>
                        
                        <div class="profile-section">
                            <h3 class="profile-section-title">Interests</h3>
                            <div class="student-interests">
                                ${userProfile.interests && userProfile.interests.length > 0 ? 
                                    userProfile.interests.map(interest => `<span class="interest-tag">${interest}</span>`).join('') : 
                                    'No interests listed.'
                                }
                            </div>
                        </div>
                        
                        <div class="profile-section">
                            <h3 class="profile-section-title">Details</h3>
                            <div class="profile-info-grid">
                                <div class="profile-info-item">
                                    <div class="profile-info-label">Gender</div>
                                    <div>${userProfile.gender || 'Not specified'}</div>
                                </div>
                                <div class="profile-info-item">
                                    <div class="profile-info-label">Relationship Experience</div>
                                    <div>${userProfile.relationshipExp || 'Not specified'}</div>
                                </div>
                                <div class="profile-info-item">
                                    <div class="profile-info-label">Personality</div>
                                    <div>${userProfile.personality || 'Not specified'}</div>
                                </div>
                                <div class="profile-info-item">
                                    <div class="profile-info-label">Religion</div>
                                    <div>${userProfile.religion || 'Not specified'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn" style="width: 100%; margin-top: 20px;" onclick="startConversation('${userId}')">
                            Send Message
                        </button>
                    </div>
                </div>
            `;
            
            // Create a modal or show in a section
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';
            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="text-align: right;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    ${profileHTML}
                </div>
            `;
            
            document.body.appendChild(modal);
        } else {
            showNotification('User profile not found', 'error');
        }
    } catch (error) {
        console.error('Error loading user profile:', error);
        showNotification('Error loading profile', 'error');
    }
}
        
        
        
        
        
        
        
        
        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            
            try {
                // Clean up any listeners
                if (unsubscribeChat) {
                    unsubscribeChat();
                    unsubscribeChat = null;
                }
                
                await auth.signOut();
                currentUser = null;
                userProfile = null;
                
                // Show unauthenticated navigation
                updateNavigation(false);
                
                // Show home section
                showSection('home');
                updateActiveNav(document.querySelector('[data-section="home"]'));
                
                showNotification('Logged out successfully', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Error logging out', 'error');
            }
        });
        
        // Update navigation based on authentication status
        function updateNavigation(isAuthenticated) {
            if (isAuthenticated) {
                document.getElementById('loginNav').style.display = 'none';
                document.getElementById('signupNav').style.display = 'none';
                document.getElementById('dashboardNav').style.display = 'list-item';
                document.getElementById('browseNav').style.display = 'list-item';
                document.getElementById('messagesNav').style.display = 'list-item';
                document.getElementById('profileNav').style.display = 'list-item';
            } else {
                document.getElementById('loginNav').style.display = 'list-item';
                document.getElementById('signupNav').style.display = 'list-item';
                document.getElementById('dashboardNav').style.display = 'none';
                document.getElementById('browseNav').style.display = 'none';
                document.getElementById('messagesNav').style.display = 'none';
                document.getElementById('profileNav').style.display = 'none';
            }
        }
        
        // Dashboard card navigation
        document.querySelectorAll('.dashboard-cards .card').forEach(card => {
            card.addEventListener('click', function() {
                const sectionId = this.getAttribute('data-section');
                if (sectionId === 'home' && this.id === 'logoutBtn') return; // Handled separately
                
                showSection(sectionId);
                updateActiveNav(document.querySelector(`[data-section="${sectionId}"]`));
            });
        });
        
        // Firebase auth state observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                
                try {
                    // Get user profile
                    
                    
// Load user profile using the new function
userProfile = await loadUserProfile(user.uid);

if (userProfile) {
    // Update user online status
    await db.collection('users').doc(user.uid).update({
        isOnline: true,
        lastSeen: new Date()
    });
    
    updateNavigation(true);
    
    // If on auth pages, redirect to dashboard
    if (document.getElementById('login').classList.contains('active') ||
        document.getElementById('signup').classList.contains('active')) {
        showSection('dashboard');
        updateActiveNav(document.querySelector('[data-section="dashboard"]'));
    }
} else {
    // User document doesn't exist, sign out
    await auth.signOut();
    currentUser = null;
    showNotification('Please wait a second....', 'error');
}
                    
                    
                    
                } catch (error) {
                    console.error('Error getting user profile:', error);
                    await auth.signOut();
                    currentUser = null;
                }
            } else {
                // User is signed out
                if (currentUser) {
                    // Update user offline status
                    try {
                        await db.collection('users').doc(currentUser.uid).update({
                            isOnline: false,
                            lastSeen: new Date()
                        });
                    } catch (error) {
                        console.error('Error updating offline status:', error);
                    }
                }
                
                currentUser = null;
                userProfile = null;
                updateNavigation(false);
                
                // If on protected page, redirect to home
                if (document.getElementById('dashboard').classList.contains('active') || 
                    document.getElementById('browse').classList.contains('active') ||
                    document.getElementById('messages').classList.contains('active') ||
                    document.getElementById('profile').classList.contains('active')) {
                    showSection('home');
                    updateActiveNav(document.querySelector('[data-section="home"]'));
                }
            }
        });
        
        // Update user online status when window gains focus
        window.addEventListener('focus', async () => {
            if (currentUser) {
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        isOnline: true,
                        lastSeen: new Date()
                    });
                } catch (error) {
                    console.error('Error updating online status:', error);
                }
            }
        });
        
        // Update user offline status when window loses focus
        window.addEventListener('blur', async () => {
            if (currentUser) {
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        isOnline: false,
                        lastSeen: new Date()
                    });
                } catch (error) {
                    console.error('Error updating offline status:', error);
                }
            }
        });
        
        // Handle page visibility change
        document.addEventListener('visibilitychange', async () => {
            if (currentUser) {
                if (document.visibilityState === 'visible') {
                    try {
                        await db.collection('users').doc(currentUser.uid).update({
                            isOnline: true,
                            lastSeen: new Date()
                        });
                    } catch (error) {
                        console.error('Error updating online status:', error);
                    }
                } else {
                    try {
                        await db.collection('users').doc(currentUser.uid).update({
                            isOnline: false,
                            lastSeen: new Date()
                        });
                    } catch (error) {
                        console.error('Error updating offline status:', error);
                    }
                }
            }
        });
        
        
        
        
// ===== MESSAGE NOTIFICATION SYSTEM =====

// Show message notification
function showMessageNotification(senderName, messageText) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'notification success show';
    notification.innerHTML = `
        <div style="display: flex; align-items: center;">
            <i class="fas fa-envelope" style="margin-right: 10px;"></i>
            <div>
                <strong>New message from ${senderName}</strong>
                <p>${messageText.length > 50 ? messageText.substring(0, 50) + '...' : messageText}</p>
            </div>
        </div>
    `;
    
    // Add click to open messages
    notification.style.cursor = 'pointer';
    notification.addEventListener('click', function() {
        showSection('messages');
        updateActiveNav(document.querySelector('[data-section="messages"]'));
    });
    
    // Add to notification container
    const container = document.getElementById('notification');
    container.parentNode.insertBefore(notification, container.nextSibling);
    
    // Remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Listen for new messages in real-time
function setupMessageListeners() {
if (!currentUser) return;

console.log('Setting up message listeners for user:', currentUser.uid);

// Listen to all conversations where user is participant
db.collection('conversations')
.where('participants', 'array-contains', currentUser.uid)
.onSnapshot((snapshot) => {
console.log('Conversation update detected');
snapshot.docChanges().forEach((change) => {
console.log('Change type:', change.type);
if (change.type === 'modified') {
const conversation = change.doc.data();
console.log('Modified conversation:', conversation);

// Check if this is a new message (not from current user)
if (conversation.lastUpdated &&
conversation.lastMessage &&
conversation.lastMessageSender !== currentUser.uid) {

console.log('New message from someone else detected');
// Get sender info
db.collection('users').doc(conversation.lastMessageSender).get()
.then((senderDoc) => {
if (senderDoc.exists) {
const sender = senderDoc.data();
console.log('Showing notification from:', sender.fullName);
showMessageNotification(sender.fullName, conversation.lastMessage);
}
});
}
}
});
});
}



     
     
     
     
     
     
     
     
     
     
     
     
     
     
     // ===== SEARCH FUNCTIONALITY =====

// Add search input to the browse section
function addSearchFunctionality() {
    const filtersSection = document.querySelector('.filters');
    
    // Create search input
    const searchHTML = `
        <div class="form-group" style="margin-bottom: 1rem;">
            <label for="searchName">Search by Name</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="searchName" class="form-control" placeholder="Enter student name...">
                <button class="btn" id="searchButton" style="white-space: nowrap;">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>
    `;
    
    // Add search to the top of filters
    filtersSection.insertAdjacentHTML('afterbegin', searchHTML);
    
    // Add event listeners
    document.getElementById('searchButton').addEventListener('click', searchStudents);
    document.getElementById('searchName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchStudents();
        }
    });
}

// Search students by name
async function searchStudents() {
    const searchTerm = document.getElementById('searchName').value.trim().toLowerCase();
    
    if (!searchTerm) {
        showNotification('Please enter a name to search', 'warning');
        return;
    }
    
    const studentsContainer = document.getElementById('studentsContainer');
    studentsContainer.innerHTML = '<div class="spinner" id="browseSpinner"></div>';
    
    try {
        let query = db.collection('users').where('uid', '!=', currentUser.uid);
        
        // Apply existing filters if any
        if (activeFilters.department) {
            query = query.where('department', '==', activeFilters.department);
        }
        
        if (activeFilters.year) {
            query = query.where('year', '==', activeFilters.year);
        }
        
        const usersSnapshot = await query.get();
        studentsContainer.innerHTML = '';
        
        if (usersSnapshot.empty) {
            studentsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <h3>No students found</h3>
                    <p>Try adjusting your search or filters</p>
                </div>
            `;
            return;
        }
        
        let foundStudents = false;
        
        usersSnapshot.forEach(doc => {
            const student = doc.data();
            
            // Check if student name matches search term
            if (student.fullName && student.fullName.toLowerCase().includes(searchTerm)) {
                foundStudents = true;
                
                const studentCard = document.createElement('div');
                studentCard.className = 'student-card';
                
                // Create interest tags
                let interestTags = '';
                if (student.interests && student.interests.length > 0) {
                    student.interests.slice(0, 4).forEach(interest => {
                        interestTags += `<span class="interest-tag">${interest}</span>`;
                    });
                    if (student.interests.length > 4) {
                        interestTags += `<span class="interest-tag">+${student.interests.length - 4} more</span>`;
                    }
                }
                
                studentCard.innerHTML = `
                    <div class="student-img">
                        ${student.photoURL ? 
                            `<img src="${student.photoURL}" alt="${student.fullName}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                            `<i class="fas fa-user"></i>`
                        }
                        <div class="student-online" style="display: ${student.isOnline ? 'block' : 'none'}"></div>
                    </div>
                    <div class="student-info">
                        <div class="student-name">
                            <span>${student.fullName}</span>
                            <span>${student.year}</span>
                        </div>
                        <div class="student-details">
                            <p><strong>Department:</strong> ${student.department}</p>
                            <p><strong>Looking for:</strong> ${student.lookingFor}</p>
                        </div>
                        ${interestTags ? `<div class="student-interests">${interestTags}</div>` : ''}
                        <button class="btn" style="width: 100%;" onclick="startConversation('${student.uid}')">Send Message</button>
                        <button class="btn btn-outline" style="width: 100%; margin-top: 10px;" onclick="viewUserProfile('${student.uid}')">View Profile</button>
                    </div>
                `;
                
                studentsContainer.appendChild(studentCard);
            }
        });
        
        if (!foundStudents) {
            studentsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <h3>No students found</h3>
                    <p>No students match your search for "${searchTerm}"</p>
                    <button class="btn" style="margin-top: 1rem;" onclick="clearSearch()">Clear Search</button>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error searching students:', error);
        studentsContainer.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--error-color);">Error searching students.</p>';
    }
}

// Clear search and show all students
function clearSearch() {
    document.getElementById('searchName').value = '';
    loadStudents(); // This will reload all students without search filter
}

// Clear search when filters are cleared
document.getElementById('clearFilters').addEventListener('click', function() {
    document.getElementById('searchName').value = '';
});

// Initialize search functionality when browse section is loaded
const originalLoadStudents = loadStudents;
loadStudents = function() {
    originalLoadStudents();
    
    // Add search functionality if it doesn't exist yet
    if (!document.getElementById('searchName')) {
        setTimeout(addSearchFunctionality, 100);
    }
};


    
    

    


     
     
     
     

     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     

     
     
     
     
     
     
     
     
     
     // ===== MESSAGE REQUESTS BAR =====

// Create and manage message requests bar
function setupMessageRequestsBar() {
    // Create the requests bar container
    const requestsBar = document.createElement('div');
    requestsBar.id = 'messageRequestsBar';
    requestsBar.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 999;
        padding: 15px;
        max-width: 350px;
        border: 2px solid var(--success-color);
        display: none;
        flex-direction: column;
        gap: 10px;
    `;

    // Create header
    const header = document.createElement('div');
    header.style.cssText = `
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    `;
    header.innerHTML = `
        <h4 style="margin: 0; color: var(--primary-color);">
            <i class="fas fa-envelope" style="color: var(--success-color);"></i>
            Message Requests
        </h4>
        <button id="closeRequestsBar" style="
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
            padding: 5px;
        ">&times;</button>
    `;

    // Create requests list container
    const requestsList = document.createElement('div');
    requestsList.id = 'requestsBarList';
    requestsList.style.cssText = `
        max-height: 300px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
    `;

    // Create footer with view all button
    const footer = document.createElement('div');
    footer.style.cssText = `
        display: flex;
        justify-content: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
    `;
    footer.innerHTML = `
        <button class="btn btn-sm" onclick="showAllMessageRequests()" style="width: 100%;">
            <i class="fas fa-list"></i> View All Requests
        </button>
    `;

    // Assemble the bar
    requestsBar.appendChild(header);
    requestsBar.appendChild(requestsList);
    requestsBar.appendChild(footer);
    document.body.appendChild(requestsBar);

    // Add event listeners
    document.getElementById('closeRequestsBar').addEventListener('click', hideRequestsBar);

    // Add hover effects
    requestsBar.addEventListener('mouseenter', function() {
        this.style.boxShadow = '0 6px 25px rgba(0,0,0,0.2)';
    });

    requestsBar.addEventListener('mouseleave', function() {
        this.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';
    });

    // Check for requests on load
    checkForMessageRequests();
}

// Check for new message requests
async function checkForMessageRequests() {
    if (!currentUser) return;

    try {
        const requestsSnapshot = await db.collection('messageRequests')
            .where('receiverId', '==', currentUser.uid)
            .where('status', '==', 'pending')
            .orderBy('createdAt', 'desc')
            .limit(5)
            .get();

        const requests = [];
        for (const doc of requestsSnapshot.docs) {
            const request = doc.data();
            request.id = doc.id;
            
            // Get sender info
            const senderDoc = await db.collection('users').doc(request.senderId).get();
            if (senderDoc.exists) {
                request.sender = senderDoc.data();
                requests.push(request);
            }
        }

        updateRequestsBar(requests);
    } catch (error) {
        console.error('Error checking message requests:', error);
    }
}

// Update requests bar with new requests
function updateRequestsBar(requests) {
    const requestsBar = document.getElementById('messageRequestsBar');
    const requestsList = document.getElementById('requestsBarList');
    
    if (!requestsBar || !requestsList) return;

    requestsList.innerHTML = '';

    if (requests.length === 0) {
        requestsList.innerHTML = `
            <div style="text-align: center; color: #666; padding: 10px;">
                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                <p style="margin: 0;">No message requests</p>
            </div>
        `;
        requestsBar.style.display = 'none';
        return;
    }

    requests.forEach(request => {
        const requestItem = document.createElement('div');
        requestItem.className = 'request-item';
        requestItem.style.cssText = `
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid var(--success-color);
        `;

        requestItem.innerHTML = `
            <div style="flex-shrink: 0; margin-right: 12px;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--accent-color); 
                     display: flex; align-items: center; justify-content: center;">
                    ${request.sender.photoURL ? 
                        `<img src="${request.sender.photoURL}" alt="${request.sender.fullName}" 
                             style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 
                        `<i class="fas fa-user" style="color: var(--primary-color);"></i>`
                    }
                </div>
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; color: var(--primary-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${request.sender.fullName}
                </div>
                <div style="font-size: 0.8rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${request.sender.department}  ${request.sender.year}
                </div>
            </div>
            <div style="flex-shrink: 0; margin-left: 10px;">
                <button class="btn btn-sm" onclick="event.stopPropagation(); acceptMessageRequest('${request.id}', '${request.senderId}')" 
                        style="padding: 4px 8px; font-size: 0.75rem;">
                    <i class="fas fa-check"></i>
                </button>
            </div>
        `;

        // Click to view profile
        requestItem.addEventListener('click', () => {
            viewUserProfile(request.senderId);
            hideRequestsBar();
        });

        // Hover effects
        requestItem.addEventListener('mouseenter', function() {
            this.style.background = '#e9ecef';
            this.style.transform = 'translateX(-2px)';
        });

        requestItem.addEventListener('mouseleave', function() {
            this.style.background = '#f8f9fa';
            this.style.transform = 'translateX(0)';
        });

        requestsList.appendChild(requestItem);
    });

    // Show the bar
    requestsBar.style.display = 'flex';
    
    // Add notification badge to document title
    if (requests.length > 0) {
        document.title = `(${requests.length}) ${originalDocumentTitle}`;
    }
}

// Show all message requests in modal
function showAllMessageRequests() {
    hideRequestsBar();
    showMessageRequests(); // This should be your existing modal function
}

// Hide requests bar
function hideRequestsBar() {
    const requestsBar = document.getElementById('messageRequestsBar');
    if (requestsBar) {
        requestsBar.style.display = 'none';
    }
    document.title = originalDocumentTitle;
}

// Show requests bar
function showRequestsBar() {
    checkForMessageRequests();
}

// Listen for new message requests in real-time
function setupRequestsBarListener() {
    if (!currentUser) return;

    // Listen for new message requests
    return db.collection('messageRequests')
        .where('receiverId', '==', currentUser.uid)
        .where('status', '==', 'pending')
        .onSnapshot((snapshot) => {
            snapshot.docChanges().forEach(async (change) => {
                if (change.type === 'added') {
                    // New request added
                    const request = change.doc.data();
                    request.id = change.doc.id;
                    
                    // Get sender info
                    const senderDoc = await db.collection('users').doc(request.senderId).get();
                    if (senderDoc.exists) {
                        request.sender = senderDoc.data();
                        
                        // Show notification
                        showNewRequestNotification(request);
                        
                        // Update bar
                        checkForMessageRequests();
                    }
                }
            });
        });
}

// Show notification for new message request
function showNewRequestNotification(request) {
    const notification = document.createElement('div');
    notification.className = 'notification success show';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        cursor: pointer;
        animation: slideInRight 0.3s ease;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--accent-color); 
                 display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                ${request.sender.photoURL ? 
                    `<img src="${request.sender.photoURL}" alt="${request.sender.fullName}" 
                         style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 
                    `<i class="fas fa-user" style="color: var(--primary-color);"></i>`
                }
            </div>
            <div>
                <strong>New message request</strong>
                <p style="margin: 5px 0 0 0; font-size: 0.9rem;">
                    ${request.sender.fullName} wants to message you
                </p>
            </div>
        </div>
    `;
    
    notification.addEventListener('click', () => {
        viewUserProfile(request.senderId);
        notification.remove();
    });
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Store original document title
let originalDocumentTitle = document.title;

// Initialize message requests bar
function initMessageRequestsBar() {
    setupMessageRequestsBar();
    
    // Set up real-time listener
    let requestsListener = null;
    
    if (currentUser) {
        requestsListener = setupRequestsBarListener();
    }
    
    // Re-setup when auth state changes
    const originalAuthStateChanged = auth.onAuthStateChanged;
    auth.onAuthStateChanged = (user) => {
        originalAuthStateChanged(user);
        
        if (user) {
            // Clean up previous listener
            if (requestsListener) {
                requestsListener();
            }
            
            // Setup new listener
            setTimeout(() => {
                requestsListener = setupRequestsBarListener();
                checkForMessageRequests();
            }, 1000);
        } else {
            if (requestsListener) {
                requestsListener();
            }
            hideRequestsBar();
        }
    };
}

// Add styles for requests bar
const requestsBarStyles = document.createElement('style');
requestsBarStyles.textContent = `
    #messageRequestsBar {
        animation: slideInUp 0.3s ease;
    }
    
    @keyframes slideInUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    #requestsBarList::-webkit-scrollbar {
        width: 4px;
    }
    
    #requestsBarList::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 2px;
    }
    
    #requestsBarList::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 2px;
    }
    
    #requestsBarList::-webkit-scrollbar-thumb:hover {
        background: #aaa;
    }
    
    @media (max-width: 768px) {
        #messageRequestsBar {
            bottom: 10px;
            right: 10px;
            left: 10px;
            max-width: none;
        }
        
        .request-item {
            padding: 8px !important;
        }
    }
    
    @media (max-width: 480px) {
        #messageRequestsBar {
            padding: 10px;
        }
        
        .request-item {
            flex-direction: column;
            text-align: center;
        }
        
        .request-item > div:first-child {
            margin-right: 0 !important;
            margin-bottom: 8px;
        }
        
        .request-item > div:last-child {
            margin-left: 0 !important;
            margin-top: 8px;
        }
    }
`;
document.head.appendChild(requestsBarStyles);

// Initialize the requests bar
setTimeout(initMessageRequestsBar, 2000);
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     

   
     

     
     
     
    







     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
    
  // Navigation History Management - Compact Circle Buttons
  (function() {
    // Navigation history stack
    let navHistory = [];
    let currentNavIndex = -1;
    
    // DOM elements
    let backButton, forwardButton, navButtonsContainer;
    
    // Initialize navigation history
    function initNavigationHistory() {
      // Get current active section
      const activeSection = document.querySelector('.section.active');
      if (activeSection) {
        const sectionId = activeSection.id;
        navHistory = [sectionId];
        currentNavIndex = 0;
        updateNavigationButtons();
      }
    }
    
    // Add to navigation history
    function addToNavHistory(sectionId) {
      // If we're not at the end of history, remove forward history
      if (currentNavIndex < navHistory.length - 1) {
        navHistory = navHistory.slice(0, currentNavIndex + 1);
      }
      
      // Add new section to history
      navHistory.push(sectionId);
      currentNavIndex = navHistory.length - 1;
      
      // Limit history size to prevent memory issues
      if (navHistory.length > 20) {
        navHistory.shift();
        currentNavIndex--;
      }
      
      updateNavigationButtons();
    }
    
    // Update button states based on navigation history
    function updateNavigationButtons() {
      if (!backButton || !forwardButton) return;
      
      // Show back button if we can go back
      if (currentNavIndex > 0) {
        backButton.style.display = 'flex';
      } else {
        backButton.style.display = 'none';
      }
      
      // Show forward button if we can go forward
      if (currentNavIndex < navHistory.length - 1) {
        forwardButton.style.display = 'flex';
      } else {
        forwardButton.style.display = 'none';
      }
    }
    
    // Navigate back
    function navigateBack() {
      if (currentNavIndex > 0) {
        currentNavIndex--;
        const sectionId = navHistory[currentNavIndex];
        navigateToSection(sectionId, false);
      }
    }
    
    // Navigate forward
    function navigateForward() {
      if (currentNavIndex < navHistory.length - 1) {
        currentNavIndex++;
        const sectionId = navHistory[currentNavIndex];
        navigateToSection(sectionId, false);
      }
    }
    
    // Navigate to section
    function navigateToSection(sectionId, addToHistory = true) {
      // Use the existing showSection function
      if (typeof showSection === 'function') {
        showSection(sectionId);
        
        // Add to history if requested
        if (addToHistory && sectionId !== navHistory[currentNavIndex]) {
          addToNavHistory(sectionId);
        }
      }
    }
    
    // Setup navigation tracking
    function setupNavigationTracking() {
      // Track nav link clicks
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          const sectionId = this.getAttribute('data-section');
          if (sectionId) {
            addToNavHistory(sectionId);
          }
        });
      });
      
      // Track dashboard card clicks
      const dashboardCards = document.querySelectorAll('.dashboard-cards .card.nav-link');
      dashboardCards.forEach(card => {
        card.addEventListener('click', function() {
          const sectionId = this.getAttribute('data-section');
          if (sectionId && sectionId !== 'home') {
            addToNavHistory(sectionId);
          }
        });
      });
    }
    
    // Add keyboard shortcuts for navigation
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function(e) {
        // Alt+Left Arrow for back
        if (e.altKey && e.key === 'ArrowLeft') {
          e.preventDefault();
          navigateBack();
        }
        
        // Alt+Right Arrow for forward
        if (e.altKey && e.key === 'ArrowRight') {
          e.preventDefault();
          navigateForward();
        }
      });
    }
    
    // Create compact circle navigation buttons
    function createNavigationButtons() {
      const navButtonsHTML = `
        <div id="navigation-buttons" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 999; display: flex; gap: 15px; align-items: center; justify-content: center;">
          <button id="back-button" class="nav-btn-circle" style="display: none; width: 50px; height: 50px; border-radius: 50%; background: var(--primary-color); color: white; border: none; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 18px;">
            
          </button>
          <button id="forward-button" class="nav-btn-circle" style="display: none; width: 50px; height: 50px; border-radius: 50%; background: var(--primary-color); color: white; border: none; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 18px;">
            
          </button>
        </div>
        
        <style>
          .nav-btn-circle:hover {
            background: var(--primary-dark) !important;
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
          }
          
          .nav-btn-circle:active {
            transform: translateY(0) scale(1);
          }
          
          @media (max-width: 768px) {
            #navigation-buttons {
              bottom: 15px;
              gap: 12px;
            }
            
            .nav-btn-circle {
              width: 45px !important;
              height: 45px !important;
              font-size: 16px !important;
            }
          }
          
          @media (max-width: 480px) {
            #navigation-buttons {
              bottom: 10px;
              gap: 10px;
            }
            
            .nav-btn-circle {
              width: 40px !important;
              height: 40px !important;
              font-size: 14px !important;
            }
          }
        </style>
      `;
      
      document.body.insertAdjacentHTML('beforeend', navButtonsHTML);
      
      // Get references to the buttons
      backButton = document.getElementById('back-button');
      forwardButton = document.getElementById('forward-button');
      navButtonsContainer = document.getElementById('navigation-buttons');
      
      // Add event listeners
      if (backButton) backButton.addEventListener('click', navigateBack);
      if (forwardButton) forwardButton.addEventListener('click', navigateForward);
    }
    
    // Initialize everything
    function initNavigationSystem() {
      // Create navigation buttons
      createNavigationButtons();
      
      // Wait for DOM to be fully loaded
      setTimeout(() => {
        initNavigationHistory();
        setupNavigationTracking();
        setupKeyboardShortcuts();
        
        // Make buttons container visible
        if (navButtonsContainer) navButtonsContainer.style.display = 'flex';
      }, 1000);
    }
    
    // Start the navigation system after a short delay
    setTimeout(initNavigationSystem, 500);
    
  })();

     
     
     


  

     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     

     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     

 


   

     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
  
  // Fixed Navigation Menu - No Refresh Needed
  (function() {
    
    // Enhanced navigation system
    function fixNavigationMenu() {
      console.log('Fixing navigation menu...');
      
      // Remove all existing click listeners first
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
        link.replaceWith(link.cloneNode(true));
      });
      
      // Get fresh references after cloning
      const freshNavLinks = document.querySelectorAll('.nav-link');
      
      // Add reliable click handlers
      freshNavLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const sectionId = this.getAttribute('data-section');
          console.log('Navigation clicked:', sectionId);
          
          if (sectionId) {
            // Show the section
            showSection(sectionId);
            
            // Update active navigation
            updateActiveNav(this);
            
            // Load section-specific content
            loadSectionContent(sectionId);
            
            // Close mobile menu if open
            closeMobileMenu();
          }
        });
      });
      
      // Fix mobile menu toggle
      const menuToggle = document.getElementById('menuToggle');
      if (menuToggle) {
        menuToggle.addEventListener('click', function(e) {
          e.stopPropagation();
          toggleMobileMenu();
        });
      }
      
      // Close menu when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('nav') && !e.target.closest('.menu-toggle')) {
          closeMobileMenu();
        }
      });
      
      // Prevent default behavior on all nav links
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('nav-link') || e.target.closest('.nav-link')) {
          e.preventDefault();
        }
      });
    }
    
    // Enhanced showSection function
    function showSection(sectionId) {
      console.log('Showing section:', sectionId);
      
      // Hide all sections
      const sections = document.querySelectorAll('.section');
      sections.forEach(section => {
        section.classList.remove('active');
      });
      
      // Show target section
      const targetSection = document.getElementById(sectionId);
      if (targetSection) {
        targetSection.classList.add('active');
        console.log('Section displayed:', sectionId);
      } else {
        console.error('Section not found:', sectionId);
      }
    }
    
    // Update active navigation
    function updateActiveNav(activeLink) {
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
        link.classList.remove('active');
      });
      activeLink.classList.add('active');
    }
    
    // Load section-specific content
    function loadSectionContent(sectionId) {
      switch(sectionId) {
        case 'dashboard':
          if (typeof loadDashboard === 'function' && currentUser) {
            loadDashboard();
          }
          break;
        case 'browse':
          if (typeof loadStudents === 'function' && currentUser) {
            loadStudents();
          }
          break;
        case 'messages':
          if (typeof loadPersistentConversations === 'function' && currentUser) {
            loadPersistentConversations();
          } else if (typeof loadConversations === 'function' && currentUser) {
            loadConversations();
          }
          break;
        case 'profile':
          if (typeof loadProfile === 'function' && currentUser) {
            loadProfile();
          }
          break;
        case 'timeline':
          if (typeof loadTimelinePosts === 'function' && currentUser) {
            loadTimelinePosts();
          }
          break;
      }
    }
    
    // Mobile menu functions
    function toggleMobileMenu() {
      const navMenu = document.getElementById('navMenu');
      if (navMenu) {
        navMenu.classList.toggle('show');
        console.log('Mobile menu toggled');
      }
    }
    
    function closeMobileMenu() {
      const navMenu = document.getElementById('navMenu');
      if (navMenu) {
        navMenu.classList.remove('show');
      }
    }
    
    // Enhanced navigation for dashboard cards
    function fixDashboardNavigation() {
      const dashboardCards = document.querySelectorAll('.dashboard-cards .card.nav-link');
      dashboardCards.forEach(card => {
        card.addEventListener('click', function(e) {
          e.preventDefault();
          const sectionId = this.getAttribute('data-section');
          if (sectionId && sectionId !== 'home') {
            showSection(sectionId);
            
            // Find and update the corresponding nav link
            const navLink = document.querySelector(`.nav-link[data-section="${sectionId}"]`);
            if (navLink) {
              updateActiveNav(navLink);
            }
            
            loadSectionContent(sectionId);
            closeMobileMenu();
          }
        });
      });
    }
    
    // Handle browser back/forward buttons
    function setupBrowserNavigation() {
      window.addEventListener('popstate', function(event) {
        // Get section from URL hash
        const hash = window.location.hash.replace('#', '');
        if (hash) {
          const navLink = document.querySelector(`.nav-link[data-section="${hash}"]`);
          if (navLink) {
            showSection(hash);
            updateActiveNav(navLink);
            loadSectionContent(hash);
          }
        }
      });
    }
    
    // Update URL without refreshing
    function updateURL(sectionId) {
      if (history.pushState) {
        history.pushState(null, null, `#${sectionId}`);
      } else {
        window.location.hash = `#${sectionId}`;
      }
    }
    
    // Enhanced initialization
    function initEnhancedNavigation() {
      console.log('Initializing enhanced navigation...');
      
      // Fix main navigation
      fixNavigationMenu();
      
      // Fix dashboard navigation
      fixDashboardNavigation();
      
      // Setup browser navigation
      setupBrowserNavigation();
      
      // Enhance existing showSection function
      enhanceShowSection();
      
      // Load current section from URL
      loadFromURL();
      
      console.log('Enhanced navigation initialized');
    }
    
    // Enhance existing showSection function
    function enhanceShowSection() {
      if (window.showSection) {
        const originalShowSection = window.showSection;
        window.showSection = function(sectionId) {
          originalShowSection(sectionId);
          updateURL(sectionId);
          loadSectionContent(sectionId);
        };
      } else {
        window.showSection = function(sectionId) {
          showSection(sectionId);
          updateURL(sectionId);
          loadSectionContent(sectionId);
        };
      }
    }
    
    // Load section from URL
    function loadFromURL() {
      const hash = window.location.hash.replace('#', '');
      if (hash) {
        const navLink = document.querySelector(`.nav-link[data-section="${hash}"]`);
        if (navLink) {
          showSection(hash);
          updateActiveNav(navLink);
          loadSectionContent(hash);
        }
      }
    }
    
    // Add styles for better mobile experience
    function addNavigationStyles() {
      const styles = document.createElement('style');
      styles.textContent = `
        /* Improved mobile navigation */
        @media (max-width: 768px) {
          nav ul {
            transition: all 0.3s ease;
            transform: translateY(-10px);
            opacity: 0;
            height: 0;
            overflow: hidden;
          }
          
          nav ul.show {
            transform: translateY(0);
            opacity: 1;
            height: auto;
          }
          
          .nav-link {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: block;
            transition: background-color 0.3s ease;
          }
          
          .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
          }
          
          .nav-link:active {
            transform: scale(0.98);
          }
        }
        
        /* Smooth transitions for all navigation */
        .nav-link {
          transition: all 0.3s ease;
          cursor: pointer;
        }
        
        .nav-link:hover {
          transform: translateY(-2px);
        }
        
        .dashboard-cards .card {
          transition: all 0.3s ease;
          cursor: pointer;
        }
        
        .dashboard-cards .card:hover {
          transform: translateY(-5px);
        }
        
        .dashboard-cards .card:active {
          transform: translateY(-2px);
        }
        
        /* Active state improvements */
        .nav-link.active {
          background-color: rgba(255, 255, 255, 0.2);
          transform: translateY(-2px);
        }
        
        /* Loading states */
        .section {
          transition: opacity 0.3s ease;
        }
        
        .section.active {
          animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
      `;
      document.head.appendChild(styles);
    }
    
    // Initialize the enhanced navigation
    function startEnhancedNavigation() {
      // Wait for DOM to be fully loaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          addNavigationStyles();
          initEnhancedNavigation();
        });
      } else {
        addNavigationStyles();
        initEnhancedNavigation();
      }
      
      // Also initialize after a short delay to catch dynamic elements
      setTimeout(initEnhancedNavigation, 1000);
    }
    
    // Start the enhanced navigation system
    console.log('Starting enhanced navigation system...');
    startEnhancedNavigation();
    
  })();

     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
// ===== MESSAGE READ RECEIPTS SYSTEM =====

// Track message status (sent, delivered, read)
let messageStatusListeners = {};

// Update message status in Firestore
async function updateMessageStatus(conversationId, messageId, status) {
    try {
        await db.collection('conversations')
            .doc(conversationId)
            .collection('messages')
            .doc(messageId)
            .update({
                status: status,
                statusUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
    } catch (error) {
        console.error('Error updating message status:', error);
    }
}

// Mark messages as read when conversation is opened
async function markMessagesAsRead(conversationId, otherUserId) {
    if (!currentUser || !conversationId) return;
    
    try {
        // Get all unread messages from the other user
        const unreadMessages = await db.collection('conversations')
            .doc(conversationId)
            .collection('messages')
            .where('senderId', '==', otherUserId)
            .where('status', 'in', ['sent', 'delivered'])
            .get();
        
        // Mark each as read
        const batch = db.batch();
        unreadMessages.forEach(doc => {
            const messageRef = db.collection('conversations')
                .doc(conversationId)
                .collection('messages')
                .doc(doc.id);
            
            batch.update(messageRef, {
                status: 'read',
                statusUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                readAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        
        if (unreadMessages.size > 0) {
            await batch.commit();
            console.log(`Marked ${unreadMessages.size} messages as read`);
        }
    } catch (error) {
        console.error('Error marking messages as read:', error);
    }
}

// Add read receipts to message display
function addReadReceiptToMessage(messageElement, messageData) {
    // Remove existing receipt if any
    const existingReceipt = messageElement.querySelector('.message-receipt');
    if (existingReceipt) {
        existingReceipt.remove();
    }
    
    // Only add receipt for sent messages (not received ones)
    if (messageData.senderId === currentUser.uid) {
        const receiptElement = document.createElement('div');
        receiptElement.className = 'message-receipt';
        
        let receiptHTML = '';
        switch (messageData.status) {
            case 'read':
                receiptHTML = `<i class="fas fa-check-double" style="color: var(--primary-color);"></i> Read`;
                break;
            case 'delivered':
                receiptHTML = `<i class="fas fa-check-double"></i> Delivered`;
                break;
            case 'sent':
            default:
                receiptHTML = `<i class="fas fa-check"></i> Sent`;
                break;
        }
        
        receiptElement.innerHTML = receiptHTML;
        receiptElement.style.cssText = `
            font-size: 0.7rem;
            color: #666;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            justify-content: flex-end;
        `;
        
        messageElement.appendChild(receiptElement);
    }
}

// Enhanced message sending with status tracking
async function sendMessageWithStatus(conversationId, otherUserId, messageText) {
    if (!messageText || !conversationId) return;

    try {
        // Add message with initial status
        const messageData = {
            text: messageText,
            senderId: currentUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            status: 'sent', // Initial status
            statusUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const messageRef = await db.collection('conversations')
            .doc(conversationId)
            .collection('messages')
            .add(messageData);
        
        // Update conversation last message
        await db.collection('conversations')
            .doc(conversationId)
            .update({
                lastMessage: messageText,
                lastMessageSender: currentUser.uid,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        // Update status to delivered when the other user is online
        setTimeout(async () => {
            try {
                const otherUserDoc = await db.collection('users').doc(otherUserId).get();
                if (otherUserDoc.exists && otherUserDoc.data().isOnline) {
                    await updateMessageStatus(conversationId, messageRef.id, 'delivered');
                }
            } catch (error) {
                console.error('Error updating to delivered status:', error);
            }
        }, 1000);
        
        return messageRef.id;
    } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Error sending message', 'error');
        return null;
    }
}

// Listen for message status changes
function setupMessageStatusListener(conversationId) {
    if (messageStatusListeners[conversationId]) {
        messageStatusListeners[conversationId](); // Remove existing listener
    }
    
    const listener = db.collection('conversations')
        .doc(conversationId)
        .collection('messages')
        .where('senderId', '==', currentUser.uid)
        .onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === 'modified') {
                    const messageData = change.doc.data();
                    const messageElement = document.querySelector(`[data-message-id="${change.doc.id}"]`);
                    
                    if (messageElement) {
                        addReadReceiptToMessage(messageElement, messageData);
                    }
                }
            });
        });
    
    messageStatusListeners[conversationId] = listener;
}

// Enhanced loadConversation function with read receipts
async function loadConversationWithReceipts(conversationId, otherUserId) {
    const chatHeader = document.getElementById('chatHeader');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    
    // Clean up previous listeners
    if (unsubscribeChat) {
        unsubscribeChat();
    }
    if (messageStatusListeners[conversationId]) {
        messageStatusListeners[conversationId]();
    }
    
    chatMessages.innerHTML = '<div class="spinner"></div>';
    chatInput.style.display = 'none';
    
    try {
        // Get other user's data
        const otherUserDoc = await db.collection('users').doc(otherUserId).get();
        if (!otherUserDoc.exists) {
            chatMessages.innerHTML = '<p style="text-align: center; padding: 2rem;">User not found.</p>';
            return;
        }
        
        const otherUser = otherUserDoc.data();
        chatHeader.innerHTML = `
            <div class="chat-user-info">
                <span>${otherUser.fullName}</span>
                <span class="chat-user-status">${otherUser.isOnline ? 'Online' : 'Offline'}</span>
            </div>
        `;
        
        // Mark messages as read when opening conversation
        await markMessagesAsRead(conversationId, otherUserId);
        
        // Set up real-time listener for messages
        unsubscribeChat = db.collection('conversations')
            .doc(conversationId)
            .collection('messages')
            .orderBy('timestamp', 'asc')
            .onSnapshot((snapshot) => {
                chatMessages.innerHTML = '';
                
                if (snapshot.empty) {
                    chatMessages.innerHTML = '<p style="text-align: center; padding: 2rem;">No messages yet. Start a conversation!</p>';
                } else {
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
                        messageElement.setAttribute('data-message-id', doc.id);
                        
                        const time = message.timestamp ? message.timestamp.toDate() : new Date();
                        const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        messageElement.innerHTML = `
                            <p>${message.text}</p>
                            <div class="message-time">${timeString}</div>
                        `;
                        
                        // Add read receipt for sent messages
                        if (message.senderId === currentUser.uid) {
                            addReadReceiptToMessage(messageElement, message);
                        }
                        
                        chatMessages.appendChild(messageElement);
                    });
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
                // Show chat input
                chatInput.style.display = 'flex';
            });
        
        // Set up message status listener
        setupMessageStatusListener(conversationId);
        
        // Show chat input and set up event listener
        chatInput.dataset.conversationId = conversationId;
        chatInput.dataset.otherUserId = otherUserId;
        
    } catch (error) {
        console.error('Error loading conversation:', error);
        chatMessages.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--error-color);">Error loading conversation.</p>';
    }
}

// Enhanced send message function
document.getElementById('sendMessageBtn').addEventListener('click', async function() {
    const chatInput = document.getElementById('chatInput');
    const messageInput = document.getElementById('messageInput');
    const conversationId = chatInput.dataset.conversationId;
    const otherUserId = chatInput.dataset.otherUserId;
    const messageText = messageInput.value.trim();
    
    if (!messageText || !conversationId) return;
    
    // Disable send button temporarily
    const sendBtn = document.getElementById('sendMessageBtn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        await sendMessageWithStatus(conversationId, otherUserId, messageText);
        messageInput.value = '';
    } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Error sending message', 'error');
    } finally {
        // Re-enable send button
        sendBtn.disabled = false;
        sendBtn.innerHTML = 'Send';
    }
});

// Listen for user online/offline status to update message delivery status
function setupUserStatusListener() {
    if (!currentUser) return;
    
    // Listen for other users' online status
    return db.collection('users')
        .where('uid', '!=', currentUser.uid)
        .onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === 'modified') {
                    const user = change.doc.data();
                    // If user comes online, update delivered messages to read if applicable
                    if (user.isOnline) {
                        updateDeliveredToRead(user.uid);
                    }
                }
            });
        });
}

// Update delivered messages to read when user comes online
async function updateDeliveredToRead(userId) {
    try {
        // Get conversations with this user
        const conversationsSnapshot = await db.collection('conversations')
            .where('participants', 'array-contains', currentUser.uid)
            .get();
        
        for (const doc of conversationsSnapshot.docs) {
            const conversation = doc.data();
            if (conversation.participants.includes(userId)) {
                // Update delivered messages to read
                const deliveredMessages = await db.collection('conversations')
                    .doc(doc.id)
                    .collection('messages')
                    .where('senderId', '==', userId)
                    .where('status', '==', 'delivered')
                    .get();
                
                const batch = db.batch();
                deliveredMessages.forEach(messageDoc => {
                    const messageRef = db.collection('conversations')
                        .doc(doc.id)
                        .collection('messages')
                        .doc(messageDoc.id);
                    
                    batch.update(messageRef, {
                        status: 'read',
                        statusUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        readAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                if (deliveredMessages.size > 0) {
                    await batch.commit();
                }
            }
        }
    } catch (error) {
        console.error('Error updating delivered to read:', error);
    }
}

// Replace the original loadConversation function
const originalLoadConversation = window.loadConversation;
window.loadConversation = function(conversationId, otherUserId) {
    return loadConversationWithReceipts(conversationId, otherUserId);
};

// Replace the original startConversation function to use enhanced version
const originalStartConversation = window.startConversation;
window.startConversation = async function(otherUserId) {
    try {
        // Check if conversation already exists
        const existingConversation = await db.collection('conversations')
            .where('participants', 'array-contains', currentUser.uid)
            .get();
        
        let conversationId = null;
        
        existingConversation.forEach(doc => {
            const conversation = doc.data();
            if (conversation.participants.includes(otherUserId)) {
                conversationId = doc.id;
            }
        });
        
        // Create new conversation if it doesn't exist
        if (!conversationId) {
            const newConversation = {
                participants: [currentUser.uid, otherUserId],
                lastMessage: '',
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            const conversationRef = await db.collection('conversations').add(newConversation);
            conversationId = conversationRef.id;
        }
        
        // Switch to messages section and load the conversation
        showSection('messages');
        updateActiveNav(document.querySelector('[data-section="messages"]'));
        loadConversationWithReceipts(conversationId, otherUserId);
        
    } catch (error) {
        console.error('Error starting conversation:', error);
        showNotification('Error starting conversation', 'error');
    }
};

// Initialize user status listener when user logs in
function initReadReceiptsSystem() {
    if (currentUser) {
        setupUserStatusListener();
    }
}

// Add CSS styles for read receipts
const readReceiptStyles = document.createElement('style');
readReceiptStyles.textContent = `
    .message-receipt {
        font-size: 0.7rem;
        color: #666;
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
        justify-content: flex-end;
    }
    
    .message.sent .message-time {
        margin-bottom: 0;
    }
    
    @media (max-width: 768px) {
        .message-receipt {
            font-size: 0.65rem;
        }
    }
`;
document.head.appendChild(readReceiptStyles);

// Initialize the read receipts system
setTimeout(initReadReceiptsSystem, 2000);
     
     
     
     
     
     
     

     
     
     
     
     
     

     
     
// ===== TYPING INDICATOR SYSTEM =====

// Track typing state and listeners
let typingListeners = {};
let typingTimeouts = {};
let isTyping = false;

// Show typing indicator in chat
function showTypingIndicator(otherUserId, otherUserName) {
    const chatMessages = document.getElementById('chatMessages');
    
    // Remove existing typing indicator
    const existingIndicator = document.getElementById('typing-indicator');
    if (existingIndicator) {
        existingIndicator.remove();
    }
    
    // Create typing indicator
    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.className = 'message received typing-indicator';
    typingIndicator.innerHTML = `
        <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="typing-text">${otherUserName} is typing...</div>
    `;
    
    chatMessages.appendChild(typingIndicator);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Hide typing indicator
function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Send typing start notification
async function startTyping(conversationId, otherUserId) {
    if (!conversationId || !otherUserId) return;
    
    try {
        await db.collection('conversations')
            .doc(conversationId)
            .collection('typing')
            .doc(currentUser.uid)
            .set({
                isTyping: true,
                userId: currentUser.uid,
                userName: userProfile.fullName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        isTyping = true;
    } catch (error) {
        console.error('Error sending typing start:', error);
    }
}

// Send typing stop notification
async function stopTyping(conversationId, otherUserId) {
    if (!conversationId || !otherUserId) return;
    
    try {
        await db.collection('conversations')
            .doc(conversationId)
            .collection('typing')
            .doc(currentUser.uid)
            .delete();
        
        isTyping = false;
    } catch (error) {
        console.error('Error sending typing stop:', error);
    }
}

// Listen for typing indicators from other users
function setupTypingListener(conversationId, otherUserId) {
    if (typingListeners[conversationId]) {
        typingListeners[conversationId](); // Remove existing listener
    }
    
    const listener = db.collection('conversations')
        .doc(conversationId)
        .collection('typing')
        .where('userId', '==', otherUserId)
        .onSnapshot((snapshot) => {
            if (!snapshot.empty) {
                snapshot.forEach(doc => {
                    const typingData = doc.data();
                    if (typingData.isTyping) {
                        showTypingIndicator(otherUserId, typingData.userName);
                        
                        // Clear existing timeout
                        if (typingTimeouts[conversationId]) {
                            clearTimeout(typingTimeouts[conversationId]);
                        }
                        
                        // Set timeout to hide typing indicator after 3 seconds
                        typingTimeouts[conversationId] = setTimeout(() => {
                            hideTypingIndicator();
                        }, 3000);
                    }
                });
            } else {
                // No typing documents found, hide indicator
                hideTypingIndicator();
            }
        });
    
    typingListeners[conversationId] = listener;
}

// Enhanced message input with typing detection
function setupTypingDetection(conversationId, otherUserId) {
    const messageInput = document.getElementById('messageInput');
    let typingTimer;
    let lastTypingTime = 0;
    
    if (!messageInput) return;
    
    // Clear existing event listeners
    const newMessageInput = messageInput.cloneNode(true);
    messageInput.parentNode.replaceChild(newMessageInput, messageInput);
    
    // Setup new event listeners
    newMessageInput.addEventListener('input', function() {
        const currentTime = new Date().getTime();
        
        // Send typing start if not already typing and enough time has passed
        if (!isTyping && (currentTime - lastTypingTime > 1000)) {
            startTyping(conversationId, otherUserId);
        }
        
        lastTypingTime = currentTime;
        
        // Clear existing timer
        clearTimeout(typingTimer);
        
        // Set timer to stop typing after 2 seconds of inactivity
        typingTimer = setTimeout(() => {
            stopTyping(conversationId, otherUserId);
        }, 2000);
    });
    
    // Stop typing when input loses focus
    newMessageInput.addEventListener('blur', function() {
        stopTyping(conversationId, otherUserId);
        clearTimeout(typingTimer);
    });
    
    // Stop typing when message is sent
    const sendButton = document.getElementById('sendMessageBtn');
    if (sendButton) {
        sendButton.addEventListener('click', function() {
            stopTyping(conversationId, otherUserId);
            clearTimeout(typingTimer);
        });
    }
}

// Enhanced loadConversation with typing indicators
async function loadConversationWithTyping(conversationId, otherUserId) {
    const chatHeader = document.getElementById('chatHeader');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    
    // Clean up previous listeners
    if (unsubscribeChat) {
        unsubscribeChat();
    }
    if (messageStatusListeners[conversationId]) {
        messageStatusListeners[conversationId]();
    }
    if (typingListeners[conversationId]) {
        typingListeners[conversationId]();
    }
    
    // Clear typing state
    isTyping = false;
    hideTypingIndicator();
    
    chatMessages.innerHTML = '<div class="spinner"></div>';
    chatInput.style.display = 'none';
    
    try {
        // Get other user's data
        const otherUserDoc = await db.collection('users').doc(otherUserId).get();
        if (!otherUserDoc.exists) {
            chatMessages.innerHTML = '<p style="text-align: center; padding: 2rem;">User not found.</p>';
            return;
        }
        
        const otherUser = otherUserDoc.data();
        chatHeader.innerHTML = `
            <div class="chat-user-info">
                <span>${otherUser.fullName}</span>
                <span class="chat-user-status">${otherUser.isOnline ? 'Online' : 'Offline'}</span>
            </div>
        `;
        
        // Mark messages as read when opening conversation
        await markMessagesAsRead(conversationId, otherUserId);
        
        // Set up real-time listener for messages
        unsubscribeChat = db.collection('conversations')
            .doc(conversationId)
            .collection('messages')
            .orderBy('timestamp', 'asc')
            .onSnapshot((snapshot) => {
                chatMessages.innerHTML = '';
                
                if (snapshot.empty) {
                    chatMessages.innerHTML = '<p style="text-align: center; padding: 2rem;">No messages yet. Start a conversation!</p>';
                } else {
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
                        messageElement.setAttribute('data-message-id', doc.id);
                        
                        const time = message.timestamp ? message.timestamp.toDate() : new Date();
                        const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        messageElement.innerHTML = `
                            <p>${message.text}</p>
                            <div class="message-time">${timeString}</div>
                        `;
                        
                        // Add read receipt for sent messages
                        if (message.senderId === currentUser.uid) {
                            addReadReceiptToMessage(messageElement, message);
                        }
                        
                        chatMessages.appendChild(messageElement);
                    });
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
                // Show chat input
                chatInput.style.display = 'flex';
            });
        
        // Set up message status listener
        setupMessageStatusListener(conversationId);
        
        // Set up typing listener
        setupTypingListener(conversationId, otherUserId);
        
        // Set up typing detection
        setupTypingDetection(conversationId, otherUserId);
        
        // Show chat input and set up event listener
        chatInput.dataset.conversationId = conversationId;
        chatInput.dataset.otherUserId = otherUserId;
        
    } catch (error) {
        console.error('Error loading conversation:', error);
        chatMessages.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--error-color);">Error loading conversation.</p>';
    }
}

// Clean up typing indicators when leaving conversation
function cleanupTyping(conversationId) {
    if (typingListeners[conversationId]) {
        typingListeners[conversationId]();
        delete typingListeners[conversationId];
    }
    
    if (typingTimeouts[conversationId]) {
        clearTimeout(typingTimeouts[conversationId]);
        delete typingTimeouts[conversationId];
    }
    
    // Stop typing if currently typing
    if (isTyping) {
        const chatInput = document.getElementById('chatInput');
        if (chatInput && chatInput.dataset.conversationId && chatInput.dataset.otherUserId) {
            stopTyping(chatInput.dataset.conversationId, chatInput.dataset.otherUserId);
        }
    }
    
    hideTypingIndicator();
    isTyping = false;
}

// Enhanced showSection to clean up typing when leaving messages
const originalShowSection = window.showSection;
window.showSection = function(sectionId) {
    // Clean up typing indicators if leaving messages section
    if (!sectionId.includes('messages')) {
        const chatInput = document.getElementById('chatInput');
        if (chatInput && chatInput.dataset.conversationId) {
            cleanupTyping(chatInput.dataset.conversationId);
        }
    }
    
    originalShowSection(sectionId);
};

// Replace the enhanced loadConversation function with typing support
window.loadConversation = function(conversationId, otherUserId) {
    return loadConversationWithTyping(conversationId, otherUserId);
};

// Add CSS styles for typing indicator
const typingIndicatorStyles = document.createElement('style');
typingIndicatorStyles.textContent = `
    .typing-indicator {
        background: #f0f0f0 !important;
        border-radius: 18px;
        padding: 12px 16px;
        margin-bottom: 8px;
        max-width: 120px;
        animation: fadeIn 0.3s ease;
    }
    
    .typing-dots {
        display: flex;
        align-items: center;
        gap: 4px;
        margin-bottom: 4px;
    }
    
    .typing-dots span {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #666;
        display: inline-block;
        animation: typingBounce 1.3s linear infinite;
    }
    
    .typing-dots span:nth-child(2) {
        animation-delay: 0.15s;
    }
    
    .typing-dots span:nth-child(3) {
        animation-delay: 0.3s;
    }
    
    .typing-text {
        font-size: 0.8rem;
        color: #666;
        font-style: italic;
    }
    
    @keyframes typingBounce {
        0%, 60%, 100% {
            transform: translateY(0);
            opacity: 0.4;
        }
        30% {
            transform: translateY(-5px);
            opacity: 1;
        }
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @media (max-width: 768px) {
        .typing-indicator {
            max-width: 100px;
            padding: 10px 14px;
        }
        
        .typing-text {
            font-size: 0.75rem;
        }
    }
`;
document.head.appendChild(typingIndicatorStyles);

// Initialize typing system cleanup on page unload
window.addEventListener('beforeunload', function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput && chatInput.dataset.conversationId && chatInput.dataset.otherUserId) {
        stopTyping(chatInput.dataset.conversationId, chatInput.dataset.otherUserId);
    }
});

console.log('Typing indicator system loaded');
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     

     
     
     
     
     
     
     
     


     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     

     
     
     
     
     
     
     
     
    

     
     
     
     
     
     
     
     
     
     
     
     
     

  </script>
</body>
</html>
