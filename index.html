<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WCU Dating - Connect with Fellow Students</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        :root {
            --primary-color: #6a1b9a;
            --primary-light: #9c4dcc;
            --primary-dark: #38006b;
            --accent-color: #e1bee7;
            --text-dark: #333;
            --text-light: #fff;
            --bg-light: #f5f5f5;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --success-color: #4caf50;
            --error-color: #f44336;
            --warning-color: #ff9800;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* Header Styles */
        header {
            background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
            color: var(--text-light);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: #ff4081;
            font-size: 1.8rem;
        }

        .logo h1 {
            font-size: 1.5rem;
        }

        /* Navigation */
        nav ul {
            display: flex;
            list-style: none;
            gap: 1.5rem;
        }

        nav a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        nav a:hover, nav a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Main Content */
        main {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            min-height: calc(100vh - 200px);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Section */
        .hero {
            text-align: center;
            padding: 3rem 1rem;
            background: linear-gradient(rgba(106, 27, 154, 0.9), rgba(106, 27, 154, 0.8)), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%236a1b9a"/><text x="50%" y="50%" font-size="20" text-anchor="middle" fill="%23ffffff" font-family="Arial">WCU</text></svg>');
            background-size: cover;
            border-radius: var(--border-radius);
            color: var(--text-light);
            margin-bottom: 2rem;
        }

        .hero h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            color: white;
        }

        .cta-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        /* Form Styles */
        .form-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .form-title {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(106, 27, 154, 0.2);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Button Styles */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            text-decoration: none;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Dashboard */
        .dashboard-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .profile-img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card-img {
            height: 160px;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-img i {
            font-size: 4rem;
            color: white;
        }

        .card-content {
            padding: 1.5rem;
        }

        .card-title {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        /* Browse Students */
        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .filter-toggle {
            display: none;
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
            cursor: pointer;
        }

        .filter-content {
            display: block;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .filter-tag {
            background-color: var(--primary-light);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1rem;
        }

        .student-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .student-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
        }

        .student-card:hover {
            transform: translateY(-5px);
        }

        .student-img {
            height: 200px;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .student-img i {
            font-size: 5rem;
            color: var(--primary-color);
        }

        .student-online {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            background-color: var(--success-color);
            border-radius: 50%;
            border: 2px solid white;
        }

        .student-info {
            padding: 1.5rem;
        }

        .student-name {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-details {
            color: #666;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .student-interests {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .interest-tag {
            background-color: var(--accent-color);
            color: var(--primary-dark);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        /* Messages */
        .messages-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
            height: 500px;
        }

        .conversations-list {
            background: white;
            border-radius: var(--border-radius);
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .conversation {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: var(--transition);
        }

        .conversation:hover, .conversation.active {
            background-color: #f9f9f9;
        }

        .conversation-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            position: relative;
        }

        .conversation-img i {
            color: var(--primary-color);
        }

        .conversation-online {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: var(--success-color);
            border-radius: 50%;
            border: 2px solid white;
        }

        .conversation-info {
            flex: 1;
        }

        .conversation-name {
            font-weight: 500;
        }

        .conversation-preview {
            font-size: 0.875rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .conversation-time {
            font-size: 0.75rem;
            color: #999;
            text-align: right;
        }

        .chat-window {
            background: white;
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chat-user-status {
            font-size: 0.875rem;
            color: #666;
            font-weight: normal;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 70%;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            position: relative;
        }

        .message.received {
            background-color: #f0f0f0;
            align-self: flex-start;
        }

        .message.sent {
            background-color: var(--primary-light);
            color: white;
            align-self: flex-end;
        }

        .message-time {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            opacity: 0.7;
            text-align: right;
        }

        .chat-input {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #eee;
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            border-right: none;
        }

        .chat-input button {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        /* Profile Section */
        .profile-view {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .profile-header {
            position: relative;
            height: 200px;
            background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 2rem;
        }

        .profile-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid white;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            bottom: -75px;
        }

        .profile-avatar i {
            font-size: 4rem;
            color: var(--primary-color);
        }

        .profile-body {
            margin-top: 80px;
            padding: 2rem;
        }

        .profile-name {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .profile-details {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
        }

        .profile-section {
            margin-bottom: 2rem;
        }

        .profile-section-title {
            color: var(--primary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .profile-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .profile-info-item {
            margin-bottom: 1rem;
        }

        .profile-info-label {
            font-weight: 500;
            color: #666;
            margin-bottom: 0.25rem;
        }

        /* Footer */
        footer {
            background: var(--primary-dark);
            color: var(--text-light);
            padding: 2rem 1rem;
            text-align: center;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
            max-width: 350px;
            box-shadow: var(--shadow);
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--error-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #666;
        }

        .empty-state i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            nav ul {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background-color: var(--primary-color);
                padding: 1rem;
                box-shadow: var(--shadow);
            }

            nav ul.show {
                display: flex;
            }

            .menu-toggle {
                display: block;
            }

            .dashboard-header {
                flex-direction: column;
                text-align: center;
            }

            .messages-container {
                grid-template-columns: 1fr;
                grid-template-rows: 200px 1fr;
            }

            .cta-buttons {
                flex-direction: column;
            }

            .filter-toggle {
                display: block;
            }

            .filter-content {
                display: none;
                margin-top: 1rem;
            }

            .filter-content.show {
                display: block;
            }

            .filter-row {
                grid-template-columns: 1fr;
            }

            .profile-header {
                height: 150px;
            }

            .profile-avatar {
                width: 120px;
                height: 120px;
                bottom: -60px;
            }

            .profile-avatar i {
                font-size: 3rem;
            }

            .profile-body {
                margin-top: 70px;
                padding: 1.5rem;
            }
        }

        /* Animation for new messages */
        @keyframes highlight {
            0% { background-color: rgba(106, 27, 154, 0.1); }
            100% { background-color: transparent; }
        }

        .highlight {
            animation: highlight 2s ease;
        }
        
        
/* Enhanced notification styles */
.notification {
    max-width: 400px;
    padding: 15px;
    margin-bottom: 10px;
}

.notification i {
    font-size: 1.5rem;
}

.notification p {
    margin: 5px 0 0 0;
    font-size: 0.9rem;
    opacity: 0.9;
}
        
        
        
        
        
    </style>
</head>
<body>
    <!-- Header with Navigation -->
    <header>
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-heart"></i>
                <h1>WCU Dating</h1>
            </div>
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <nav>
                <ul id="navMenu">
                    <li><a href="#home" class="nav-link active" data-section="home">Home</a></li>
                    <li><a href="#login" class="nav-link" data-section="login" id="loginNav">Login</a></li>
                    <li><a href="#signup" class="nav-link" data-section="signup" id="signupNav">Sign Up</a></li>
                    <li><a href="#dashboard" class="nav-link" data-section="dashboard" id="dashboardNav" style="display:none;">Dashboard</a></li>
                    <li><a href="#browse" class="nav-link" data-section="browse" id="browseNav" style="display:none;">Browse</a></li>
                    <li><a href="#messages" class="nav-link" data-section="messages" id="messagesNav" style="display:none;">Messages</a></li>
                    <li><a href="#profile" class="nav-link" data-section="profile" id="profileNav" style="display:none;">Profile</a></li>
                    <li><a href="#about" class="nav-link" data-section="about">About Us</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <!-- Main Content -->
    <main>
        <!-- Home Section -->
        <section id="home" class="section active">
            <div class="hero">
                <h2>Only for WCU Students <i class="fas fa-heart"></i></h2>
                <p>Connect with fellow Wachemo University students, make friends, and build meaningful relationships in a safe and secure environment.</p>
                <div class="cta-buttons">
                    <a href="#login" class="btn" data-section="login">Login</a>
                    <a href="#signup" class="btn btn-outline" data-section="signup">Sign Up</a>
                </div>
            </div>
            
            <div class="features">
                <h2 style="text-align: center; margin-bottom: 2rem; color: var(--primary-color);">How It Works</h2>
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-img">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Create Profile</h3>
                            <p>Sign up with your WCU student details and create your dating profile.</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-img">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Browse Students</h3>
                            <p>Find other WCU students based on department, interests, and more.</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-img">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Connect & Chat</h3>
                            <p>Start conversations and build meaningful connections.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Login Section -->
        <section id="login" class="section">
            <div class="form-container">
                <h2 class="form-title">Login to Your Account</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">
                        <span id="loginBtnText">Login</span>
                        <div id="loginSpinner" class="spinner" style="display: none;"></div>
                    </button>
                </form>
                <p style="text-align: center; margin-top: 1.5rem;">
                    Don't have an account? <a href="#signup" class="nav-link" data-section="signup" style="color: var(--primary-color);">Sign Up now</a>
                </p>
            </div>
        </section>

        <!-- Sign Up Section -->
        <section id="signup" class="section">
            <div class="form-container">
                <h2 class="form-title">Create Your WCU Dating Profile</h2>
                <form id="signupForm">
                    <div class="form-group">
                        <label for="fullName">Full Name</label>
                        <input type="text" id="fullName" class="form-control" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="studentId">Student ID</label>
                        <input type="text" id="studentId" class="form-control" placeholder="Enter your WCU student ID" required>
                    </div>
                    <div class="form-group">
                        <label for="department">Department / Faculty</label>
                        <select id="department" class="form-control" required>
                            <option value="">Select Department</option>
                            <option value="Civil Engineering">Civil Engineering</option>
                            <option value="Hydraulic and Water Resource Engineering">Hydraulic and Water Resource Engineering</option>
                            <option value="Architecture">Architecture</option>
                            <option value="Chemical Engineering">Chemical Engineering</option>
                            <option value="Construction Technology and Management">Construction Technology and Management</option>
                            <option value="Electrical and Computer Engineering">Electrical and Computer Engineering</option>
                            <option value="Electro-Mechanical Engineering">Electro-Mechanical Engineering</option>
                            <option value="Surveying Engineering">Surveying Engineering</option>
                            <option value="Information Systems">Information Systems</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Mechanical Engineering">Mechanical Engineering</option>
                            <option value="Software Engineering">Software Engineering</option>
                            <option value="Biomedical Engineering">Biomedical Engineering</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Statistics">Statistics</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                            <option value="Biotechnology">Biotechnology</option>
                            <option value="Geology">Geology</option>
                            <option value="Sport Science">Sport Science</option>
                            <option value="Industrial Chemistry">Industrial Chemistry</option>
                            <option value="Medicine">Medicine</option>
                            <option value="Anesthesia">Anesthesia</option>
                            <option value="Midwifery">Midwifery</option>
                            <option value="Comprehensive Nursing">Comprehensive Nursing</option>
                            <option value="Public Health">Public Health</option>
                            <option value="Health Informatics">Health Informatics</option>
                            <option value="Medical Laboratory Technology">Medical Laboratory Technology</option>
                            <option value="Pharmacy">Pharmacy</option>
                            <option value="Surgical Nursing (Post Basic)">Surgical Nursing (Post Basic)</option>
                            <option value="Pediatrics & Child Health Nursing (Post Basic)">Pediatrics & Child Health Nursing (Post Basic)</option>
                            <option value="Dental Medicine">Dental Medicine</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="year">Year of Study</label>
                        <select id="year" class="form-control" required>
                            <option value="">Select Year</option>
                            <option value="Remedial">Remedial</option>
                            <option value="1st">1st Year</option>
                            <option value="2nd">2nd Year</option>
                            <option value="3rd">3rd Year</option>
                            <option value="4th">4th Year</option>
                            <option value="5th">5th Year</option>
                            <option value="6th">6th Year</option>
                            <option value="7th">7th Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <select id="gender" class="form-control" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lookingFor">Looking For</label>
                        <select id="lookingFor" class="form-control" required>
                            <option value="">Select What You're Looking For</option>
                            <option value="Friendship">Friendship</option>
                            <option value="Relationship">Relationship</option>
                            <option value="Study Partner">Study Partner</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="maritalStatus">Marital Status</label>
                        <select id="maritalStatus" class="form-control" required>
                            <option value="">Select Marital Status</option>
                            <option value="Single">Single</option>
                            <option value="Married">Married</option>
                            <option value="Divorced">Divorced</option>
                            <option value="Widowed">Widowed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="relationshipExp">Past Relationship Experience</label>
                        <select id="relationshipExp" class="form-control" required>
                            <option value="">Select Experience</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="religion">Religion</label>
                        <select id="religion" class="form-control" required>
                            <option value="">Select Religion</option>
                            <option value="Ethiopian Orthodox">Ethiopian Orthodox</option>
                            <option value="Protestant">Protestant</option>
                            <option value="Catholic">Catholic</option>
                            <option value="Islam">Islam</option>
                            <option value="Judaism">Judaism</option>
                            <option value="Traditional/Indigenous">Traditional/Indigenous</option>
                            <option value="Other">Other</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="personality">Personality Type</label>
                        <select id="personality" class="form-control" required>
                            <option value="">Select Personality Type</option>
                            <option value="Introvert">Introvert</option>
                            <option value="Extrovert">Extrovert</option>
                            <option value="Ambivert">Ambivert</option>
                            <option value="Not sure">Not sure</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="interests">Interests (comma separated)</label>
                        <input type="text" id="interests" class="form-control" placeholder="e.g., Reading, Sports, Music">
                    </div>
                    <div class="form-group">
                        <label for="bio">About Me / Bio</label>
                        <textarea id="bio" class="form-control" placeholder="Tell others about yourself..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="profilePhoto">Profile Photo</label>
                        <input type="file" id="profilePhoto" class="form-control" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-control" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="tel" id="phone" class="form-control" placeholder="Enter your phone number">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" class="form-control" placeholder="Create a password" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm your password" required>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">
                        <span id="signupBtnText">Register</span>
                        <div id="signupSpinner" class="spinner" style="display: none;"></div>
                    </button>
                </form>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard" class="section">
            <div class="dashboard-header">
                <div class="profile-img-container">
                    <img id="dashboardProfileImg" class="profile-img" src="" alt="Profile Image" onerror="this.style.display='none';">
                    <div id="dashboardProfilePlaceholder" class="profile-img" style="background-color: #e1bee7; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user" style="font-size: 2.5rem; color: var(--primary-color);"></i>
                    </div>
                </div>
                <div>
                    <h2 id="dashboardWelcome">Welcome, Student!</h2>
                    <p id="dashboardDetails">Department, Year</p>
                    <p id="dashboardBio">"Bio will appear here."</p>
                </div>
            </div>

            <div class="dashboard-cards">
                <div class="card nav-link" data-section="browse">
                    <div class="card-img">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">Browse Students</h3>
                        <p>Find other WCU students to connect with</p>
                    </div>
                </div>
                <div class="card nav-link" data-section="messages">
                    <div class="card-img">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">Messages</h3>
                        <p>Check your conversations</p>
                    </div>
                </div>
                <div class="card nav-link" data-section="profile">
                    <div class="card-img">
                        <i class="fas fa-user-edit"></i>
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">My Profile</h3>
                        <p>View and edit your profile</p>
                    </div>
                </div>
                <div class="card nav-link" data-section="home" id="logoutBtn">
                    <div class="card-img">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">Logout</h3>
                        <p>Sign out of your account</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Browse Students Section -->
        <section id="browse" class="section">
            <h2 style="margin-bottom: 1.5rem; color: var(--primary-color);">Browse WCU Students</h2>
            
            <div class="filters">
                <div class="filter-header">
                    <h3>Filters</h3>
                    <button class="filter-toggle" id="filterToggle">
                        <i class="fas fa-filter"></i> Filters
                    </button>
                </div>
                
                
<div class="filter-content" id="filterContent">
    <div class="filter-row">
        <div class="form-group">
            <label for="filterDepartment">Department</label>
            <select id="filterDepartment" class="form-control">
                <option value="">All Departments</option>
                <option value="Civil Engineering">Civil Engineering</option>
                <option value="Hydraulic and Water Resource Engineering">Hydraulic and Water Resource Engineering</option>
                <option value="Architecture">Architecture</option>
                <option value="Chemical Engineering">Chemical Engineering</option>
                <option value="Construction Technology and Management">Construction Technology and Management</option>
                <option value="Electrical and Computer Engineering">Electrical and Computer Engineering</option>
                <option value="Electro-Mechanical Engineering">Electro-Mechanical Engineering</option>
                <option value="Surveying Engineering">Surveying Engineering</option>
                <option value="Information Systems">Information Systems</option>
                <option value="Information Technology">Information Technology</option>
                <option value="Mechanical Engineering">Mechanical Engineering</option>
                <option value="Software Engineering">Software Engineering</option>
                <option value="Biomedical Engineering">Biomedical Engineering</option>
                <option value="Mathematics">Mathematics</option>
                <option value="Statistics">Statistics</option>
                <option value="Physics">Physics</option>
                <option value="Chemistry">Chemistry</option>
                <option value="Biology">Biology</option>
                <option value="Biotechnology">Biotechnology</option>
                <option value="Geology">Geology</option>
                <option value="Sport Science">Sport Science</option>
                <option value="Industrial Chemistry">Industrial Chemistry</option>
                <option value="Medicine">Medicine</option>
                <option value="Anesthesia">Anesthesia</option>
                <option value="Midwifery">Midwifery</option>
                <option value="Comprehensive Nursing">Comprehensive Nursing</option>
                <option value="Public Health">Public Health</option>
                <option value="Health Informatics">Health Informatics</option>
                <option value="Medical Laboratory Technology">Medical Laboratory Technology</option>
                <option value="Pharmacy">Pharmacy</option>
                <option value="Surgical Nursing (Post Basic)">Surgical Nursing (Post Basic)</option>
                <option value="Pediatrics & Child Health Nursing (Post Basic)">Pediatrics & Child Health Nursing (Post Basic)</option>
                <option value="Dental Medicine">Dental Medicine</option>
            </select>
        </div>
        <div class="form-group">
            <label for="filterYear">Year</label>
            <select id="filterYear" class="form-control">
                <option value="">All Years</option>
                <option value="Remedial">Remedial</option>
                <option value="1st">1st Year</option>
                <option value="2nd">2nd Year</option>
                <option value="3rd">3rd Year</option>
                <option value="4th">4th Year</option>
                <option value="5th">5th Year</option>
                <option value="6th">6th Year</option>
                <option value="7th">7th Year</option>
            </select>
        </div>
    </div>
    <button type="button" class="btn" id="applyFilters">Apply Filters</button>
    <button type="button" class="btn btn-outline" id="clearFilters" style="margin-left: 10px;">Clear Filters</button>
</div>
                
                

                <div class="filter-tags" id="filterTags" style="display: none;">
                    <!-- Active filters will appear here -->
                </div>
            </div>

            <div id="studentsContainer" class="student-cards">
                <div class="spinner" id="browseSpinner"></div>
            </div>
        </section>

        <!-- Messages Section -->
        <section id="messages" class="section">
            <h2 style="margin-bottom: 1.5rem; color: var(--primary-color);">Messages</h2>
            
            <div class="messages-container">
                <div class="conversations-list" id="conversationsList">
                    <div class="spinner"></div>
                </div>
                
                <div class="chat-window">
                    <div class="chat-header" id="chatHeader">
                        <div class="chat-user-info">
                            <span>Select a conversation</span>
                            <span class="chat-user-status"></span>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <p style="text-align: center; color: #666; padding: 2rem;">Select a conversation to start messaging</p>
                    </div>
                    <div class="chat-input" style="display: none;" id="chatInput">
                        <input type="text" id="messageInput" placeholder="Type your message here...">
                        <button class="btn" id="sendMessageBtn">Send</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Profile Section -->
        <section id="profile" class="section">
            <h2 style="margin-bottom: 1.5rem; color: var(--primary-color);">My Profile</h2>
            
            <div class="form-container">
                <form id="profileForm">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <img id="profilePhotoPreview" class="profile-img" src="" alt="Profile Photo" onerror="this.style.display='none';" style="width: 150px; height: 150px; margin: 0 auto;">
                        <div id="profilePhotoPlaceholder" class="profile-img" style="width: 150px; height: 150px; margin: 0 auto; background-color: #e1bee7; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user" style="font-size: 4rem; color: var(--primary-color);"></i>
                        </div>
                        <input type="file" id="profilePhotoUpload" accept="image/*" style="display: none;">
                        <button type="button" class="btn" style="margin-top: 1rem;" id="changePhotoBtn">Change Photo</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="profileName">Full Name</label>
                        <input type="text" id="profileName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="profileStudentId">Student ID</label>
                        <input type="text" id="profileStudentId" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="profileDepartment">Department / Faculty</label>
                        <select id="profileDepartment" class="form-control">
                            <option value="">Select Department</option>
                            <option value="Civil Engineering">Civil Engineering</option>
                            <option value="Hydraulic and Water Resource Engineering">Hydraulic and Water Resource Engineering</option>
                            <option value="Architecture">Architecture</option>
                            <option value="Chemical Engineering">Chemical Engineering</option>
                            <option value="Construction Technology and Management">Construction Technology and Management</option>
                            <option value="Electrical and Computer Engineering">Electrical and Computer Engineering</option>
                            <option value="Electro-Mechanical Engineering">Electro-Mechanical Engineering</option>
                            <option value="Surveying Engineering">Surveying Engineering</option>
                            <option value="Information Systems">Information Systems</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Mechanical Engineering">Mechanical Engineering</option>
                            <option value="Software Engineering">Software Engineering</option>
                            <option value="Biomedical Engineering">Biomedical Engineering</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Statistics">Statistics</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                            <option value="Biotechnology">Biotechnology</option>
                            <option value="Geology">Geology</option>
                            <option value="Sport Science">Sport Science</option>
                            <option value="Industrial Chemistry">Industrial Chemistry</option>
                            <option value="Medicine">Medicine</option>
                            <option value="Anesthesia">Anesthesia</option>
                            <option value="Midwifery">Midwifery</option>
                            <option value="Comprehensive Nursing">Comprehensive Nursing</option>
                            <option value="Public Health">Public Health</option>
                            <option value="Health Informatics">Health Informatics</option>
                            <option value="Medical Laboratory Technology">Medical Laboratory Technology</option>
                            <option value="Pharmacy">Pharmacy</option>
                            <option value="Surgical Nursing (Post Basic)">Surgical Nursing (Post Basic)</option>
                            <option value="Pediatrics & Child Health Nursing (Post Basic)">Pediatrics & Child Health Nursing (Post Basic)</option>
                            <option value="Dental Medicine">Dental Medicine</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="profileYear">Year of Study</label>
                        <select id="profileYear" class="form-control">
                            <option value="">Select Year</option>
                            <option value="Remedial">Remedial</option>
                            <option value="1st">1st Year</option>
                            <option value="2nd">2nd Year</option>
                            <option value="3rd">3rd Year</option>
                            <option value="4th">4th Year</option>
                            <option value="5th">5th Year</option>
                            <option value="6th">6th Year</option>
                            <option value="7th">7th Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="profileInterests">Interests (comma separated)</label>
                        <input type="text" id="profileInterests" class="form-control" placeholder="e.g., Reading, Sports, Music">
                    </div>
                    <div class="form-group">
                        <label for="profileBio">About Me / Bio</label>
                        <textarea id="profileBio" class="form-control"></textarea>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">
                        <span id="updateProfileBtnText">Update Profile</span>
                        <div id="updateProfileSpinner" class="spinner" style="display: none;"></div>
                    </button>
                </form>
            </div>
        </section>

        <!-- About Us Section -->
        <section id="about" class="section">
            <div class="form-container">
                <h2 class="form-title">About WCU Dating</h2>
                <p style="text-align: center; margin-bottom: 2rem;">
                    This site is specially built for WCU students to connect, make friends, and build meaningful relationships.
                </p>
                
                <div style="background-color: #f9f9f9; padding: 1.5rem; border-radius: var(--border-radius);">
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Developer Information</h3>
                    <p><strong>Developed by:</strong> Yoseph Abebe Ersedo</p>
                    <p><strong>University:</strong> Wachemo University</p>
                    <p><strong>Department:</strong> Information Systems</p>
                    <p><strong>Year:</strong> 2025</p>
                    <p><strong>Email:</strong> jossyabebe92@gmail.com</p>
                </div>
                
                <div style="margin-top: 2rem;">
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Mission</h3>
                    <p>Our mission is to provide a safe and secure platform for Wachemo University students to connect with each other, form study groups, make new friends, and build meaningful relationships within the university community.</p>
                    
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem; margin-top: 1.5rem;">Privacy & Safety</h3>
                    <p>We prioritize your privacy and safety. All profiles are verified through WCU student IDs, and we have strict guidelines against inappropriate behavior. Your personal information is never shared with third parties.</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Wachemo University Dating Site. All rights reserved.</p>
            <p>For WCU students only. Verification required.</p>
        </div>
    </footer>

    <script>
        // Firebase configuration - Replace with your own config
        const firebaseConfig = {
            apiKey: "AIzaSyB59sLUXNafCd7AHhT1-t9ex7ow9fRr4rQ",
            authDomain: "wcu-dating-5decd.firebaseapp.com",
            projectId: "wcu-dating-5decd",
            storageBucket: "wcu-dating-5decd.firebasestorage.app",
            messagingSenderId: "240008579483",
            appId: "1:240008579483:web:ec969a34a8b41b22c3393e",
            measurementId: "G-T4EHB92656"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Current user data
        let currentUser = null;
        let userProfile = null;
        let unsubscribeChat = null;
        let activeFilters = {};

        // Navigation functionality
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');
        const menuToggle = document.getElementById('menuToggle');
        const navMenu = document.getElementById('navMenu');
        
        // Handle navigation clicks
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const sectionId = this.getAttribute('data-section');
                showSection(sectionId);
                updateActiveNav(this);
                
                // Close mobile menu after selection
                if (window.innerWidth <= 768) {
                    navMenu.classList.remove('show');
                }
            });
        });
        
        // Mobile menu toggle
        menuToggle.addEventListener('click', function() {
            navMenu.classList.toggle('show');
        });
        
        // Show the specified section and hide others
        function showSection(sectionId) {
            // Clean up any real-time listeners when leaving messages
            if (unsubscribeChat && !sectionId.includes('messages')) {
                unsubscribeChat();
                unsubscribeChat = null;
            }
            
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // Load section-specific data
            if (sectionId === 'dashboard' && currentUser) {
                loadDashboard();
            } else if (sectionId === 'browse' && currentUser) {
                loadStudents();
            } else if (sectionId === 'profile' && currentUser) {
                loadProfile();
            } else if (sectionId === 'messages' && currentUser) {
                loadConversations();
            }
        }
        
        // Update active navigation link
        
// Update active navigation link
function updateActiveNav(activeLink) {
    navLinks.forEach(link => {
        link.classList.remove('active');
    });
    activeLink.classList.add('active');
}

// Add this function to load user profile from Firestore
async function loadUserProfile(uid) {
    try {
        const userDoc = await db.collection('users').doc(uid).get();
        if (userDoc.exists) {
            userProfile = userDoc.data();
            return userProfile;
        }
        return null;
    } catch (error) {
        console.error('Error loading user profile:', error);
        return null;
    }
}

// Show notification
function showNotification(message, type) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type} show`;
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}
        
        
        
        // Toggle loading state for buttons
        function toggleButtonLoading(buttonId, isLoading) {
            const btnText = document.getElementById(`${buttonId}BtnText`);
            const spinner = document.getElementById(`${buttonId}Spinner`);
            
            if (isLoading) {
                btnText.style.display = 'none';
                spinner.style.display = 'block';
            } else {
                btnText.style.display = 'block';
                spinner.style.display = 'none';
            }
        }
        
        // Handle login functionality
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Simple validation
            if (!email || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            toggleButtonLoading('login', true);
            
            try {
                // Sign in with Firebase Authentication
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Get user profile from Firestore
                


           
// Get user profile using the new function
userProfile = await loadUserProfile(currentUser.uid);

if (userProfile) {
    showNotification('Login successful!', 'success');
    
    // Update user online status
    await db.collection('users').doc(currentUser.uid).update({
        isOnline: true,
        lastSeen: new Date()
    });
    
setupMessageListeners();
    
    // Update navigation
    updateNavigation(true);
    
    // Show dashboard
    showSection('dashboard');
    updateActiveNav(document.querySelector('[data-section="dashboard"]'));
} else {
    // If profile doesn't exist, create a basic one
    showNotification('Creating your profile...', 'warning');
    
    const userProfileData = {
        uid: currentUser.uid,
        email: currentUser.email,
        fullName: currentUser.displayName || "New User",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        isOnline: true,
        lastSeen: new Date()
    };
    
    await db.collection('users').doc(currentUser.uid).set(userProfileData);
    userProfile = userProfileData;
    
    showNotification('Profile created successfully!', 'success');
    
    // Update navigation
    updateNavigation(true);
    
    // Show dashboard
    showSection('dashboard');
    updateActiveNav(document.querySelector('[data-section="dashboard"]'));
}
           
                
                
                
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification(error.message, 'error');
            } finally {
                toggleButtonLoading('login', false);
            }
        });
        
        // Handle signup functionality
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const fullName = document.getElementById('fullName').value;
            const studentId = document.getElementById('studentId').value;
            const department = document.getElementById('department').value;
            const year = document.getElementById('year').value;
            const gender = document.getElementById('gender').value;
            const lookingFor = document.getElementById('lookingFor').value;
            const maritalStatus = document.getElementById('maritalStatus').value;
            const relationshipExp = document.getElementById('relationshipExp').value;
            const religion = document.getElementById('religion').value;
            const personality = document.getElementById('personality').value;
            const interests = document.getElementById('interests').value;
            const bio = document.getElementById('bio').value;
            const phone = document.getElementById('phone').value;
            const profilePhoto = document.getElementById('profilePhoto').files[0];
            
            // Validation
            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            toggleButtonLoading('signup', true);
            
            
try {
    // Create user with Firebase Authentication
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    currentUser = userCredential.user;
    
    console.log('User created in Authentication:', currentUser.uid);
    
    let photoURL = null;
    // Upload profile photo if selected
    if (profilePhoto) {
        console.log('Uploading profile photo...');
        try {
            const storageRef = storage.ref();
            const photoRef = storageRef.child(`profile_photos/${currentUser.uid}`);
            await photoRef.put(profilePhoto);
            photoURL = await photoRef.getDownloadURL();
            console.log('Profile photo uploaded:', photoURL);
        } catch (photoError) {
            console.error('Profile photo upload failed:', photoError);
            showNotification('Profile photo upload failed, but account was created', 'warning');
        }
    }
    
    // Create user profile in Firestore
    const userProfileData = {
        uid: currentUser.uid,
        email: email,
        fullName: fullName,
        studentId: studentId,
        department: department,
        year: year,
        gender: gender,
        lookingFor: lookingFor,
        maritalStatus: maritalStatus,
        relationshipExp: relationshipExp,
        religion: religion,
        personality: personality,
        interests: interests.split(',').map(item => item.trim()).filter(item => item !== ''),
        bio: bio,
        phone: phone || '',
        photoURL: photoURL,
        isOnline: true,
        lastSeen: new Date(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
await db.collection('users').doc(currentUser.uid).set(userProfileData);
    
    
    console.log('Creating user profile in Firestore:', userProfileData);
    
    // CREATE PROFILE IN FIRESTORE
    await db.collection('users').doc(currentUser.uid).set(userProfileData);
    
    console.log('User profile created successfully in Firestore');
    

    

// Wait a moment for Firestore to process the profile creation
await new Promise(resolve => setTimeout(resolve, 1000));

// Load the profile to verify it was created
userProfile = await loadUserProfile(currentUser.uid);

if (userProfile) {
    showNotification('Registration successful!', 'success');
    
    // Load dashboard first to ensure data is available
    if (typeof loadDashboard === 'function') {
        loadDashboard();
    }
    
    // Update navigation (this should happen after data is loaded)
    updateNavigation(true);
    
    // Show dashboard
    showSection('dashboard');
    updateActiveNav(document.querySelector('[data-section="dashboard"]'));
} else {
    // Sometimes Firestore takes a moment to be consistent across regions
    // Let's try one more time after a short delay
    await new Promise(resolve => setTimeout(resolve, 2000));
    userProfile = await loadUserProfile(currentUser.uid);
    
    if (userProfile) {
        showNotification('Registration successful!', 'success');
        if (typeof loadDashboard === 'function') loadDashboard();
        updateNavigation(true);
        showSection('dashboard');
        updateActiveNav(document.querySelector('[data-section="dashboard"]'));
    } else {
        // If it still doesn't exist after waiting, show a different message
        showNotification('Registration completed! Your profile is being processed.', 'success');
        if (typeof loadDashboard === 'function') loadDashboard();
        updateNavigation(true);
        showSection('dashboard');
        updateActiveNav(document.querySelector('[data-section="dashboard"]'));
    }
}
    
    
    
} catch (error) {
    console.error('Signup error:', error);
    showNotification(error.message, 'error');
    
    // Delete user if profile creation failed
    if (currentUser) {
        try {
            await currentUser.delete();
            console.log('User deleted from Authentication due to profile creation failure');
        } catch (deleteError) {
            console.error('Error deleting user:', deleteError);
        }
        currentUser = null;
    }


} finally {
toggleButtonLoading('signup', false);
}

}); // ← This should be the closing of the signup event handler


// Load dashboard data
async function loadDashboard() {
    if (!currentUser) return;
    
    try {
        // Make sure we have the latest profile data
        userProfile = await loadUserProfile(currentUser.uid);
        
        if (userProfile) {
            document.getElementById('dashboardWelcome').textContent = `Welcome, ${userProfile.fullName || 'Student'}!`;
            document.getElementById('dashboardDetails').textContent = `${userProfile.department || 'Department'}, ${userProfile.year || 'Year'}`;
            document.getElementById('dashboardBio').textContent = `"${userProfile.bio || 'No bio yet.'}"`;
            
            // Load profile image if available
            if (userProfile.photoURL) {
                document.getElementById('dashboardProfileImg').src = userProfile.photoURL;
                document.getElementById('dashboardProfileImg').style.display = 'block';
                document.getElementById('dashboardProfilePlaceholder').style.display = 'none';
            } else {
                document.getElementById('dashboardProfileImg').style.display = 'none';
                document.getElementById('dashboardProfilePlaceholder').style.display = 'flex';
            }
        } else {
            // If profile doesn't exist yet, show generic message
            document.getElementById('dashboardWelcome').textContent = 'Welcome, Student!';
            document.getElementById('dashboardDetails').textContent = 'Department, Year';
            document.getElementById('dashboardBio').textContent = '"Complete your profile to get started."';
        }
    } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('dashboardWelcome').textContent = 'Welcome!';
        document.getElementById('dashboardDetails').textContent = 'Error loading profile';
        document.getElementById('dashboardBio').textContent = '"Please try refreshing the page."';
    }
}




// Load students for browsing with filters
async function loadStudents() {
const studentsContainer = document.getElementById('studentsContainer');
studentsContainer.innerHTML = '<div class="spinner" id="browseSpinner"></div>';

try {
let query = db.collection('users').where('uid', '!=', currentUser.uid);

// Apply filters if any - FIXED VERSION
if (activeFilters.department) {
query = query.where('department', '==', activeFilters.department);
}

if (activeFilters.year) {
query = query.where('year', '==', activeFilters.year);
}

const usersSnapshot = await query.get();



                studentsContainer.innerHTML = '';
                
                if (usersSnapshot.empty) {
                    studentsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No students found</h3>
                            <p>Try adjusting your filters to see more results</p>
                        </div>
                    `;
                    return;
                }
                
                usersSnapshot.forEach(doc => {
                    const student = doc.data();
                    const studentCard = document.createElement('div');
                    studentCard.className = 'student-card';
                    
                    // Create interest tags
                    let interestTags = '';
                    if (student.interests && student.interests.length > 0) {
                        student.interests.slice(0, 4).forEach(interest => {
                            interestTags += `<span class="interest-tag">${interest}</span>`;
                        });
                        if (student.interests.length > 4) {
                            interestTags += `<span class="interest-tag">+${student.interests.length - 4} more</span>`;
                        }
                    }
                    
                    studentCard.innerHTML = `
                        <div class="student-img">
                            ${student.photoURL ? 
                                `<img src="${student.photoURL}" alt="${student.fullName}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                `<i class="fas fa-user"></i>`
                            }
                            <div class="student-online" style="display: ${student.isOnline ? 'block' : 'none'}"></div>
                        </div>
                        <div class="student-info">
                            <div class="student-name">
                                <span>${student.fullName}</span>
                                <span>${student.year}</span>
                            </div>
                            <div class="student-details">
                                <p><strong>Department:</strong> ${student.department}</p>
                                <p><strong>Looking for:</strong> ${student.lookingFor}</p>
                            </div>
                            ${interestTags ? `<div class="student-interests">${interestTags}</div>` : ''}
                            <button class="btn" style="width: 100%;" onclick="startConversation('${student.uid}')">Send Message</button>
                        </div>
                    `;
                    
                    studentsContainer.appendChild(studentCard);
                });
            } catch (error) {
                console.error('Error loading students:', error);
                studentsContainer.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--error-color);">Error loading students.</p>';
            }
        }
        
// Load user profile
async function loadProfile() {
    if (!currentUser) return;
    
    try {
        // Make sure we have the latest profile data
        userProfile = await loadUserProfile(currentUser.uid);
        
        if (userProfile) {
            document.getElementById('profileName').value = userProfile.fullName || '';
            document.getElementById('profileStudentId').value = userProfile.studentId || '';
            document.getElementById('profileDepartment').value = userProfile.department || '';
            document.getElementById('profileYear').value = userProfile.year || '';
            document.getElementById('profileInterests').value = userProfile.interests ? userProfile.interests.join(', ') : '';
            document.getElementById('profileBio').value = userProfile.bio || '';
            
            // Load profile image if available
            if (userProfile.photoURL) {
                document.getElementById('profilePhotoPreview').src = userProfile.photoURL;
                document.getElementById('profilePhotoPreview').style.display = 'block';
                document.getElementById('profilePhotoPlaceholder').style.display = 'none';
            } else {
                document.getElementById('profilePhotoPreview').style.display = 'none';
                document.getElementById('profilePhotoPlaceholder').style.display = 'flex';
            }
        } else {
            showNotification('Could not load profile data', 'error');
        }
    } catch (error) {
        console.error('Error loading profile:', error);
        showNotification('Error loading profile', 'error');
    }
}
        
        
        
        
        
// Update profile
document.getElementById('profileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!currentUser) return;
    
    const fullName = document.getElementById('profileName').value;
    const department = document.getElementById('profileDepartment').value;
    const year = document.getElementById('profileYear').value;
    const interests = document.getElementById('profileInterests').value;
    const bio = document.getElementById('profileBio').value;
    const profilePhoto = document.getElementById('profilePhotoUpload').files[0];
    
    toggleButtonLoading('updateProfile', true);
    
    try {
        let updates = {
            fullName: fullName,
            department: department,
            year: year,
            interests: interests.split(',').map(item => item.trim()).filter(item => item !== ''),
            bio: bio,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        
        
// Upload new profile photo if selected
if (profilePhoto) {
    // Check file size (max 2MB)
    if (profilePhoto.size > 2 * 1024 * 1024) {
        showNotification('Please select an image smaller than 2MB', 'error');
        toggleButtonLoading('updateProfile', false);
        return;
    }
    
    console.log('Uploading profile photo...', profilePhoto);
    
    try {
        const storageRef = storage.ref();
        const photoRef = storageRef.child(`profile_photos/${currentUser.uid}`);
        
        console.log('Storage reference created');
        
        // Simple upload with detailed error handling
        const snapshot = await photoRef.put(profilePhoto);
        console.log('Upload completed, snapshot:', snapshot);
        
        // Get download URL
        const downloadURL = await photoRef.getDownloadURL();
        console.log('Download URL obtained:', downloadURL);
        
        updates.photoURL = downloadURL;
        console.log('Photo uploaded successfully, URL:', updates.photoURL);
        
    } catch (uploadError) {
        console.error('Photo upload failed with details:', uploadError);
        console.error('Error code:', uploadError.code);
        console.error('Error message:', uploadError.message);
        
        // Check specific error types
        if (uploadError.code === 'storage/unauthorized') {
            showNotification('Photo upload failed: Storage permissions error', 'error');
        } else if (uploadError.code === 'storage/unknown') {
            showNotification('Photo upload failed: Network error', 'error');
        } else {
            showNotification('Photo upload failed: ' + uploadError.message, 'error');
        }
        
        // Continue with profile update without the photo
    }
}
        

        
        // Update user profile in Firestore
        
// Debug logging
console.log('Updating profile with data:', updates);
console.log('Current user UID:', currentUser.uid);

// Update user profile in Firestore
await db.collection('users').doc(currentUser.uid).update(updates);
        
        
        // Refresh the user profile from Firestore to get the latest data
        
        
// Refresh the user profile from Firestore to get the latest data
userProfile = await loadUserProfile(currentUser.uid);

if (userProfile) {
    showNotification('Profile updated successfully!', 'success');
    
    // Reload ALL sections that display profile data
    if (typeof loadDashboard === 'function') {
        loadDashboard();
    }
    if (typeof loadProfile === 'function') {
        loadProfile();
    }
} else {
    showNotification('Profile update failed', 'error');
}
        
        
        
        
    } catch (error) {
        console.error('Error updating profile:', error);
        showNotification(error.message, 'error');
    } finally {
        toggleButtonLoading('updateProfile', false);
    }
});
        
        
        
        
        // Change profile photo button
        document.getElementById('changePhotoBtn').addEventListener('click', function() {
            document.getElementById('profilePhotoUpload').click();
        });
        
        // Profile photo preview
        document.getElementById('profilePhotoUpload').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profilePhotoPreview').src = e.target.result;
                    document.getElementById('profilePhotoPreview').style.display = 'block';
                    document.getElementById('profilePhotoPlaceholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Load conversations
        async function loadConversations() {
            const conversationsList = document.getElementById('conversationsList');
            conversationsList.innerHTML = '<div class="spinner"></div>';
            
            try {
                // Get conversations where current user is a participant
                const conversationsSnapshot = await db.collection('conversations')
                    .where('participants', 'array-contains', currentUser.uid)
                    .orderBy('lastUpdated', 'desc')
                    .get();
                
                conversationsList.innerHTML = '';
                
                if (conversationsSnapshot.empty) {
                    conversationsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <h3>No conversations yet</h3>
                            <p>Start a conversation with someone from the Browse page</p>
                        </div>
                    `;
                    return;
                }
                
                // Get user data for each conversation
                const conversationPromises = conversationsSnapshot.docs.map(async doc => {
                    const conversation = doc.data();
                    const otherUserId = conversation.participants.find(uid => uid !== currentUser.uid);
                    
                    if (!otherUserId) return null;
                    
                    const userDoc = await db.collection('users').doc(otherUserId).get();
                    if (!userDoc.exists) return null;
                    
                    const user = userDoc.data();
                    
                    const conversationElement = document.createElement('div');
                    conversationElement.className = 'conversation';
                    conversationElement.dataset.conversationId = doc.id;
                    conversationElement.dataset.otherUserId = otherUserId;
                    
                    const lastUpdated = conversation.lastUpdated ? conversation.lastUpdated.toDate() : new Date();
                    const timeAgo = getTimeAgo(lastUpdated);
                    
                    conversationElement.innerHTML = `
                        <div class="conversation-img">
                            ${user.photoURL ? 
                                `<img src="${user.photoURL}" alt="${user.fullName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 
                                `<i class="fas fa-user"></i>`
                            }
                            <div class="conversation-online" style="display: ${user.isOnline ? 'block' : 'none'}"></div>
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-name">${user.fullName}</div>
                            <div class="conversation-preview">${conversation.lastMessage || 'No messages yet'}</div>
                        </div>
                        <div class="conversation-time">${timeAgo}</div>
                    `;
                    
                    conversationElement.addEventListener('click', function() {
                        loadConversation(doc.id, otherUserId);
                    });
                    
                    conversationsList.appendChild(conversationElement);
                    return conversationElement;
                });
                
                await Promise.all(conversationPromises);
            } catch (error) {
                console.error('Error loading conversations:', error);
                conversationsList.innerHTML = '<p style="text-align: center; padding: 1rem; color: var(--error-color);">Error loading conversations.</p>';
            }
        }
        
        // Load a specific conversation
        async function loadConversation(conversationId, otherUserId) {
            const chatHeader = document.getElementById('chatHeader');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            
            // Clean up previous listener if exists
            if (unsubscribeChat) {
                unsubscribeChat();
            }
            
            chatMessages.innerHTML = '<div class="spinner"></div>';
            chatInput.style.display = 'none';
            
            try {
                // Get other user's data
                const otherUserDoc = await db.collection('users').doc(otherUserId).get();
                if (!otherUserDoc.exists) {
                    chatMessages.innerHTML = '<p style="text-align: center; padding: 2rem;">User not found.</p>';
                    return;
                }
                
                const otherUser = otherUserDoc.data();
                chatHeader.innerHTML = `
                    <div class="chat-user-info">
                        <span>${otherUser.fullName}</span>
                        <span class="chat-user-status">${otherUser.isOnline ? 'Online' : 'Offline'}</span>
                    </div>
                `;
                
                // Set up real-time listener for messages
                unsubscribeChat = db.collection('conversations')
                    .doc(conversationId)
                    .collection('messages')
                    .orderBy('timestamp', 'asc')
                    .onSnapshot((snapshot) => {
                        chatMessages.innerHTML = '';
                        
                        if (snapshot.empty) {
                            chatMessages.innerHTML = '<p style="text-align: center; padding: 2rem;">No messages yet. Start a conversation!</p>';
                        } else {
                            snapshot.forEach(doc => {
                                const message = doc.data();
                                const messageElement = document.createElement('div');
                                messageElement.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
                                
                                const time = message.timestamp ? message.timestamp.toDate() : new Date();
                                const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                                
                                messageElement.innerHTML = `
                                    <p>${message.text}</p>
                                    <div class="message-time">${timeString}</div>
                                `;
                                
                                chatMessages.appendChild(messageElement);
                            });
                            
                            // Scroll to bottom
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                        
                        // Show chat input
                        chatInput.style.display = 'flex';
                    });
                
                // Show chat input and set up event listener
                chatInput.dataset.conversationId = conversationId;
                chatInput.dataset.otherUserId = otherUserId;
                
            } catch (error) {
                console.error('Error loading conversation:', error);
                chatMessages.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--error-color);">Error loading conversation.</p>';
            }
        }
        
        // Start a new conversation
        async function startConversation(otherUserId) {
            try {
                // Check if conversation already exists
                const existingConversation = await db.collection('conversations')
                    .where('participants', 'array-contains', currentUser.uid)
                    .get();
                
                let conversationId = null;
                
                existingConversation.forEach(doc => {
                    const conversation = doc.data();
                    if (conversation.participants.includes(otherUserId)) {
                        conversationId = doc.id;
                    }
                });
                
                // Create new conversation if it doesn't exist
                if (!conversationId) {
                    const newConversation = {
                        participants: [currentUser.uid, otherUserId],
                        lastMessage: '',
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const conversationRef = await db.collection('conversations').add(newConversation);
                    conversationId = conversationRef.id;
                }
                
                // Switch to messages section and load the conversation
                showSection('messages');
                updateActiveNav(document.querySelector('[data-section="messages"]'));
                loadConversation(conversationId, otherUserId);
                
            } catch (error) {
                console.error('Error starting conversation:', error);
                showNotification('Error starting conversation', 'error');
            }
        }
        
        // Send message
        document.getElementById('sendMessageBtn').addEventListener('click', async function() {
            const chatInput = document.getElementById('chatInput');
            const messageInput = document.getElementById('messageInput');
            const conversationId = chatInput.dataset.conversationId;
            const otherUserId = chatInput.dataset.otherUserId;
            const messageText = messageInput.value.trim();
            
            if (!messageText || !conversationId) return;
            
            try {
                // Add message to conversation
                const messageData = {
                    text: messageText,
                    senderId: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('conversations')
                    .doc(conversationId)
                    .collection('messages')
                    .add(messageData);
                
                // Update conversation last message and timestamp
                await db.collection('conversations')
                    .doc(conversationId)
                    .update({
                        lastMessage: messageText,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
// Update conversation last message and timestamp
await db.collection('conversations')
    .doc(conversationId)
    .update({
        lastMessage: messageText,
        lastMessageSender: currentUser.uid, // ← ADD THIS LINE
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    });
                    
                
                // Clear input
                messageInput.value = '';
                
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Error sending message', 'error');
            }
        });
        
        // Allow sending message with Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('sendMessageBtn').click();
            }
        });
        
       // Filter functionality - ONLY department and year 
       
// Filter functionality - ONLY department and year

document.getElementById('applyFilters').addEventListener('click', function() {
       
       

    // Get only department and year filter values
    activeFilters = {
        department: document.getElementById('filterDepartment').value,
        year: document.getElementById('filterYear').value
        // Remove all other filters
    };
    
    // Update filter tags
    updateFilterTags();
    
    // Load students with filters
    loadStudents();
});
       
       
        
        // Clear filters
        document.getElementById('clearFilters').addEventListener('click', function() {
            // Reset filter inputs
            document.getElementById('filterDepartment').value = '';
            document.getElementById('filterYear').value = '';
            document.getElementById('filterGender').value = '';
            document.getElementById('filterReligion').value = '';
            document.getElementById('filterPersonality').value = '';
            document.getElementById('filterLookingFor').value = '';
            document.getElementById('filterInterests').value = '';
            document.getElementById('filterMaritalStatus').value = '';
            
            // Clear active filters
            activeFilters = {};
            
            // Update filter tags
            updateFilterTags();
            
            // Load all students
            loadStudents();
        });
        
        // Toggle filter visibility on mobile
        document.getElementById('filterToggle').addEventListener('click', function() {
            document.getElementById('filterContent').classList.toggle('show');
        });
        
        // Update filter tags display
        function updateFilterTags() {
            const filterTags = document.getElementById('filterTags');
            filterTags.innerHTML = '';
            
            let hasActiveFilters = false;
            
            for (const [key, value] of Object.entries(activeFilters)) {
                if (value) {
                    hasActiveFilters = true;
                    const tag = document.createElement('div');
                    tag.className = 'filter-tag';
                    tag.innerHTML = `
                        ${key}: ${value}
                        <button type="button" onclick="removeFilter('${key}')">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    filterTags.appendChild(tag);
                }
            }
            
            filterTags.style.display = hasActiveFilters ? 'flex' : 'none';
        }
        
        // Remove individual filter
        function removeFilter(key) {
            activeFilters[key] = '';
            document.getElementById(`filter${key.charAt(0).toUpperCase() + key.slice(1)}`).value = '';
            updateFilterTags();
            loadStudents();
        }
        
        // Get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return 'Just now';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes}m ago`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours}h ago`;
            } else {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days}d ago`;
            }
        }
        
        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            
            try {
                // Clean up any listeners
                if (unsubscribeChat) {
                    unsubscribeChat();
                    unsubscribeChat = null;
                }
                
                await auth.signOut();
                currentUser = null;
                userProfile = null;
                
                // Show unauthenticated navigation
                updateNavigation(false);
                
                // Show home section
                showSection('home');
                updateActiveNav(document.querySelector('[data-section="home"]'));
                
                showNotification('Logged out successfully', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Error logging out', 'error');
            }
        });
        
        // Update navigation based on authentication status
        function updateNavigation(isAuthenticated) {
            if (isAuthenticated) {
                document.getElementById('loginNav').style.display = 'none';
                document.getElementById('signupNav').style.display = 'none';
                document.getElementById('dashboardNav').style.display = 'list-item';
                document.getElementById('browseNav').style.display = 'list-item';
                document.getElementById('messagesNav').style.display = 'list-item';
                document.getElementById('profileNav').style.display = 'list-item';
            } else {
                document.getElementById('loginNav').style.display = 'list-item';
                document.getElementById('signupNav').style.display = 'list-item';
                document.getElementById('dashboardNav').style.display = 'none';
                document.getElementById('browseNav').style.display = 'none';
                document.getElementById('messagesNav').style.display = 'none';
                document.getElementById('profileNav').style.display = 'none';
            }
        }
        
        // Dashboard card navigation
        document.querySelectorAll('.dashboard-cards .card').forEach(card => {
            card.addEventListener('click', function() {
                const sectionId = this.getAttribute('data-section');
                if (sectionId === 'home' && this.id === 'logoutBtn') return; // Handled separately
                
                showSection(sectionId);
                updateActiveNav(document.querySelector(`[data-section="${sectionId}"]`));
            });
        });
        
        // Firebase auth state observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                
                try {
                    // Get user profile
                    
                    
// Load user profile using the new function
userProfile = await loadUserProfile(user.uid);

if (userProfile) {
    // Update user online status
    await db.collection('users').doc(user.uid).update({
        isOnline: true,
        lastSeen: new Date()
    });
    
    updateNavigation(true);
    
    // If on auth pages, redirect to dashboard
    if (document.getElementById('login').classList.contains('active') ||
        document.getElementById('signup').classList.contains('active')) {
        showSection('dashboard');
        updateActiveNav(document.querySelector('[data-section="dashboard"]'));
    }
} else {
    // User document doesn't exist, sign out
    await auth.signOut();
    currentUser = null;
    showNotification('User profile not found. Please sign up.', 'error');
}
                    
                    
                    
                } catch (error) {
                    console.error('Error getting user profile:', error);
                    await auth.signOut();
                    currentUser = null;
                }
            } else {
                // User is signed out
                if (currentUser) {
                    // Update user offline status
                    try {
                        await db.collection('users').doc(currentUser.uid).update({
                            isOnline: false,
                            lastSeen: new Date()
                        });
                    } catch (error) {
                        console.error('Error updating offline status:', error);
                    }
                }
                
                currentUser = null;
                userProfile = null;
                updateNavigation(false);
                
                // If on protected page, redirect to home
                if (document.getElementById('dashboard').classList.contains('active') || 
                    document.getElementById('browse').classList.contains('active') ||
                    document.getElementById('messages').classList.contains('active') ||
                    document.getElementById('profile').classList.contains('active')) {
                    showSection('home');
                    updateActiveNav(document.querySelector('[data-section="home"]'));
                }
            }
        });
        
        // Update user online status when window gains focus
        window.addEventListener('focus', async () => {
            if (currentUser) {
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        isOnline: true,
                        lastSeen: new Date()
                    });
                } catch (error) {
                    console.error('Error updating online status:', error);
                }
            }
        });
        
        // Update user offline status when window loses focus
        window.addEventListener('blur', async () => {
            if (currentUser) {
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        isOnline: false,
                        lastSeen: new Date()
                    });
                } catch (error) {
                    console.error('Error updating offline status:', error);
                }
            }
        });
        
        // Handle page visibility change
        document.addEventListener('visibilitychange', async () => {
            if (currentUser) {
                if (document.visibilityState === 'visible') {
                    try {
                        await db.collection('users').doc(currentUser.uid).update({
                            isOnline: true,
                            lastSeen: new Date()
                        });
                    } catch (error) {
                        console.error('Error updating online status:', error);
                    }
                } else {
                    try {
                        await db.collection('users').doc(currentUser.uid).update({
                            isOnline: false,
                            lastSeen: new Date()
                        });
                    } catch (error) {
                        console.error('Error updating offline status:', error);
                    }
                }
            }
        });
        
        
        
        
// ===== MESSAGE NOTIFICATION SYSTEM =====

// Show message notification
function showMessageNotification(senderName, messageText) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'notification success show';
    notification.innerHTML = `
        <div style="display: flex; align-items: center;">
            <i class="fas fa-envelope" style="margin-right: 10px;"></i>
            <div>
                <strong>New message from ${senderName}</strong>
                <p>${messageText.length > 50 ? messageText.substring(0, 50) + '...' : messageText}</p>
            </div>
        </div>
    `;
    
    // Add click to open messages
    notification.style.cursor = 'pointer';
    notification.addEventListener('click', function() {
        showSection('messages');
        updateActiveNav(document.querySelector('[data-section="messages"]'));
    });
    
    // Add to notification container
    const container = document.getElementById('notification');
    container.parentNode.insertBefore(notification, container.nextSibling);
    
    // Remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Listen for new messages in real-time
function setupMessageListeners() {
if (!currentUser) return;

console.log('Setting up message listeners for user:', currentUser.uid);

// Listen to all conversations where user is participant
db.collection('conversations')
.where('participants', 'array-contains', currentUser.uid)
.onSnapshot((snapshot) => {
console.log('Conversation update detected');
snapshot.docChanges().forEach((change) => {
console.log('Change type:', change.type);
if (change.type === 'modified') {
const conversation = change.doc.data();
console.log('Modified conversation:', conversation);

// Check if this is a new message (not from current user)
if (conversation.lastUpdated &&
conversation.lastMessage &&
conversation.lastMessageSender !== currentUser.uid) {

console.log('New message from someone else detected');
// Get sender info
db.collection('users').doc(conversation.lastMessageSender).get()
.then((senderDoc) => {
if (senderDoc.exists) {
const sender = senderDoc.data();
console.log('Showing notification from:', sender.fullName);
showMessageNotification(sender.fullName, conversation.lastMessage);
}
});
}
}
});
});
}


// Call this function when user logs in - FIND the auth state observer and ADD this line:
// setupMessageListeners();

// Also update the send message function to include sender ID - FIND this code:
// await db.collection('conversations').doc(conversationId).update({
//     lastMessage: messageText,
//     lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
// });

// AND ADD this line to make it:
// await db.collection('conversations').doc(conversationId).update({
//     lastMessage: messageText,
//     lastMessageSender: currentUser.uid, // ADD THIS LINE
//     lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
// });
        
        
        
        
        
        // ===== FIX FOR PROFILE LOADING ISSUE =====
// Override the loadUserProfile function to be more reliable
const originalLoadUserProfile = loadUserProfile;
loadUserProfile = async function(uid) {
    try {
        console.log('Loading profile for:', uid);
        const userDoc = await db.collection('users').doc(uid).get();
        
        if (userDoc.exists) {
            console.log('Profile found:', userDoc.data());
            return userDoc.data();
        }
        
        // If not found, wait and try again
        console.log('Profile not found, retrying in 2 seconds...');
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        const userDocRetry = await db.collection('users').doc(uid).get();
        if (userDocRetry.exists) {
            console.log('Profile found on retry:', userDocRetry.data());
            return userDocRetry.data();
        }
        
        console.log('Profile still not found after retry');
        return null;
    } catch (error) {
        console.error('Error in loadUserProfile:', error);
        return null;
    }
};

// Fix dashboard loading to handle missing profile data
const originalLoadDashboard = loadDashboard;
loadDashboard = async function() {
    if (!currentUser) return;
    
    try {
        // Always get fresh profile data
        userProfile = await loadUserProfile(currentUser.uid);
        
        if (userProfile) {
            document.getElementById('dashboardWelcome').textContent = `Welcome, ${userProfile.fullName || 'Student'}!`;
            document.getElementById('dashboardDetails').textContent = `${userProfile.department || 'Department'}, ${userProfile.year || 'Year'}`;
            document.getElementById('dashboardBio').textContent = `"${userProfile.bio || 'No bio yet.'}"`;

            // Load profile image if available
            if (userProfile.photoURL) {
                document.getElementById('dashboardProfileImg').src = userProfile.photoURL;
                document.getElementById('dashboardProfileImg').style.display = 'block';
                document.getElementById('dashboardProfilePlaceholder').style.display = 'none';
            } else {
                document.getElementById('dashboardProfileImg').style.display = 'none';
                document.getElementById('dashboardProfilePlaceholder').style.display = 'flex';
            }
        } else {
            // Show friendly message if profile not loaded
            document.getElementById('dashboardWelcome').textContent = 'Welcome!';
            document.getElementById('dashboardDetails').textContent = 'Please complete your profile';
            document.getElementById('dashboardBio').textContent = '"Your profile is being processed"';
        }
    } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('dashboardWelcome').textContent = 'Welcome!';
        document.getElementById('dashboardDetails').textContent = 'Error loading profile';
        document.getElementById('dashboardBio').textContent = '"Please try refreshing"';
    }
};

// Add a delay after signup to ensure profile is saved
auth.onAuthStateChanged(async (user) => {
    if (user) {
        // User just signed up - wait a bit then reload profile
        setTimeout(async () => {
            userProfile = await loadUserProfile(user.uid);
            if (userProfile && typeof loadDashboard === 'function') {
                loadDashboard();
            }
        }, 2000);
    }
});
        
        
        
        
        
// Simple fix for profile loading
setTimeout(() => {
    if (currentUser && (!userProfile || !userProfile.fullName)) {
        console.log('Attempting to reload profile data...');
        loadUserProfile(currentUser.uid).then(profile => {
            if (profile) {
                userProfile = profile;
                if (typeof loadDashboard === 'function') loadDashboard();
                if (typeof loadProfile === 'function') loadProfile();
            }
        });
    }
}, 3000);
        
        
        
        
        
        
        
        
        
    // ===== PROFILE VIEWING FOR ALL USERS =====
    
    // View another user's profile
    async function viewProfile(userId) {
        try {
            // Get the user's profile data
            const userDoc = await db.collection('users').doc(userId).get();
            
            if (!userDoc.exists) {
                showNotification('Profile not found', 'error');
                return;
            }
            
            const profile = userDoc.data();
            
            // Create profile view modal
            const modalHtml = `
                <div class="modal" id="profileModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="modal-content" style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="text-align: center; margin-bottom: 1.5rem;">
                            <h2 style="color: var(--primary-color); margin-bottom: 1rem;">${profile.fullName}'s Profile</h2>
                            <button onclick="closeProfileModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 2rem;">
                            ${profile.photoURL ? 
                                `<img src="${profile.photoURL}" alt="${profile.fullName}" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color);">` : 
                                `<div style="width: 150px; height: 150px; border-radius: 50%; background: var(--accent-color); display: flex; align-items: center; justify-content: center; margin: 0 auto; border: 3px solid var(--primary-color);">
                                    <i class="fas fa-user" style="font-size: 3rem; color: var(--primary-color);"></i>
                                </div>`
                            }
                        </div>
                        
                        <div class="profile-info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="profile-info-item">
                                <div class="profile-info-label">Student ID</div>
                                <div>${profile.studentId || 'Not provided'}</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Department</div>
                                <div>${profile.department || 'Not provided'}</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Year</div>
                                <div>${profile.year || 'Not provided'}</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Gender</div>
                                <div>${profile.gender || 'Not provided'}</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Looking For</div>
                                <div>${profile.lookingFor || 'Not provided'}</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Marital Status</div>
                                <div>${profile.maritalStatus || 'Not provided'}</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Relationship Experience</div>
                                <div>${profile.relationshipExp || 'Not provided'}</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Religion</div>
                                <div>${profile.religion || 'Not provided'}</div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">Personality</div>
                                <div>${profile.personality || 'Not provided'}</div>
                            </div>
                        </div>
                        
                        ${profile.interests && profile.interests.length > 0 ? `
                            <div style="margin-bottom: 1.5rem;">
                                <div class="profile-info-label">Interests</div>
                                <div class="student-interests" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                    ${profile.interests.map(interest => `
                                        <span class="interest-tag">${interest}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${profile.bio ? `
                            <div style="margin-bottom: 1.5rem;">
                                <div class="profile-info-label">About Me</div>
                                <div>${profile.bio}</div>
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button class="btn" onclick="startConversation('${userId}')">Send Message</button>
                            <button class="btn btn-outline" onclick="closeProfileModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
        } catch (error) {
            console.error('Error viewing profile:', error);
            showNotification('Error loading profile', 'error');
        }
    }

    // Close profile modal
    function closeProfileModal() {
        const modal = document.getElementById('profileModal');
        if (modal) {
            modal.remove();
        }
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('profileModal');
        if (modal && event.target === modal) {
            closeProfileModal();
        }
    });

    // Modify the student cards to include View Profile buttons
    function addViewProfileButtons() {
        const studentCards = document.querySelectorAll('.student-card');
        studentCards.forEach(card => {
            // Check if this card already has a View Profile button
            if (!card.querySelector('.view-profile-btn')) {
                const buttonsContainer = card.querySelector('.student-info');
                if (buttonsContainer) {
                    // Find the message button and extract user ID
                    const messageBtn = buttonsContainer.querySelector('button');
                    if (messageBtn && messageBtn.onclick) {
                        const onclickString = messageBtn.onclick.toString();
                        const userIdMatch = onclickString.match(/'([^']+)'/);
                        
                        if (userIdMatch && userIdMatch[1]) {
                            const userId = userIdMatch[1];
                            
                            // Create View Profile button
                            const viewProfileBtn = document.createElement('button');
                            viewProfileBtn.className = 'btn btn-outline view-profile-btn';
                            viewProfileBtn.textContent = 'View Profile';
                            viewProfileBtn.style.marginTop = '10px';
                            viewProfileBtn.style.width = '100%';
                            viewProfileBtn.onclick = () => viewProfile(userId);
                            
                            // Add it to the card
                            buttonsContainer.appendChild(viewProfileBtn);
                        }
                    }
                }
            }
        });
    }

    // Add View Profile buttons when page loads and when students are loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Add buttons initially
        setTimeout(addViewProfileButtons, 1000);
        
        // Also add buttons when students are loaded (for browse page)
        const originalLoadStudents = loadStudents;
        loadStudents = async function() {
            await originalLoadStudents();
            setTimeout(addViewProfileButtons, 500);
        };
    });

    // CSS for modal (add only if not already exists)
    if (!document.querySelector('style#profile-modal-styles')) {
        const style = document.createElement('style');
        style.id = 'profile-modal-styles';
        style.textContent = `
            .modal {
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                z-index: 1000;
                align-items: center;
                justify-content: center;
            }
            
            .modal-content {
                background-color: white;
                padding: 2rem;
                border-radius: 8px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            }
            
            .profile-info-label {
                font-weight: bold;
                color: var(--primary-color);
                margin-bottom: 0.25rem;
            }
            
            .view-profile-btn {
                background-color: var(--primary-light);
                color: white;
            }
            
            .view-profile-btn:hover {
                background-color: var(--primary-color);
            }
        `;
        document.head.appendChild(style);
    }

        
        
        
        
        
        
        
        
        
        
        
        


        
        
        
        
        
    // ===== VOICE MESSAGE FEATURE =====
    
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let audioPlayer = null;
    
    // Initialize voice message feature
    function initVoiceMessage() {
        // Add voice message button to chat interface
        const chatInput = document.getElementById('chatInput');
        if (chatInput && !chatInput.querySelector('.voice-message-btn')) {
            const voiceButton = document.createElement('button');
            voiceButton.className = 'voice-message-btn';
            voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceButton.style.background = 'var(--primary-color)';
            voiceButton.style.color = 'white';
            voiceButton.style.border = 'none';
            voiceButton.style.borderRadius = 'var(--border-radius)';
            voiceButton.style.padding = '0.75rem';
            voiceButton.style.cursor = 'pointer';
            voiceButton.style.marginRight = '10px';
            voiceButton.title = 'Record Voice Message';
            
            voiceButton.addEventListener('click', toggleRecording);
            
            // Insert before the send button
            chatInput.insertBefore(voiceButton, chatInput.querySelector('button'));
            
            // Create audio player element
            audioPlayer = document.createElement('audio');
            audioPlayer.controls = true;
            audioPlayer.style.width = '100%';
            audioPlayer.style.marginTop = '10px';
            audioPlayer.style.display = 'none';
            chatInput.parentNode.insertBefore(audioPlayer, chatInput.nextSibling);
            
            // Create recording indicator
            const recordingIndicator = document.createElement('div');
            recordingIndicator.className = 'recording-indicator';
            recordingIndicator.innerHTML = '<i class="fas fa-circle" style="color: var(--error-color); animation: pulse 1s infinite;"></i> Recording...';
            recordingIndicator.style.display = 'none';
            recordingIndicator.style.alignItems = 'center';
            recordingIndicator.style.gap = '10px';
            recordingIndicator.style.padding = '10px';
            recordingIndicator.style.background = 'rgba(244, 67, 54, 0.1)';
            recordingIndicator.style.borderRadius = 'var(--border-radius)';
            recordingIndicator.style.marginTop = '10px';
            chatInput.parentNode.insertBefore(recordingIndicator, chatInput.nextSibling);
        }
    }
    
    // Toggle recording
    async function toggleRecording() {
        if (isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    }
    
    // Start recording
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioChunks = [];
            
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // Show audio player
                audioPlayer.src = audioUrl;
                audioPlayer.style.display = 'block';
                
                // Create send button for voice message
                const sendVoiceButton = document.createElement('button');
                sendVoiceButton.className = 'btn';
                sendVoiceButton.innerHTML = '<i class="fas fa-paper-plane"></i> Send Voice Message';
                sendVoiceButton.style.marginTop = '10px';
                sendVoiceButton.style.width = '100%';
                sendVoiceButton.onclick = () => sendVoiceMessage(audioBlob);
                
                audioPlayer.parentNode.insertBefore(sendVoiceButton, audioPlayer.nextSibling);
                
                // Stop all tracks
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            isRecording = true;
            
            // Update UI
            const voiceButton = document.querySelector('.voice-message-btn');
            voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
            voiceButton.style.background = 'var(--error-color)';
            
            // Show recording indicator
            document.querySelector('.recording-indicator').style.display = 'flex';
            
        } catch (error) {
            console.error('Error starting recording:', error);
            showNotification('Microphone access denied', 'error');
        }
    }
    
    // Stop recording
    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            
            // Update UI
            const voiceButton = document.querySelector('.voice-message-btn');
            voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceButton.style.background = 'var(--primary-color)';
            
            // Hide recording indicator
            document.querySelector('.recording-indicator').style.display = 'none';
        }
    }
    
    // Send voice message
    async function sendVoiceMessage(audioBlob) {
        const chatInput = document.getElementById('chatInput');
        const conversationId = chatInput.dataset.conversationId;
        const otherUserId = chatInput.dataset.otherUserId;
        
        if (!conversationId) {
            showNotification('Please select a conversation first', 'error');
            return;
        }
        
        try {
            // Show loading
            toggleButtonLoading('sendVoice', true);
            
            // Upload audio to Firebase Storage
            const storageRef = storage.ref();
            const audioRef = storageRef.child(`voice_messages/${conversationId}/${Date.now()}.webm`);
            
            // Upload the file
            const snapshot = await audioRef.put(audioBlob);
            const audioUrl = await snapshot.ref.getDownloadURL();
            
            // Get audio duration (approximate)
            const audio = new Audio();
            audio.src = URL.createObjectURL(audioBlob);
            
            audio.onloadedmetadata = async () => {
                const duration = Math.round(audio.duration);
                
                // Add message to conversation
                const messageData = {
                    type: 'voice',
                    audioUrl: audioUrl,
                    duration: duration,
                    senderId: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('conversations')
                    .doc(conversationId)
                    .collection('messages')
                    .add(messageData);
                
                // Update conversation last message and timestamp
                await db.collection('conversations')
                    .doc(conversationId)
                    .update({
                        lastMessage: '🎤 Voice message',
                        lastMessageSender: currentUser.uid,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                // Increment unread count for the recipient
                await db.collection('conversations')
                    .doc(conversationId)
                    .update({
                        [`unreadCount.${otherUserId}`]: firebase.firestore.FieldValue.increment(1)
                    });
                
                // Clear audio player
                audioPlayer.style.display = 'none';
                audioPlayer.src = '';
                
                // Remove send button
                const sendButton = document.querySelector('button[onclick="sendVoiceMessage(audioBlob)"]');
                if (sendButton) sendButton.remove();
                
                showNotification('Voice message sent!', 'success');
                toggleButtonLoading('sendVoice', false);
            };
            
        } catch (error) {
            console.error('Error sending voice message:', error);
            showNotification('Error sending voice message', 'error');
            toggleButtonLoading('sendVoice', false);
        }
    }
    
    // Render voice messages in chat
    function renderVoiceMessage(message, messageElement) {
        messageElement.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                <i class="fas fa-microphone" style="color: var(--primary-color);"></i>
                <span>Voice message</span>
                <span style="font-size: 0.8rem; color: #666;">${message.duration}s</span>
            </div>
            <audio controls style="width: 100%; max-width: 300px;">
                <source src="${message.audioUrl}" type="audio/webm">
                Your browser does not support audio playback.
            </audio>
            <div class="message-time">${new Date(message.timestamp?.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
        `;
    }
    
    // Modify chat message rendering to handle voice messages
    function patchChatRendering() {
        const originalChatListener = unsubscribeChat;
        
        unsubscribeChat = db.collection('conversations')
            .doc(chatInput.dataset.conversationId)
            .collection('messages')
            .orderBy('timestamp', 'asc')
            .onSnapshot((snapshot) => {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                
                if (snapshot.empty) {
                    chatMessages.innerHTML = '<p style="text-align: center; padding: 2rem;">No messages yet. Start a conversation!</p>';
                } else {
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
                        
                        if (message.type === 'voice') {
                            renderVoiceMessage(message, messageElement);
                        } else {
                            // Regular text message
                            const timeString = message.timestamp ? message.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Just now';
                            messageElement.innerHTML = `
                                <p>${message.text}</p>
                                <div class="message-time">${timeString}</div>
                            `;
                        }
                        
                        chatMessages.appendChild(messageElement);
                    });
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
                // Show chat input
                chatInput.style.display = 'flex';
            });
    }
    
    // Initialize when messages section is loaded
    const originalLoadConversation = loadConversation;
    loadConversation = async function(conversationId, otherUserId) {
        await originalLoadConversation(conversationId, otherUserId);
        
        // Wait a bit for the chat interface to render
        setTimeout(() => {
            initVoiceMessage();
            patchChatRendering();
        }, 100);
    };
    
    // CSS for voice message feature
    if (!document.querySelector('style#voice-message-styles')) {
        const style = document.createElement('style');
        style.id = 'voice-message-styles';
        style.textContent = `
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
            
            .voice-message-btn {
                transition: all 0.3s ease;
            }
            
            .voice-message-btn:hover {
                transform: scale(1.1);
            }
            
            .voice-message-btn.recording {
                background-color: var(--error-color) !important;
                animation: pulse 1s infinite;
            }
            
            .voice-message-container {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-top: 10px;
            }
            
            .voice-visualizer {
                display: flex;
                align-items: end;
                gap: 2px;
                height: 30px;
            }
            
            .voice-bar {
                width: 3px;
                background-color: var(--primary-color);
                border-radius: 2px;
                transition: height 0.1s ease;
            }
            
            /* Responsive design for voice messages */
            @media (max-width: 768px) {
                .voice-message-btn {
                    padding: 0.5rem !important;
                    margin-right: 5px !important;
                }
                
                audio {
                    max-width: 250px !important;
                }
            }
        `;
        document.head.appendChild(style);
    }

    // Add visualizer animation for recording
    function addVisualizer() {
        const visualizer = document.createElement('div');
        visualizer.className = 'voice-visualizer';
        visualizer.style.display = 'none';
        
        // Create 20 bars for visualizer
        for (let i = 0; i < 20; i++) {
            const bar = document.createElement('div');
            bar.className = 'voice-bar';
            bar.style.height = Math.random() * 20 + 5 + 'px';
            visualizer.appendChild(bar);
        }
        
        document.querySelector('.recording-indicator').appendChild(visualizer);
        
        // Animate bars
        if (window.visualizerInterval) clearInterval(window.visualizerInterval);
        window.visualizerInterval = setInterval(() => {
            if (isRecording) {
                visualizer.querySelectorAll('.voice-bar').forEach(bar => {
                    bar.style.height = Math.random() * 20 + 5 + 'px';
                });
            }
        }, 100);
    }

    // Initialize when page loads
    setTimeout(() => {
        if (document.getElementById('messages').classList.contains('active')) {
            initVoiceMessage();
        }
    }, 1000);

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
// ===== FIXED MENU FUNCTIONALITY =====
function setupMenu() {
    // Navigation functionality
    const navLinks = document.querySelectorAll('.nav-link');
    const menuToggle = document.getElementById('menuToggle');
    const navMenu = document.getElementById('navMenu');
    
    // Remove any existing listeners first
    const newNavLinks = [];
    navLinks.forEach(link => {
        const newLink = link.cloneNode(true);
        link.parentNode.replaceChild(newLink, link);
        newNavLinks.push(newLink);
    });
    
    const newMenuToggle = menuToggle.cloneNode(true);
    menuToggle.parentNode.replaceChild(newMenuToggle, menuToggle);
    
    // Handle navigation clicks
    newNavLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const sectionId = this.getAttribute('data-section');
            showSection(sectionId);
            updateActiveNav(this);
            
            // Close mobile menu after selection
            if (window.innerWidth <= 768) {
                navMenu.classList.remove('show');
            }
        });
    });
    
    // Mobile menu toggle
    newMenuToggle.addEventListener('click', function() {
        navMenu.classList.toggle('show');
    });
    
    // Close menu when clicking outside on mobile
    document.addEventListener('click', function(e) {
        if (window.innerWidth <= 768 &&
            navMenu.classList.contains('show') &&
            !e.target.closest('#navMenu') &&
            !e.target.closest('#menuToggle')) {
            navMenu.classList.remove('show');
        }
    });
}

// Update active navigation link
function updateActiveNav(activeLink) {
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.classList.remove('active');
    });
    activeLink.classList.add('active');
}

// Initialize menu when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    setupMenu();
});

// Re-setup menu when navigating to a new section
const originalShowSection = showSection;
showSection = function(sectionId) {
    originalShowSection(sectionId);
    setTimeout(setupMenu, 100);
};
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        // ===== MESSAGE REQUEST NOTIFICATION SYSTEM =====
let messageRequestListener = null;

// Function to show message request notification
function showMessageRequestNotification(senderId, messageText) {
    // Get sender info
    db.collection('users').doc(senderId).get().then(senderDoc => {
        if (senderDoc.exists) {
            const sender = senderDoc.data();
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification message-request show';
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; flex-shrink: 0;">
                        ${sender.photoURL ? 
                            `<img src="${sender.photoURL}" alt="${sender.fullName}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                            `<div style="width: 100%; height: 100%; background: var(--accent-color); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-user" style="color: var(--primary-color);"></i>
                            </div>`
                        }
                    </div>
                    <div>
                        <strong>New message from ${sender.fullName}</strong>
                        <p>${messageText.length > 50 ? messageText.substring(0, 50) + '...' : messageText}</p>
                    </div>
                    <button class="view-message-btn" style="margin-left: auto; background: var(--primary-color); color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">
                        View
                    </button>
                </div>
            `;
            
            // Add click to open messages
            notification.addEventListener('click', function(e) {
                if (!e.target.classList.contains('view-message-btn')) {
                    showSection('messages');
                    updateActiveNav(document.querySelector('[data-section="messages"]'));
                    // Find and open this conversation
                    findAndOpenConversation(senderId);
                }
            });
            
            // Specific handler for the view button
            const viewBtn = notification.querySelector('.view-message-btn');
            viewBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                showSection('messages');
                updateActiveNav(document.querySelector('[data-section="messages"]'));
                findAndOpenConversation(senderId);
            });
            
            // Add to notification container
            const container = document.getElementById('notification');
            container.parentNode.insertBefore(notification, container.nextSibling);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 10000);
        }
    });
}

// Find and open a specific conversation
async function findAndOpenConversation(otherUserId) {
    try {
        // Check if conversation already exists
        const conversationsSnapshot = await db.collection('conversations')
            .where('participants', 'array-contains', currentUser.uid)
            .get();
        
        let conversationId = null;
        
        conversationsSnapshot.forEach(doc => {
            const conversation = doc.data();
            if (conversation.participants.includes(otherUserId)) {
                conversationId = doc.id;
            }
        });
        
        if (conversationId) {
            // Load the conversation
            loadConversation(conversationId, otherUserId);
        } else {
            // Create new conversation if it doesn't exist
            const newConversation = {
                participants: [currentUser.uid, otherUserId],
                lastMessage: '',
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                // Add unread tracking
                unreadCount: {
                    [currentUser.uid]: 0,
                    [otherUserId]: 0
                }
            };
            
            const conversationRef = await db.collection('conversations').add(newConversation);
            loadConversation(conversationRef.id, otherUserId);
        }
    } catch (error) {
        console.error('Error finding conversation:', error);
        showNotification('Error opening conversation', 'error');
    }
}

// Listen for new messages directed to current user
function setupMessageRequestListener() {
    if (!currentUser) return;
    
    // Remove existing listener if any
    if (messageRequestListener) {
        messageRequestListener();
    }
    
    messageRequestListener = db.collection('conversations')
        .where('participants', 'array-contains', currentUser.uid)
        .onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === 'modified') {
                    const conversation = change.doc.data();
                    
                    // Check if this is a new message (not from current user)
                    if (conversation.lastMessage && 
                        conversation.lastMessageSender !== currentUser.uid &&
                        conversation.lastUpdated) {
                        
                        // Check if this conversation is not currently open
                        const chatInput = document.getElementById('chatInput');
                        const isActiveConversation = chatInput.dataset.conversationId === change.doc.id;
                        
                        // Get unread count
                        const unreadCount = conversation.unreadCount && conversation.unreadCount[currentUser.uid] || 0;
                        
                        // Show notification if it's a new message and conversation is not active
                        if (unreadCount > 0 && !isActiveConversation) {
                            showMessageRequestNotification(conversation.lastMessageSender, conversation.lastMessage);
                        }
                    }
                }
            });
        });
}

// Update auth state observer to handle message requests
const originalAuthStateChanged = auth.onAuthStateChanged;
auth.onAuthStateChanged = async (user) => {
    await originalAuthStateChanged(user);
    
    if (user) {
        // Set up message request listener when user logs in
        setTimeout(setupMessageRequestListener, 2000);
    } else {
        // Remove listener when user logs out
        if (messageRequestListener) {
            messageRequestListener();
            messageRequestListener = null;
        }
    }
};

// Update the send message function to properly set lastMessageSender
const originalSendHandler = document.getElementById('sendMessageBtn').onclick;
document.getElementById('sendMessageBtn').onclick = async function() {
    const chatInput = document.getElementById('chatInput');
    const messageInput = document.getElementById('messageInput');
    const conversationId = chatInput.dataset.conversationId;
    const otherUserId = chatInput.dataset.otherUserId;
    const messageText = messageInput.value.trim();
    
    if (!messageText || !conversationId) return;
    
    try {
        // Add message to conversation
        const messageData = {
            text: messageText,
            senderId: currentUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('conversations')
            .doc(conversationId)
            .collection('messages')
            .add(messageData);
        
        // Update conversation last message and timestamp
        await db.collection('conversations')
            .doc(conversationId)
            .update({
                lastMessage: messageText,
                lastMessageSender: currentUser.uid,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                [`unreadCount.${otherUserId}`]: firebase.firestore.FieldValue.increment(1)
            });
        
        // Clear input
        messageInput.value = '';
        
    } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Error sending message', 'error');
    }
};

// Add CSS for message request notifications
if (!document.querySelector('style#message-request-styles')) {
    const style = document.createElement('style');
    style.id = 'message-request-styles';
    style.textContent = `
        .notification.message-request {
            background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
            color: white;
            border-left: 4px solid #ff4081;
            cursor: pointer;
            transition: all 0.3s ease;
            max-width: 400px;
        }
        
        .notification.message-request:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .view-message-btn:hover {
            background: var(--primary-dark) !important;
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification.message-request.show {
            animation: slideIn 0.3s ease;
        }
    `;
    document.head.appendChild(style);
}

// Initialize when user is logged in
if (currentUser) {
    setupMessageRequestListener();
}
        
        
        
        
        
        
        
        
        
        
        
        
        // ===== FIXED LOGOUT FUNCTIONALITY =====
function setupLogout() {
    // Find the logout button
    const logoutBtn = document.getElementById('logoutBtn');
    if (!logoutBtn) return;
    
    // Clone the button to remove any existing event listeners
    const newLogoutBtn = logoutBtn.cloneNode(true);
    logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);
    
    // Add fresh event listener
    newLogoutBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation(); // Prevent event bubbling
        
        console.log('Logout button clicked');
        
        try {
            // Clean up any listeners
            if (unsubscribeChat) {
                unsubscribeChat();
                unsubscribeChat = null;
            }
            
            if (typingListener) {
                typingListener();
                typingListener = null;
            }
            
            if (readReceiptListener) {
                readReceiptListener();
                readReceiptListener = null;
            }
            
            if (messageRequestListener) {
                messageRequestListener();
                messageRequestListener = null;
            }
            
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }
            
            // Update user offline status
            if (currentUser) {
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        isOnline: false,
                        lastSeen: new Date()
                    });
                } catch (error) {
                    console.error('Error updating offline status:', error);
                }
            }
            
            // Sign out from Firebase Auth
            await auth.signOut();
            
            // Reset user variables
            currentUser = null;
            userProfile = null;
            
            // Show unauthenticated navigation
            updateNavigation(false);
            
            // Show home section
            showSection('home');
            updateActiveNav(document.querySelector('[data-section="home"]'));
            
            showNotification('Logged out successfully', 'success');
            
        } catch (error) {
            console.error('Logout error:', error);
            showNotification('Error logging out: ' + error.message, 'error');
        }
    });
}

// Update navigation function to handle logout button visibility
function updateNavigation(isAuthenticated) {
    if (isAuthenticated) {
        document.getElementById('loginNav').style.display = 'none';
        document.getElementById('signupNav').style.display = 'none';
        document.getElementById('dashboardNav').style.display = 'list-item';
        document.getElementById('browseNav').style.display = 'list-item';
        document.getElementById('messagesNav').style.display = 'list-item';
        document.getElementById('profileNav').style.display = 'list-item';
        
        // Setup logout button
        setTimeout(setupLogout, 100);
    } else {
        document.getElementById('loginNav').style.display = 'list-item';
        document.getElementById('signupNav').style.display = 'list-item';
        document.getElementById('dashboardNav').style.display = 'none';
        document.getElementById('browseNav').style.display = 'none';
        document.getElementById('messagesNav').style.display = 'none';
        document.getElementById('profileNav').style.display = 'none';
    }
}

// Enhanced auth state change handler
function setupAuthStateHandler() {
    // Remove any existing auth state listener
    if (window.authStateChangedHandler) {
        window.authStateChangedHandler();
    }
    
    // Set up new auth state listener
    window.authStateChangedHandler = auth.onAuthStateChanged(async (user) => {
        console.log('Auth state changed:', user ? 'User logged in' : 'User logged out');
        
        if (user) {
            // User is signed in
            currentUser = user;
            
            try {
                // Get user profile
                userProfile = await loadUserProfile(user.uid);
                
                if (userProfile) {
                    // Update user online status
                    await db.collection('users').doc(user.uid).update({
                        isOnline: true,
                        lastSeen: new Date()
                    });
                    
                    updateNavigation(true);
                    
                    // If on auth pages, redirect to dashboard
                    if (document.getElementById('login').classList.contains('active') ||
                        document.getElementById('signup').classList.contains('active')) {
                        showSection('dashboard');
                        updateActiveNav(document.querySelector('[data-section="dashboard"]'));
                    }
                } else {
                    // User document doesn't exist, sign out
                    await auth.signOut();
                    currentUser = null;
                    showNotification('User profile not found. Please sign up.', 'error');
                }
            } catch (error) {
                console.error('Error in auth state change:', error);
                try {
                    await auth.signOut();
                } catch (signOutError) {
                    console.error('Error during sign out:', signOutError);
                }
                currentUser = null;
            }
        } else {
            // User is signed out
            if (currentUser) {
                // Update user offline status
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        isOnline: false,
                        lastSeen: new Date()
                    });
                } catch (error) {
                    console.error('Error updating offline status:', error);
                }
            }
            
            currentUser = null;
            userProfile = null;
            updateNavigation(false);
            
            // If on protected page, redirect to home
            if (document.getElementById('dashboard').classList.contains('active') || 
                document.getElementById('browse').classList.contains('active') ||
                document.getElementById('messages').classList.contains('active') ||
                document.getElementById('profile').classList.contains('active')) {
                showSection('home');
                updateActiveNav(document.querySelector('[data-section="home"]'));
            }
        }
    });
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    setupAuthStateHandler();
    setupLogout();
    
    // Also setup logout when navigating to dashboard
    const originalShowSection = showSection;
    showSection = function(sectionId) {
        originalShowSection(sectionId);
        
        if (sectionId === 'dashboard') {
            setTimeout(setupLogout, 100);
        }
    };
});

// Clean up function for when page is unloaded
window.addEventListener('beforeunload', async function() {
    if (currentUser) {
        try {
            await db.collection('users').doc(currentUser.uid).update({
                isOnline: false,
                lastSeen: new Date()
            });
        } catch (error) {
            console.error('Error updating offline status on page unload:', error);
        }
    }
});

// Re-setup logout when user logs in
if (currentUser) {
    setTimeout(setupLogout, 1000);
}
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </script>
</body>
</html>
